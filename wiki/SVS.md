
# Архитектура ЭВМ СВС

ЭВМ СВС была разработана в 1980 году как более быстрая версия ЦП БЭСМ-6 на интегральных схемах.
Официально она называлась Эльбрус-1К2. Она была примерно в два с половиной раза быстрее, чем БЭСМ-6.
Элементной базой была 100 серия ЭСЛ, тактовая частота 20 МГц.
ЭВМ СВС имела до 10 процессоров и до 4х процессоров ввода-вывода (унаследованных от Эльбрус-1).

## Регистры привилегированного режима

В режиме супервизора команда РЕГ позволяет обращаться к управляющим регистрам процессора.

Адрес | Регистр
----- | -------
20-27 | Запись в регистры приписки режима пользователя.
30-33 | Запись в регистры защиты.
  34  | Запись в регистр конфигурации оперативной памяти.
  35  | Гашение сигнала контроля от оперативной памяти (СКООП).
 235  | Чтение сигнала контроля от оперативной памяти (СКООП).
  36  | Запись маски главного регистра прерываний (МГРП).
 236  | Чтение маски главного регистра прерываний (МГРП).
  37  | Сброс главного регистра прерываний (ГРП).
 237  | Чтение главного регистра прерываний (ГРП).
  44  | Запись в регистр тега.
 244  | Чтение регистра тега.
 245  | Чтение номера процессора.
  46  | Запись маски регистра внешних прерываний (МРВП).
 246  | Чтение маски регистра внешних прерываний (МРВП).
  47  | Сброс регистра внешних прерываний (РВП).
 247  | Чтение регистра внешних прерываний (РВП).
  50  | Запись в регистр прерываний процессорам (ПП).
 250  | Чтение регистра прерываний процессорам (ПП).
  51  | Запись в регистр ответов процессорам (ОПП).
 251  | Чтение регистра ответов процессорам (ОПП).
  52  | Запись в регистр прерываний от процессоров (ПОП).
 252  | Чтение регистра прерываний от процессоров (ПОП).
  53  | Запись в регистр ответов от процессоров (ОПОП).
 253  | Чтение регистра ответов от процессоров (ОПОП).
  54  | Запись в регистр конфигурации процессоров (РКП).
 254  | Чтение регистра конфигурации процессоров (РКП).
  55  | Запись в регистр аварии процессоров.
 255  | Чтение регистра аварии процессоров.
  56  | Запись в регистр часов.
 256  | Чтение регистра часов.
  57  | Запись в регистр таймера.
 257  | Чтение регистра таймера.
60-67 | Запись в регистры приписки супервизора.
100-107 | Установка битов ПКЛ, ПКП и БРО.
 140  | Сброс контрольных признаков (СКП).


## 20-27 - РП, регистры приписки

Регистры приписки определяют для каждой виртуальной страницы номер физической страницы. При трансляции виртуального адреса в физический биты 15:11 задают номер виртуальной страницы. По этому номеру из регистров приписки извлекается номер физической страницы. 

Всего имеется 8 регистров приписки по 48 бит. Каждый регистр приписки состоит из четырёх 12-битных полей. 

| 48 ... 37 | 36 ... 25 | 24 ... 13 | 12 ... 1 |
| --------- | --------- | --------- | -------- |
| ФИЗ\[i+3] | ФИЗ\[i+2] | ФИЗ\[i+1] |  ФИЗ\[i] |

Поле ФИЗ\[i]: номер физической страницы для виртуальной страницы с индексом i.

## 30-33 - РЗ, регистр защиты

Регистр защиты содержит по одному биту для каждой виртуальной страницы, всего 32 бита. Если бит установлен в единицу, обращение по чтению или записи к этой странице вызывает внутреннее прерывание "Число в чужом листе".

При записи в РЗ биты 28:21 сумматора помещаются в биты РЗ\[8:1] для адреса 30, биты РЗ\[16:9] для адреса 31, биты РЗ\[24:10] для адреса 32, биты РЗ\[32:25] для адреса 33.

| 32 | 31 | ...| 3  | 2  | 1  |
| ---| -- | -- | -- | -- | -- |
| Z31| Z30| ...| Z2 | Z1 | Z0 |

Биты Z31-Z0: запрет обращения к соответствующей виртуальной странице.

## 37 - ГРП, главный регистр прерываний

ГРП показывает состояние внутренних прерываний процессора.

| 48 ... 24 | 23 | 22 | 21 | 20 | 19 18 | 17 | 16 | 15 | 14 | 13 | 12 | 11 10 | 9 ... 5 | 4  | 3 ... 1 |
| --------- | -- | -- | -- | -- | ----- | -- | -- | -- | -- | -- | -- | ----- | ------- | -- | ------- |
|     0     | DZ | OVF| CK | DP |   0   | WPW| WPR| ICK| IP | IL | BP |   0   |  P\[i]  | MCK|  B\[i]  |

Бит DZ: деление на ноль.

Бит OVF: арифметическое переполнение. Также устанавливается в случае деления на ноль.

Бит CK: контроль числа БРЗ (ошибка чётности). Также устанавливается в случае контроля числа МОЗУ, арифметического переполнения и деления на ноль. Поле B\[i] содержит номер блока памяти, вызвавшего прерывание.

Бит DP: нарушение защиты памяти "Число в чужом листе". Поле P\[i] содержит номер страницы, вызвавшей прерывание.

Бит WPW: точка останова по записи.

Бит WPR: точка останова по считыванию.

Бит ICK: попытка выполнить число как команду, "Контроль команды".

Бит IP: передача управления в отсутствующую страницу, "Команда в чужом листе".

Бит IL: попытка выполнить привилегированную команду в режиме пользователя, "Запрещенная команда".

Бит BP: совпадение адреса текущей команды с регистром M34, "Останов по КРА".

Бит P\[i]: номер страницы, вызвавшей нарушение защиты памяти (бит DP).

Бит MCK: контроль числа МОЗУ (ошибка чётности). Также устанавливается в случае арифметического переполнения и деления на ноль. Поле B\[i] содержит номер блока памяти, вызвавшего прерывание.

Бит B\[i]: номер блока памяти, вызвавшего прерывание контроля числа (биты CK или MCK).


## 47 - РВП, регистр внешних прерываний

РВП показывает состояние прерываний, поступивших в процессор от внешних устройств.

| 48 ... 10 | 9  | 8  | 7  | 6  | 5  | 4  | 3  | 2  | 1  |
| --------- | -- | -- | -- | -- | -- | ---| -- | -- | -- |
|     0     | PRG| REQ| RSP| VF | MF | TMR| PVV| MUL| BUT|

Бит PRG: ???

Бит REQ: прерывание от процессоров. Этот бит устанавливается в 1, когда в регистре ПОП (по маске РКП) присутствуют активные биты.

Бит RSP: ответ от процессоров (регистр ОПОП).

Бит VF: авария процессора или ПВВ.

Бит MF: ошибка оперативной памяти.

Бит TMR: прерывание от таймера (регистр 57).

Бит PVV: прерывание от процессора ввода-вывода (ПВВ).

Бит MUL: ???

Бит BUT: нажата кнопка "Запрос" на пульте.


## 50 - ПП, регистр прерываний процессорам

ПП формирует сигналы запроса для процессоров СВС, а также младшую половину байта для модуля передачи данных.

| 48 47 | 46 | 45 | 44 | 43 | 42 | 41 | 40 | 39 | 38 ... 35 | 34 | 33 | 32 ... 1 |
| ----- | -- | -- | -- | -- | -- | -- | -- | -- | --------- | -- | -- | -------- |
|   0   | ?? | ?? | ?? | ?? | R1 | R2 | R3 | R4 |    TDL    | ?? | TS |     0    |

Биты R1-R4: запросы для процессоров СВС.

Биты TDL: младшие четыре бита данных для отправки в модуль передачи данных (МПД).

Бит TS: строб передачи в МПД. Когда этот бит равен 1, четыре бита TDL пересылаются в МПД.


## 51 - ОПП, регистр ответов процессорам

ОПП формирует сигналы ответа для процессоров СВС, а также старшую половину байта для модуля передачи данных.

| 48 47 | 46 | 45 | 44 | 43 | 42 | 41 | 40 | 39 | 38 ... 35 | 34 | 33 | 32 ... 1 |
| ----- | -- | -- | -- | -- | -- | -- | -- | -- | --------- | -- | -- | -------- |
|   0   | ?? | ?? | ?? | ?? | L1 | L2 | L3 | L4 |    TDH    | ?? | TS |     0    |

Биты L1-L4: ответы для процессоров СВС.

Биты TDH: старшие четыре бита данных для отправки в модуль передачи данных (МПД).

Бит TS: строб передачи в МПД. Когда этот бит равен 1, четыре бита TDH пересылаются в МПД.


## 52 - ПОП, регистр прерываний от процессоров

ПОП показывает сигналы запроса от процессоров СВС и от модуля передачи данных.

| 48 47 | 46 | 45 | 44 | 43 | 42 | 41 | 40 | 39 | 38 ... 35 | 34 | 33 | 32 ... 1 |
| ----- | -- | -- | -- | -- | -- | -- | -- | -- | --------- | -- | -- | -------- |
|   0   | ?? | ?? | ?? | ?? | Q1 | Q2 | Q3 | Q4 |     0     | RI | TI |     0    |

Биты Q1-Q4: запросы от процессоров СВС.

Бит RI: в приёмный буфер МПД поступили данные для процессора.

Бит TI: передающий буфер МПД пуст и готов принять данные от процессора.


## 54 - РКП, регистр конфигурации процессоров

РКП задаёт маску процессоров СВС, процессоров ввода-вывода и модуля передачи данных.

| 48 47 | 46 | 45 | 44 | 43 | 42 | 41 | 40 | 39 | 38 | 37 | 36 | 35 | 34 | 33 | 32 ... 1 |
| ----- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -------- |
|   0   | V1 | V2 | V3 | V4 | P1 | P2 | P3 | P4 | ?? | ?? | ?? | ?? | MR | MT |     0    |

Биты V1-V4: наличие процесоров ввода-вывода (ПВВ).

Биты P1-P4: наличие процессоров СВС.

Бит MR: разрешение приёма от модуля передачи данных (МПД).

Бит MT: разрешение прерывания по передаче от МПД.


## TODO
