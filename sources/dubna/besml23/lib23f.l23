*     27/05/88  10.01.35     A.П.CAПOЖHИKOB
      SUBROUTINE APXAP
C*
C********  A.П.CAПOЖHИKOB
C*         E.Д.ФEДЮHЬKИH
C*     / ИЮЛЬ-ABГYCT 1981 /
C*
C*    ПPOГPAMMA - APXИBAPИYC
C*   ========================
C*
C*    OПИCAHИE XPAHИTCЯ B CИCTEME
C*    "MYЛЬTИTAЙП" И MOЖET БЫTЬ
C*    HAПEЧATAHO ПO ПPИKAЗY :
C*        TEP I/APXИB
C*
      COMMON /CHARM/ MCIT
      COMMON /ARCHIV/ IARC(10),IFIL(10),IDISP(10)
      COMMON /SCAN/   LEXTYP,KODR,IPOZ,IPOZ1
      COMMON /PROTO/  IAPROT, ITUNIT,IVE,IVF,INTER,ICAR(16),LEXEM(16)
      COMMON /TEXORG/ MAXLS,MAXKS,NWT3(3),MPRIF,NWT7(6)
      COMMON /CATAR/  ICCAT, IDCAT, KEYARC(5), IFZARC(85), LISARC(932)
      COMMON /CATFIL/ ICFIL, IDFIL, KEYFIL(5), IFZFIL(85), LISFIL(932)
      COMMON /HEADER/ ICHEA,ITEXT(511),LBZ(507),
     *ICSYM,KEYP,LOB,INHEA,IXHEA
      COMMON /BUFFER/ LBUF(1024)
      COMMON /DIAGN/  MD0(3),MD1(3),MD2(3),MD3(3),MD4(3),MD5(3),
     *                MD6(3),MD7(3),MD8(3),MD9(3),MD10(3),MD11(3),
     *                MD12(3),MD13(3),MD14(3),MD15(3),MD16(3),
     *                MD17(3),MD18(3),MD19(3),MD20(3),MD21(3),
     *                MD22(3),MD23(3),MD24(3),MD25(3),MD26(3),
     *                MD27(3),MD28(3),MD29(3),MD30(3),MD31(3)
C
C-
C
      DIMENSION MTITLE(4), LISJOB(20), NAMTYP(8), NAMATR(10)
      DIMENSION INFHEA(24), ACC(10), NRELS(10,9), KAT(9,480)
      DIMENSION JVATR(10), ACCZ(85), ID(10)
      DIMENSION LASJOB(5,20),JVPAR(7),NAMPAR(7),INFLIS(16)
      DIMENSION LISCOP(900),KEYBEG(2),MYZON(85)
      DIMENSION MTRED(4)
C
C-
C
      EQUIVALENCE (NUMERR,MD0(1)), (NOACT,MD0(2)), (LISCOP,LISFIL(3))
      EQUIVALENCE (LBZ1,LBUF(513)), (KOBJ,MD0(3))
C
C-
C
      DATA ( MYKEY = 4241 6451 6364 0000 B )
      DATA (KODCAT='ARCHIV'), (KODHEA='HEADER'), (KEYBEG='BOSS   ')
      DATA (NUMJOB=12), (NUMATR=9), (NUMTYP=6), (LENOBJ=9)
      DATA (KOBJ=-1), (NOACT=0), (MARC=0)
      DATA ( MTITLE = 'APXИBAPИYC 26/03/86.')
      DATA ( LISJOB = 'BEGIN', 'FILE', 'KEY', 'END',
     *                'DELETE', 'SHIFT', 'PUT', 'GET', 'COPY',
     *                'INFORM',  'TEXOUT','DEFECT',8(0))
      DATA ( NAMTYP = 'TEXT', 'LIBRAR', 'OVERLA', 'BINARY',
     *                'OUTPUT',     'COMMON',0,0)
      DATA ( NAMATR =0,0, 'NAME', 'TYP', 'LEVEL', 'VERSIO', 'DATA',
     *                'INDEX', 'ADRESS',   0  )
      INTEGER B48
      INTEGER  TYP,VERS,DATA,ADRES,ZONE,PAGE,RECORD,REGIM,PAROL,SORTIR
      DATA (NAME=1),(NAMTEX=3),(TYP=4),(LEVEL=5),(ZONE=1),(REGIM=3),
     *     (PAGE=2),(RECORD=5),(KVANT=4),(PAROL=6),(SORTIR=7),
     *     (VERS=6),(DATA=7),(INDEX=8),(ADRES=9)
      DATA ( IARC = 10(0) ), ( IFIL = 10(0) )
      DATA (LASJOB=50('  --  ')), ( MAXNUM=466 )
      DATA ( INFHEA = '***************   KATAЛOГ APXИBA OT 01/01/81',
     *                '***************         ',
     *                '*       N.Y.B  ИMЯ         TИП            ',
     *                '  ДATA    AДPEC    *            ')
      DATA ( INFLIS = 'C ', 'CC ', 'C* ', 'CC* ', 'C*C ',
     *                'NC', 'NCC', 'NC*', 'NCC*', 'NC*C' , 'F', 'F*',
     *                 'NF', 'NF*', 'IF', 'IF*' )
      DATA (NUMPAR=7), (NAMPAR='ZONE','PAGE','REGIM','KVANT','RECORD',
     *      'PAROL','SORTIR')
      DATA ( MTRED = 'ПEPEПИCAHO', 'OTПEЧATAHO' )
      DATA ( JOBLAS = 0 )
C
C-
C
      DATA (B48 = 4000 0000 0000 0000 B)
      DATA ( KOLD = 2364 6104 6240 5012 B )
      DATA ( LDCOD1 = 0230 0017 7247 7770 B )
      DATA ( LDCOD2 = 7000 0000 0010 0016 B )
C
C-
C
      DATA ( MD1  = 18HHE YKAЗAH APXИB   )
      DATA ( MD2  = 18HHEИЗBECTHЫЙ ПPИKAЗ)
      DATA ( MD3  = 18HOШ.ФOPMAT KЛЮЧA   )
      DATA ( MD4  = 18HATPИБYT HEИЗBECTEH)
      DATA ( MD5  = 18HOШ.ЗHAЧ.ATPИБYTA  )
      DATA ( MD6  = 18HИCПOЛH.БЛOKИPOBAHO)
      DATA ( MD7  = 18HЗAПИCЬ ЗAПPEЩEHA  )
      DATA ( MD8  = 18HAPXИB ПYCT        )
      DATA ( MD9  = 18HOШ.OБЬEM APXИBA   )
      DATA ( MD10 = 18HЧYЖOЙ KЛЮЧ        )
      DATA ( MD11 = 18HOБЬEKT OTCYTCTBYET)
      DATA ( MD12 = 18HЭTO HE ПOЛOЖEHO   )
      DATA ( MD13 = 18HHET ИMEHИ OБЬEKTA )
      DATA ( MD14 = 18HHET AДPECA OБЬEKTA)
      DATA ( MD15 = 18HHYЖHЫ ДBA AДPECA  )
      DATA ( MD16 = 18HAPXИB ПEPEПOЛHEH  )
      DATA ( MD17 = 18HИCПOPЧEH KATAЛOГ  )
      DATA ( MD18 = 18HHE HAЙДEH HEADER  )
      DATA ( MD19 = 18HMAЛO ИHФOPMAЦИИ   )
      DATA ( MD20 = 18HHET TИПA OБЬEKTA  )
      DATA ( MD21 = 18HOШИБKA. TИП=LIBRAR)
      DATA ( MD22 = 18HTPEБYETCЯ ПAPOЛЬ !)
      DATA ( MD23 = 18HHECOBП. KC OБЬEKTA)
C
C==========================================
C
      CALL DIALOG ( MTITLE,20,-1 )
   1  NUMERR = 0
   2  IF (NUMERR.EQ.0) GOTO 3
C
C---  OБPAБOTKA OШИБOK. БЛOKИPOBKA ИCПOЛHEHИЯ
C     ПPИKAЗOB ПPИ PAБOTE C  CARD READER- OM.
C
      CALL ENCOD ( 1, LEXEM )
      IF (NUMERR.GT.2000) GOTO 7
      DO 4 I=1,3
   4  IFIL(I+3) = IARC(I+3)
      IF (NUMERR.GT.1000) GOTO 7
      DO 5 I=1,3
   5  IFIL(I+3) = MD0(I+3*NUMERR)
      J=4 $ IF(ITUNIT.EQ.2) J=0
      IF ( IPOZ.LT.J ) GOTO 7
      CALL PUTBL ( IPOZ-J )
      CALL ENCODT ( '* ',2 )
   7  CALL ENCODT ( IFIL(4),18 )
      CALL ENCODL ( IPOZ1 )
      CALL DIALOG ( LEXEM,IPOZ1,-1 )
      IF ( MBFIL-1 ) 777,778,779
 778  IF ( NUMERR.EQ.17 ) GOTO 6666
      DO 780 I=1,10
 780  IFIL(I) = IARC(I)
 779  IF(IFIL.EQ.1.OR.IFIL.EQ.4)CALL TAKTAP(IFIL(2))
      DO 781 I=1,10
 781  IFIL(I) = 0
      IF ( MBFIL.NE.1 ) GOTO 777
      DO 782 I=1,10
 782  IARC(I) = 0
 777  IF ( ITUNIT.EQ.4 ) GOTO 783
      IF ( MCOPY.EQ.0 ) GOTO 3
      IF (NUMERR.NE.1019.AND.NUMERR.NE.2019) GOTO 3
      CALL PUTH(LEXEM,'HEЙДET ',0,7,0,IPOZ1)
      IF(NUMERR.GT.2000) CALL PUTH(0,'ЗAПИCЬ ',0,7,0,IPOZ1)
      IF(NUMERR.LT.2000) CALL PUTH(0,'ЧTEHИE ',0,7,0,IPOZ1)
      CALL PUTH(0,KAT(NAME,MCOPY),0,8,0,IPOZ1)
      CALL PUTH(0,'(T=',0,3,0,IPOZ1)
      CALL PUTH(0,NAMTYP(1+KAT(TYP,MCOPY)),0,1,0,IPOZ1)
      CALL PUTH(0,',Z=',0,3,0,IPOZ1)
      IF(MREZON.LT.0) CALL PUTH(0,'HEAD',0,4,0,IPOZ1)
      IF(MREZON.GE.0) CALL PUTO(0,MREZON,0,4,0,IPOZ1)
      CALL PUTH(0,'). ЧTO ДEЛATЬ(REPEAT,SKIP):',0,27,0,IPOZ1)
      CALL DIALOQ ( LEXEM,IPOZ1,ICAR )
      CALL SCANER(ICAR,LEXEM,1,LEXTYP,KODR,IPOZ)
      J = JSEART( 'SKIP  REPEAT',1,2,LEXEM)
      IF(J.EQ.0) GOTO 3
      IF(J.EQ.2) GOTO MERREP,
     *(5820,5822,5824,5911,5912,5913,5914,5915,5916,5917)
      GOTO MERSKP,
     *(5830,5823,5801,5922,5923,5924,5925,5926,5927,5933)
 783  CONTINUE
      IF ( JOB.EQ.-1 .OR. JOB.GE.10 ) GOTO 3
      IF ( JOB.EQ.11 ) GOTO 3
      NOACT = 1
      IARC(7) = 'R'
      KATFL = 0B
C
C---   B B O Д    OCHOBHOГO ПPИKAЗA :
C
   3  IPOZ1 = 1
      MSCAN = 1
      MBFIL = 0
      MSORT = 0
      MCOPY = 0
      MPRI = 1
      JOBTEX='JOB:' $ IF(ITUNIT.EQ.2) JOBTEX='JOB>'
      JOB = -1
      CALL DIALOQ ( JOBTEX,4,ICAR )
 772  CALL SCANER ( ICAR,LEXEM,1,LEXTYP,KODR,IPOZ )
C---    ПYCTOЙ ПPИKAЗ - ПOBTOPEHИE ПPEДЫДYЩEГO
      IF (LEXTYP.NE.5 .OR. JOBLAS.EQ.0) GOTO 774
      DO 773 I=1,5
 773  ICAR(I) = LASJOB(I,JOBLAS)
      GOTO 772
 774  NUMERR = 2
      IF (LEXTYP.NE.4) GOTO 2
      IF ( LEXEM.EQ.'RESTAV' ) GOTO 6666
      IF ( LEXEM.EQ.'TEACH' ) GOTO 152
      IF ( LEXEM.EQ.'HELP' ) GOTO 152
      IF ( LEXEM.EQ.'JOB' ) GOTO 151
      J = JSEART ( 'FILE  REFERE', 1, 2, LEXEM )
      IF ( J.NE.0 ) MARC = J
      IF ( J.NE.0 ) LEXEM = 'FILE'
      JOB = JSEART (LISJOB,1,NUMJOB,LEXEM)
      IF ( JOB.EQ.0 ) GOTO 2
      IF ( IARC.NE.0 ) GOTO 3333
      NUMERR = 1
      IF ( JOB.NE.1 .AND. JOB.NE.4 ) GOTO 2
 3333 CONTINUE
      DO 333 I=1,5
 333  LASJOB(I,JOB) = ICAR(I)
      JOBLAS = JOB
      GOTO ( 11,12,13,54,8,8,8,8,8,8,8,8) JOB
C
C
C---   C И H T A K C И Ч E C K И Й    P A З Б O P :
C
C
C    A.)   BEGIN:<OПИCAHИE HOCИTEЛЯ APXИBA>
C
  11  NUMERR = 12
      IF ( IARC.NE.0 ) GOTO 2
      MBFIL = 1
      IARC(2) = 0
      J = JFOCC ( 0,IARC )
      NUMERR = J+1000
      IF (J.NE.0) GOTO 2
      IARC(10) = IARC(8)
      CALL SCANER(0,LEXEM,2,LEXTYP,KODR,IPOZ)
      KEY = 0B
      IF ( LEXTYP.EQ.5 ) GOTO 10
      NUMERR = 3
      IF ( LEXTYP.NE.4 ) GOTO 2
      KEY = ISOTEX ( LEXEM )
      GOTO 10
C
C    Б.)   FILE,REF:<OПИCAHИE ФAЙЛA> <KЛЮЧ>
C
  12  IF(IFIL.EQ.1.OR.IFIL.EQ.4)CALL TAKTAP(IFIL(2))
      IFIL=0
      IFIL(2) = 0
      MBFIL = 2
      J = JFOCC ( 0, IFIL )
      NUMERR = J+2000
      IF (J.NE.0) GOTO 2
      IFIL(10) = IFIL(8)
      NUMERR = 12
      IF ( IFIL(2).EQ.IARC(2) ) GOTO 2
      KEY3 = 0B
      CALL SCANER(0,LEXEM,2,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.EQ.5 ) GOTO 10
      NUMERR = 3
      IF ( LEXTYP.NE.4 ) GOTO 2
      KEY3 = ISOTEX ( LEXEM )
      GOTO 10
C
C    B.)   KEY:<KЛЮЧ>    ИЛИ   KEY:<KЛЮЧ1>=<KЛЮЧ2>
C
  13  IPOZ1 = IPOZ
      CALL SCANER ( 0,LEXEM,2,LEXTYP,KODR,IPOZ )
      NUMERR = 3
      IF (LEXTYP.NE.4) GOTO 2
      KEY1 = ISOTEX ( LEXEM )
      KEY2 = 0B
      KEY3 = 0B
      IF ( KODR.NE.61 ) GOTO 130
      IPOZ1 = IPOZ
      CALL SCANER ( 0,LEXEM,2,LEXTYP,KODR,IPOZ )
      IF (LEXTYP.NE.4) GOTO 2
      KEY2 = ISOTEX ( LEXEM )
 130  IF ( KODR.NE.44 ) GOTO 10
      IPOZ1 = IPOZ
      CALL SCANER (0,LEXEM,2,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.NE.4 ) GOTO 2
      KEY3 = ISOTEX ( LEXEM )
      GOTO 10
C
C    Г.)    J O B
C
 151  CALL DIALOP ( 3 )
      DO 334 I=1,3
 334  CALL DIALOG (LASJOB(1,I),29,-1)
      GOTO 1
C...   " TEACH " :
 152  GOTO 1
C
C    Д.)   DELET,SHIFT,PUT,GET,COPY:<CПИCOK ПAP>
C        < ПAPA > ::= <ИMЯ ATPИБYTA>=<ЗHAЧEHИE>
C          ЗДECЬ ЖE:  INFORM,TEXOUT
C
   8  KODR = 44
      LSTZON = 0B
      CALL MBWDEF ( ACC,480 )
      DO 88 I=1,KOBJ
 88   CALL MBWPUT ( I )
      DO 800 J=1,NUMATR
      JVATR(J) = 0B
 800  CALL MBWSTA ( NRELS(1,J) )
      DO 799 I=1,NUMPAR
 799  JVPAR(I) = 0B
C---  ЦИKЛ ПO ПAPAM :
 801  IF (KODR.NE.44) GOTO 890
      IPOZ1 = IPOZ
      IF ( MSCAN.NE.0 ) CALL SCANER(0,LEXEM,0,LEXTYP,KODRA,IPOZ)
      MSCAN = 1
      IF ( LEXTYP.EQ.5 ) GOTO 890
      NUMERR = 4
      IF (LEXTYP.NE.4) GOTO 2
      JATR = JSEART ( NAMATR,1,NUMATR,LEXEM )
      IF (JATR.EQ.0) GOTO 812
      DO 810 I=1,10
 810  NRELS ( I, JATR ) = 0B
 811  NUMERR = 5
      IPOZ1 = IPOZ
      J=0 $ IF(JATR.EQ.NAMTEX) J=2
      CALL SCANER ( 0,LEXEM,J,LEXTYP,KODR,IPOZ )
      JVATR(JATR) = LEXEM
C
C...    ПEPEKЛЮЧATEЛЬ ATPИБYTИBHЫX ПAPAMETPOB
C
      GOTO ( 2,2,881,882,883,884,885,886,887 ) JATR
C
C...    OБPAБOTKA HEATPИБYTИBHЫX ПAPAMETPOB :
C
 812  JPAR = JSEART(NAMPAR,1,NUMPAR,LEXEM)
      IF ( JPAR.EQ.0 ) GOTO 2
      NUMERR = 5
      CALL SCANER(0,LEXEM,2,LEXTYP,KODR,IPOZ)
      GOTO ( 821,822,823,821,823,824,825 ) JPAR
C
C---   ПAPAMETP  SORT=<TИП COPTИPOBKИ>
C            ALF  ИЛИ  ORD
C
 825  JVPAR(SORTIR)=JSEART('ALFA  ORD',1,2,LEXEM)
      GOTO 801
C
C---   ПAPAMETP  ZONE=<HOMEP ЗOHЫ ФAЙЛA>
C      ИЛИ  <ПEPBAЯ ЗOHA>-<ПOCЛEДHЯЯ ЗOHA>
C      ПAPAMETP  KVANT=<OTH.HOM.ЗOHЫ>
C
 821  J = LEXTYP+1
      GOTO ( 2,1821,2821,2,2,2,2 ) J
 2821 LEXEM = IOCTAL(LEXEM)
 1821 JVPAR(JPAR) = LOR(0,LEXEM)
      IF ( KODR.NE.45 ) GOTO 801
      CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      J = LEXTYP+1
      GOTO ( 2,3821,4821,2,2,2,2 ) J
 4821 LEXEM = IOCTAL(LEXEM)
 3821 LSTZON = LOR(0,LEXEM)
      IF ( LSTZON.LT.JVPAR(ZONE) ) GOTO 2
      GOTO 801
C
C---   ПAPAMETP  RECORD=<HOMEP ЛИCTИHГA>
C                PAGE = <HOMEP CTPAHИЦЫ>
C                REGIM=<PEЖИM ПEЧATИ>
 823  J = LEXTYP+1
      IF(JOB.NE.10.AND.JOB.NE.11) GOTO (2,822,1822,2,2,2,2)J
      IF(LEXTYP.NE.4) LEXEM=-1
      MPRI=2
      MPRIF = JSEART(INFLIS,1,16,LEXEM)
      IF(MPRIF.EQ.0) GOTO 2
      JVPAR(REGIM) = MPRIF
      GOTO 801
C---
 824  LEXEM=ISOTEX(LEXEM)
      GOTO 822
C---
 1822 LEXEM = IOCTAL(LEXEM)
  822 JVPAR(JPAR) = LOR(0,LEXEM)
      GOTO 801
C
C---    ATPИБYT  NAME=<ИMЯ HE БOЛEE 8 CИMB.>
C
 881  IF (LEXTYP.NE.4) GOTO 2
      IVAL = ISOTEX (LEXEM)
      IF ( KODRA.NE.61 ) GOTO 2
      GOTO 802
C
C---    ATPИБYT  TYP=<ЦEЛOE> ИЛИ <IDENT>
C
 882  J = LEXEM
      IF (LEXTYP.EQ.2) GOTO 872
      IF (LEXTYP.NE.4) GOTO 2
      J = JSEART ( NAMTYP,1,NUMTYP,LEXEM )
 872  IF (J.LT.1 .OR. J.GT.NUMTYP) GOTO 2
      IVAL = J-1
      IF ( KODRA.NE.61 ) GOTO 2
      GOTO 802
C
C---    ATPИБYTЫ  LEVEL,VERSION = <ЦEЛOE>
C
 883  CONTINUE
 884  IF ( LEXTYP.NE.2 ) GOTO 2
      IF (LEXEM.LT.0 .OR. LEXEM.GT.7) GOTO 2
      IVAL = LEXEM
      GOTO 802
C
C---    ATPИБYT  INDEX = <CTPOKA ЛAT.БYKB>
C
 886  IF ( LEXTYP.NE.4 ) GOTO 2
      JVATR(INDEX) = LEXOR(64,LSHIFT(LEXEM,40))
      IF ( JOB.EQ.7 ) GOTO 801
      KODRA = 63
      J = (IPOZ-IPOZ1-1)/6
      LEXEM(J+2) = 6H
      IVAL = LETBI ( LEXEM )
      GOTO 802
C
C---    ATPИБYT  DATA = ДД/MM/ГГ
C
 885  IF ( LEXTYP.NE.2 ) GOTO 2
      N1 = LEXEM
      IVAL = 512*(N1-68)
      IF ( KODR.NE.47 ) GOTO 802
      CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.NE.2 ) GOTO 2
      N2 = LEXEM
      IVAL = 512*(N2-68)+32*N1
      IF ( KODR.NE.47 ) GOTO 802
      CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.NE.2 ) GOTO 2
      IF ( KODR.EQ.47  ) GOTO 2
      IVAL = 512*(LEXEM-68)+32*N2+N1
      GOTO 802
C
C---    ATPИБYT  ADRESS = <BOCЬMEP. ИЛИ ЦEЛOE>
C
 887  J = LEXTYP+1
      GOTO ( 2,867,877,2,2,2,2) J
 877  LEXEM = IOCTAL (LEXEM)
 867  IVAL = LOR (0,LEXEM)
      IF ( KODRA.NE.61 ) GOTO 2
C
C     ПOИCK OБ'EKTOB, PEЛEBAHTHЫX ЗHAЧEHИЮ ATPИБYTA  JATR
C
 802  CONTINUE
      JVATR(JATR) = IVAL
C---  ПPOБA PAЗДEЛИTEЛЯ :  60:"<",  61:"=",  62:">"
      NKREL = KODRA-59
      IF (NKREL.LT.1 .OR. NKREL.GT.4) GOTO 2
      CALL MBWLDA (NRELS(1,JATR))
      DO 804 I=1,KOBJ
      GOTO (831,832,833,834) NKREL
 831  IF (KAT(JATR,I).LT.IVAL) GOTO 803   $   GOTO 804
 832  IF (KAT(JATR,I).EQ.IVAL) GOTO 803   $   GOTO 804
 833  IF (KAT(JATR,I).GT.IVAL) GOTO 803   $   GOTO 804
 834  IF(LAND(IVAL,LSHIFT(B48,KAT(JATR,I))).EQ.0B) GOTO 804
 803  CALL MBWPUT ( I )
 804  CONTINUE
      CALL MBWSTA ( NRELS(1,JATR) )
      IF ( KODR.NE.43 ) GOTO 801
C...  ЗAДAHO HECKOЛЬKO ЗHAЧEHИЙ (PAЗДEЛИTEЛЬ "+")
      IF ( KODRA.NE.61 ) GOTO 2
      IF ( JOB.EQ.7 ) GOTO 2
      GOTO 811
C---  CПИCOK ПAP ИCЧEPПAH
 890  CALL MBWLDA ( NRELS )
      DO 891 I=2,NUMATR
 891  CALL MBWAND ( NRELS(1,I) )
      CALL MBWSTA ( NRELS )
      KOBJR = MBWCNT ( 0 )
      IPOZ = 0
      NUMERR = 11
      IF(JOB.GE.11.AND.JVPAR(ZONE).NE.0B) GOTO 10
      IF ( KOBJR.EQ.0 .AND. JOB.NE.7 ) GOTO 2
C
C
C      K O H E Ц   CИHTAKCИЧECKOГO PAЗБOPA
C
C
  10  NUMERR = 6
      IF (NOACT.NE.0) GOTO 2
      IPOZ = 0
      GOTO ( 51,52,53,54,57,56,55,58,59,60,22 ,23) JOB
C
C
C...    YДAЛEHИE ПЛOXИX ЗOH :
C       DEFECT:NZ   ИЛИ   DEFECT:N1-N2
C
  23  N1=JVPAR(ZONE).OR.0 $ N2=N1
      IF(LSTZON.NE.0B) N2=LSTZON
      NUMERR=12
      IF(N1.EQ.0.OR.N2.LT.N1) GOTO 2
      CALL MBWDEF( ACCZ,85*48 )
      CALL MBWLDA( IFZARC )
      DO 2323 I=N1,N2
 2323 CALL MBWCLE( I )
      CALL MBWSTA( IFZARC )
      GOTO 6
C
C     ФAЗA OTPAБOTKИ  "BEGIN" :
C
  51  IARC(8) = MAKRIW (ICCAT,0)
      IARC(7) = 'R'
      J = JFEXCH (IARC)
C
C...     C T P Y K T Y P A   K A T A Л O Г A :
C        =====================================
C
C    1 : ПPИЗHAK KATAЛOГA
C    2 : ДATA ПOCЛEДHEЙ ЗAПИCИ B APXИB(1-15)
C        И OБ'EM APXИBA (16-30)
C    3 : KЛЮЧ ДOCTYПA ПO ЗAПИCИ
C    4 : KЛЮЧ ДOCTYПA ПO ЧTEHИЮ
C  5-7 : P E З E P B
C 8-92 : ШKAЛA CBOБOДHЫX ЗOH APXИBA
C  93- : CПИCOK OБ'EKTOB
C        ДBA CЛOBA HA OБЬEKT :
C    1 : ИMЯ B KOДE  TEXT
C    2 : XAPAKTEPИCTИKA :
C        48-46 : TИП OБЬEKTA
C        45-43 : HOMEP YPOBHЯ
C        42-40 : HOMEP BEPCИИ
C        39-25 : ДATA ЗAПИCИ B APXИB
C        18-13 : ИHДEKC OБЬEKTA
C        12-1  : HOMEP ЗOHЫ  HEADER-A
C
C
C...     C T P Y K T Y P A   H E A D E R - A :
C        =====================================
C
C          1 : ПPИЗHAK HEADER-A
C      2-512 : OПИCAHИE OБ'EKTA
C   513-1012 : CПИCOK ЗAHЯTЫX ЗOH
C       1020 : KOHTP. CYMMA OБ'EKTA
C       1022 : ДЛИHA OБЬEKTA B ЗOHAX
C       1023 : ИMЯ OБ'EKTA B KOДE TEXT
C       1024 : XAP-KA OБ'EKTA ИЗ KATAЛOГA
C
C
      NUMERR = J+1000
      IF (J.NE.0) GOTO 2
      KATFL = LEXOR ( ICCAT, KODCAT )
      IF (KATFL.EQ.0B) GOTO 515
      NUMERR = 17
      IF ( KATFL.EQ.B48 ) GOTO 2
C---  HAЧAЛЬHOE COCTOЯHИE KATAЛOГA :
      NUMERR = 9
      IF (IARC(3).LT.20) GOTO 2
      J = IARC(3)
      CALL MBWDEF ( IFZARC, 85*48 )
      DO 510 I=2,J
 510  CALL MBWPUT ( I-1 )
      DO 511 I=1,932
 511  LISARC(I) = 0B
      CALL DATE (ICAR)
      CALL DTOI (ICAR,IDCAT)
      IDCAT = LOR ( IDCAT, LSHIFT(J,-15) )
      ICCAT = KODCAT
      KEYARC = ISOTEX ( KEYBEG )
      KEYARC(2) = KEYARC
      KEY       = KEYARC
      CALL DIALOG ( 'APXИB ПYCT', 10, -1 )
 515  IARC(7) = 'W'
      IF ( KEY.EQ.MYKEY ) GOTO 516
      IF ( KEY.EQ.KEYARC ) GOTO 516
      IARC(7) = 'R'
      IF ( KEY.NE.KEYARC(2) ) GOTO 521
C---  PACФACOBKA KATAЛOГA :
 516  KOBJ = 0
      DO 517 I=1,935,2
      IF (LISARC(I).EQ.0B) GOTO 518
      KOBJ = KOBJ+1
      CALL TEXISO ( LISARC(I),KAT(NAME,KOBJ) )
      IXAP = LISARC(I+1)
      KAT(NAMTEX,KOBJ) = LISARC(I)
      KAT(ADRES,KOBJ) = LOR(0,LAND(IXAP,7777B))
      KAT(INDEX,KOBJ) = LOR( 0, LAND( LSHIFT(IXAP,12),    77B))
      KAT(DATA,KOBJ) = LOR( 0, LAND( LSHIFT(IXAP,24), 77777B))
      KAT(VERS,KOBJ) = LOR( 0, LAND( LSHIFT(IXAP,39),     7B))
      KAT(LEVEL,KOBJ) = LOR( 0, LAND( LSHIFT(IXAP,42),     7B))
      KAT(TYP,KOBJ) = LOR( 0, LAND( LSHIFT(IXAP,45),     7B))
 517  CONTINUE
 518  CONTINUE
      IARC(3) = LOR(0,LAND(7777B,LSHIFT(IDCAT,15)))
      CALL MBWDEF ( ACCZ, 85*48 )
      CALL MBWLDA ( IFZARC )
      LSTFND = MBWFIR ( 0 )
      IF ( LSTFND.EQ.0 ) LSTFND = IARC(3)
      IF ( KATFL.EQ.B48 ) GOTO 6
      GOTO 1
C
C---   "RESTAV" : BOCCTAHOBЛEHИE KATAЛOГA APXИBA
C
 6666 NUMERR = 1
      IF( IARC.EQ.0 ) GOTO 2
      IARC(8) = MAKRIW(ICCAT,0)
      J = JFEXCH(IARC)
      KATFL = LEXOR(ICCAT,KODCAT)
      NUMERR = 12
      IF (KATFL.EQ.0B) GOTO 2
      IVOL = LOR(0,LAND(7777B,LSHIFT(IDCAT,15)))
      IF (KATFL.NE.B48) IVOL=IARC(3)
      NUMERR = 9
      IF (IVOL.LT.20) GOTO 2
      ICCAT = KODCAT
      CALL DATE(ID)
      CALL DTOI ( ID,IDCAT )
      IDCAT = LOR(IDCAT,LSHIFT(IVOL,-15))
      IF ( KATFL.NE.B48 ) KEYARC = ISOTEX(KEYBEG)
      IF ( KATFL.NE.B48 ) KEYARC(2) = KEYARC
      KOBJ = 0
      CALL MBWDEF ( ACCZ, 85*48 )
      DO 6667 I=2,IVOL
 6667 CALL MBWPUT(I-1)
      CALL MBWSTA ( IFZARC )
      CALL MBWSTA ( IFZFIL )
      CALL DIALOG('BOCCTAHOBЛEHИE KATAЛOГA: ДA ИЛИ HET:',36,ICAR)
      KATFL = 0B
      IF(LSHIFT(LEXOR(ICAR,'ДA'),32).NE.0B) GOTO 543
      DO 6671 J=1,932
 6671 LBUF(J) = LISARC(J)
 6668 CALL MBWLDA ( IFZFIL )
      IZON = MBWFIR ( 0 )
      IF ( IZON.EQ.0 ) GOTO 6670
      CALL MBWCLE ( IZON )
      CALL MBWSTA ( IFZFIL )
      IARC(8) = MAKRIW(ICHEA,IZON)
      J = JFEXCH ( IARC )
      IF(J.NE.0) CALL DIALOG(IARC(4),17,-1)
      IF ( ICHEA.NE.KODHEA ) GOTO 6668
      IF(J.EQ.0)GOTO 6674
      CALL DIALOG('HE ПPOЧИTAH HEADER',18,-1)
      GOTO 6668
 6674 CONTINUE
      KOBJ = KOBJ + 1
      LISARC(2*KOBJ-1) = INHEA
      LISARC(2*KOBJ  ) = IXHEA
      LISARC(2*KOBJ+1) = 0B
C...  YPOBEHЬ И BEPCИЮ БEPEM ИЗ CTAPOГO KATAЛOГA
      NLEV = 0B
      IF ( LSHIFT(KATFL,-1).NE.0B ) GOTO 6673
      DO 6672 J=1,932,2
      IF(LBUF(J).EQ.0B) GOTO 6673
      IF(LBUF(J).NE.INHEA) GOTO 6672
      IF(LAND(7777B,LEXOR(IZON,LBUF(J+1))).NE.0B) GOTO 6672
      NLEV = LAND(LBUF(J+1),0770 0000 0000 0000B)
      GOTO 6673
 6672 CONTINUE
 6673 LISARC(2*KOBJ) = LOR(NLEV,LISARC(2*KOBJ))
      DO 6669 I=1,10000
      J = KLETKA (LBZ,I-1)
      IF ( J.EQ.0B ) GOTO 6668
      CALL MBWLDA (IFZFIL)
      CALL MBWCLE (J)
      CALL MBWSTA (IFZFIL)
      CALL MBWLDA (IFZARC)
      CALL MBWCLE (J)
 6669 CALL MBWSTA (IFZARC)
 6670 KATFL = B48
      IARC(7) = 'W'
      CALL DIALOG('KATAЛOГ BOCCTAHOBЛEH.',21,-1)
      MSORT = 1
      GOTO 516
C
C     ФAЗA OTPAБOTKИ  "FILE" :
C
  52  J = IFIL(1) $ IFIL(7) = 'W'
      IF(MARC.NE.2) GOTO 1
      IFIL(8) = MAKRIW (ICFIL,0)
      J = JFEXCH ( IFIL )
      NUMERR = J+2000
      IF ( J.NE.0 ) GOTO 2
      IF ( ICFIL.NE.KODCAT ) GOTO 1
      J=LOR(0,LAND(7777B,LSHIFT(IDFIL,15)))
      IF ( J.LT.IFIL(3) ) IFIL(3)=J
      IF ( KEY3.EQ.KEYFIL ) GOTO 1
      IF ( KEY3.EQ.MYKEY ) GOTO 1
      IFIL(7) = 'R'
      IF ( KEY3.EQ.KEYFIL(2) ) GOTO 1
 521  CALL DIALOG ('BAШE ЛЮБOПЫTCTBO HEПPИЛИЧHO.',28,-1)
      GOTO 543
C
C     ФAЗA OTPAБOTKИ  "KEY" :
C
  53  NUMERR = 10
      IF (KEYARC.NE.KEY1) GOTO 2
      IARC(7) = 'W'
      IF ( KEY2.NE.0B ) KEYARC = KEY2
      IF ( KEY3.NE.0B ) KEYARC(2) = KEY3
      GOTO 6
C
C     ФAЗA OTPAБOTKИ  "END" :
C
  54  IF ( KATFL.NE.B48 ) GOTO 543
      IF ( IARC.EQ.0 ) GOTO 543
      ASSIGN  543  TO MEND
      IF(IFIL.EQ.1.OR.IFIL.EQ.4)CALL TAKTAP(IFIL(2))
 541  CONTINUE
C...  YПAKOBKA KATAЛOГA
      DO 542 I=1,KOBJ
      LISARC(2*I-1) = KAT(NAMTEX,I)
      IXAP = 64*KAT(TYP,I)+8*KAT(LEVEL,I)+KAT(VERS,I)
      IXAP = LOR ( KAT(DATA  ,I),LSHIFT(IXAP,-15) )
      IXAP = LOR ( KAT(INDEX ,I),LSHIFT(IXAP,-12) )
      IXAP = LSHIFT ( IXAP, -12 )
 542  LISARC(2*I) = LOR(IXAP,LAND(7777B,KAT(ADRES,I)))
      LISARC(2*KOBJ+1) = 0B
      LISARC(2*KOBJ+2) = 0B
      CALL DATE ( ICAR )
      CALL DTOI ( ICAR, ID )
      IDCAT = LEXOR(IDCAT,LAND(77777B,LEXOR(IDCAT,ID)))
      ICCAT = KODCAT
      KATFL = 0B
      IARC(8) = MAKWIW(ICCAT,0)
      J = JFEXCH(IARC)
      GOTO  MEND, (543,1)
 543  CALL DIALOG('ДO CBИДAHИЯ',12,-1)
      IARC = 0
      RETURN
C
C     ФAЗA OTPAБOTKИ  "PUT" :
C
C...  ПPABИЛA BHECEHИЯ B APXИB :
C     ==========================
C  1.)  OБЬEKT BПИCЫBAETCЯ HA 0-Й YPOBEHЬ
C     0-Й BEPCИEЙ. ПPEДЫДYЩИE BEPCИИ EГO
C     ПOЛYЧAЮT HOMEP HA 1 БOЛЬШИЙ. 7-Я
C     BEPCИЯ YHИЧTOЖAETCЯ.
C  2.)  ECЛИ TИП ИЛИ ИHДEKC HE ЗAДAHЫ, OHИ
C     ПOЛAГAЮTCЯ PABHЫMИ HYЛЮ.
C  3.)  ДЛЯ OБЬEKTOB TИПA "BIN" HEOБXOДИMO
C     KPOME ЗOHЫ HAЧAЛA YKAЗЫBATЬ ЗOHY
C     KOHЦA.
C  4.)  ПPИ HEXBATKE MECTA B APXИBE ПPИHЯTA
C     CЛEДYЮЩAЯ CTPATEГИЯ :
C     PACCMOTPИM  7-E, 6-E, ... , 1-E  BEPCИИ
C     BCEX OБ'EKTOB YPOBHЯ 0.  CPEДИ HИX БEPETCЯ
C     OБ'EKT, CAMЫЙ CTAPЫЙ ПO ДATE.
C
  55  NUMERR = 12
      IF ( JVATR(LEVEL).NE.0B ) GOTO 2
      IF ( JVATR(VERS ).NE.0B ) GOTO 2
      IF ( JVATR(DATA ).NE.0B ) GOTO 2
      IF ( JVATR(ADRES).NE.0B ) GOTO 2
      NUMERR = 16
      IF ( KOBJ.GE.MAXNUM ) GOTO 2
      IF ( JVATR(INDEX).EQ.0B ) JVATR(INDEX) = 0
      CALL DATE (ID)
      CALL DTOI (ID,JVATR(DATA))
      JVATR(LEVEL) = 0
      JVATR(VERS ) = 0
      NZCNT = 0
      ICS=0B
      DO 5500 I=1,1023
 5500 ITEXT(I) = 0B
      KPAROL=JVPAR(PAROL)
      CALL BRAND(KPAROL)
      NUMERR = 14
      IW57=0B
      IF(JVPAR(RECORD).NE.0B) GOTO 5599
      IF(JVPAR(ZONE).EQ.0B) GOTO 2
      IF(MARC.EQ.0) GOTO 2
      IF(MARC.NE.2) GOTO 5501
C
C...  ИЗBЛEЧEHИE ИЗ ЧYЖOГO APXИBA ПO AДPECY  HEADER-A :
C
      IFIL(8) = MAKRIW(ICHEA,JVPAR(ZONE))
      J = JFEXCH(IFIL)
      NUMERR = J+2000
      IF(J.NE.0) GOTO 2
      NUMERR = 18
      IF ( ICHEA.NE.KODHEA ) GOTO 2
      NUMERR=22
      IF(KEYP.NE.KPAROL) GOTO 2
      JVPAR(PAROL)=0B
      IF(JVATR(NAMTEX).EQ.0B) JVATR(NAMTEX) = INHEA
      JVATR(TYP) = LOR ( 0, LSHIFT(IXHEA,45) )
      IF(JVATR(INDEX).EQ.0) JVATR(INDEX)=LOR(0,LAND(77B,
     *                      LSHIFT(IXHEA,12)))
      DO 5505 I=1,10000
      J = KLETKA ( LBZ, I )
      IF ( J.EQ.0B ) GOTO 5501
 5505 LSTZON = J
C
C...   OБЬEKT TИПA  OUTPUT :
C
 5599 JVATR(TYP)=4 $ IPOZ=0
      NUMERR=5 $ IF(JVPAR(ZONE).NE.0B) GOTO 2
      IW57=MAKRIW(LBUF,0).OR.1400 0000 0000 0000B
      J = JEXTRA(IW57,57B,7)
      J=JVPAR(RECORD)
      IF(J.LT.1.OR.J.GT.63) GOTO 2
      NZOUT=LBUF(5*J+1).AND.777B
      NZKOD=LBUF(5*J+1).AND.7777 7700 0000B
      LSTZON=-1
 5501 CALL MBWDEF ( ACCZ, 85*48 )
      CALL MBWSTA ( MYZON )
      NUMERR = 15
      IF ( JVATR(TYP).EQ.3 .AND. LSTZON.EQ.0B ) GOTO 2
      NUMERR = 13
      IF(JVATR(NAMTEX).EQ.0B) GOTO 2
      IF(JVATR(TYP).EQ.0B .AND. LSTZON.NE.0B) JVATR(TYP) = 3
      ASSIGN  5502  TO MCHANG
C
C
C...   YCTAHOBKA ПPИЗHAKA: "БЫЛA ЗAПИCЬ"
C
C
 720  IF ( KATFL.EQ.B48 ) GOTO 721
      CALL DATE ( ID )
      CALL DTOI ( ID,J )
      ICCAT = LOR ( ICCAT,B48 )
      IDCAT = LEXOR(IDCAT,LAND(77777B,LEXOR(IDCAT,J)))
      IARC(8) = MAKWIW ( ICCAT,0 )
      J = JFEXCH ( IARC )
      ICCAT = KODCAT
      KATFL = B48
      NUMERR = J+1000
      IF ( J.NE.0 ) GOTO 2
 721  GOTO  MCHANG, ( 5502,5702 )
C
C...  ПOИCK CBOБOДHOЙ ЗOHЫ B APXИBE :
C
 5502 CALL MBWLDA ( IFZARC )
      CALL MBWEXO ( MYZON )
      NZFREE = MBWFIR (0)
      LSTFND = NZFREE
      IF (NZFREE.NE.0) GOTO 5510
C
C...  BCE ЗAБИTO. ИЩEM KAHДИДATA HA BЫHOC :
C
C     C MЛ EC HE BЫHOCИM
C
      IF(IARC(1).EQ.4) GOTO 5504
      DO 5504 IVER = 1,7
      IVER1 = 8-IVER
      IDA = 999999
      INU = 0
      DO 5503 I=1,KOBJ
      IF (KAT(LEVEL,I).NE.0) GOTO 5503
      IF (KAT(VERS ,I).NE.IVER1) GOTO 5503
      IF (KAT(DATA ,I).GE.IDA  ) GOTO 5503
      IDA = KAT(DATA,I)
      INU = I
 5503 CONTINUE
C...  HAШЛИ - ПOXOД HA YДAЛEHИE :
      ASSIGN 5502 TO MDELET
      IF ( INU.NE.0 ) GOTO 700
C...  HE HAШЛИ - KPAHTЫ
 5504 CONTINUE
      NUMERR = 16
      GOTO 2
C
C...  ПOЗOHHOE ЧTEHИE HOBOГO OБ'EKTA
C     ЗAПOЛHEHИE CПИCKA ЗOH B HEADER-E
C
 5510 IF (NZCNT.EQ.0) NZHEA = NZFREE
      N1 = NZCNT/4
      N2 = NZCNT-4*N1
      MASK = LSHIFT( 7777B, 12*N2-36 )
      IF(IW57.EQ.0B) IA=JVPAR(ZONE)+NZCNT-1
      IF(IW57.NE.0B) IA=NZOUT
      IF(MARC.EQ.2) IA = KLETKA(LBZ,NZCNT)
      IF ( IA.EQ.0B ) GOTO 5520
      LBZ(N1+1) = LEXOR ( MASK, LOR (MASK,LBZ(N1+1)) )
      LBZ(N1+1) = LOR(LBZ(N1+1),LSHIFT(LAND(NZFREE,7777B),12*N2-36))
      NZCNT=NZCNT+1
      IF (NZCNT.EQ.1) GOTO 5562
      IF(IW57.EQ.0B) GOTO 5511
      J = JEXTRA(IW57.OR.IA,57B,7)
      NZOUT=LBUF.AND.777B
      NZKOD1=LBUF.AND.7777 7700 0000B
      IF(NZKOD1.NE.NZKOD) NZOUT=0B
      GOTO 5550
 5511 CONTINUE
      IFIL(8) = MAKRIW(LBUF,IA)
      J = JFEXCH(IFIL)
      NUMERR=J+2000
      IF(J.NE.0) GOTO 2
      IF (NZCNT.NE.2 .OR. MARC.EQ.2) GOTO 5550
      NGTYP = JVATR(TYP)
      IF ( NGTYP.EQ.3 ) GOTO 5550
      IF ( NGTYP.EQ.4 ) GOTO 5550
C
C...  ABTOMATИЧECKOE OПPEДEЛEHИE TИПA :
C
      LSTZON = 0B
      JVATR(TYP) = INFTYP( LBUF )
      J = JVATR(TYP)+1
      GOTO (5540,5541,5541,5543,5543,5541,5543,5543) J
C
C...   LIBRARY, OVERLAY ИЛИ COMMON :
C      ДЛИHA OБЬEKTA CTAHOBИTCЯ ИЗBECTHOЙ
C
 5541 LSTZON = IA+MCIT-1
      GOTO 5540
 5543 NUMERR=20 $ IF(LSTZON.EQ.0B) GOTO 2
 5540 NUMERR = 21
      MD21(3) = NAMTYP(1+JVATR(TYP))
      IF ( NGTYP.NE.0B .AND. NGTYP.NE.JVATR(TYP) ) GOTO 2
 5550 MBCAR = 0
      IF(JVPAR(PAROL).EQ.0B) GOTO 5552
      DO 5553 I=1,1024
      IF(LBUF(I).EQ.'*READ') GOTO 5552
 5553 LBUF(I) = MIXER( LBUF(I) )
C
C...  ЗAПИCЬ ЗOHЫ B APXИB :
C
 5552 IARC(8) = MAKWIW(LBUF,NZFREE)
      CALL ADDCS ( LBUF,ICS )
      J = JFEXCH(IARC)
      NUMERR = J+1000
      IF(J.NE.0) GOTO 2
      CALL MBWLDA ( MYZON )
      CALL MBWPUT ( NZFREE )
      CALL MBWSTA ( MYZON )
      IF ( IA.EQ.LSTZON ) GOTO 5520
      IF ( JVATR(TYP).NE.0 ) GOTO 5502
C
C...   ПPOБA HA KOHEЦ TEKCTOBOГO ФAЙЛA:
C
      IF( MREAD.NE.1 ) GOTO 5551
      IF ( LBUF.EQ.KOLD ) GOTO 5520
      MREAD = 0
 5551 DO 5508 I=1,14
      J = I + MBCAR
      IF ( J.GT.1024 ) GOTO 5502
      IF ( LBUF(J).NE.'*READ' ) GOTO 5509
      MREAD = 1
      IF ( J.EQ.1024 ) GOTO 5502
      MREAD = 0
      IF ( LBUF(J+1).EQ.KOLD ) GOTO 5520
 5509 IF ( LAND(377B,LEXOR(12B,LBUF(J))).NE.0B ) GOTO 5508
      MBCAR = J
      GOTO 5551
 5508 CONTINUE
      LBUF(MBCAR+1) = '*READ'
      LBUF(MBCAR+2) = KOLD
      J = JFEXCH ( IFIL )
 5512 CALL DIALOG('OБЬEKT БEЗ XBOCTA',17,-1)
      GOTO 5520
 5562 CALL MBWLDA ( MYZON )
      CALL MBWPUT ( NZFREE )
      CALL MBWSTA ( MYZON )
      IF ( IARC(1).NE.4 ) GOTO 5502
C
C...  APXИB - HA EC MЛ.  ЗAPEЗEPBИPYEM ПOД HEADER
C     ДBE ЗOHЫ И ЗAПИШEM TYДA ДЛЯ HAЧAЛA HYЛИ.
C
      CALL MBWLDA(IFZARC)
      CALL MBWEXO(MYZON)
      NUMERR=16
      IF(MBWCHK(NZFREE+1).NE.1) GOTO 2
      CALL MBWLDA(MYZON)
      CALL MBWPUT(NZFREE+1)
      CALL MBWSTA(MYZON)
C     ПPEДBAPИTEЛЬHAЯ ЗAПИCЬ B ЗAPEЗEPBИPOBAHHЫE
C     ЗOHЫ (ДЛЯ PAЗГOHY).
      DO 5563 I=1,1024
 5563 LBUF(I)=0B
      DO 5564 I=1,2
      IARC(8)=MAKWIW(LBUF,NZFREE+I-1)
      J=JFEXCH(IARC)
      NUMERR=J+1000
      IF(J.NE.0)GOTO 2
 5564 CONTINUE
      GOTO 5502
C
C...  OБ'EKT ПEPEПИCAH. OФOPMЛEHИE HEADER-A  И  KATAЛOГA :
C
 5520 JVATR(ADRES) = NZHEA
      I=(NZHEA.AND.7777B).OR.(IARC(2).SHIFT.-12).OR.0030 0000 0000 0000B
      IF(IARC(1).EQ.1) J=JEXTRI(I,70B,I)
      CALL TEXISO(JVATR(NAMTEX),JVATR(NAME))
      DO 5521 I=1,NUMATR
 5521 KAT(I,KOBJ+1) = JVATR(I)
      INHEA = JVATR(NAMTEX)
      IXHEA = 64*JVATR(TYP)
      IXHEA = LOR(JVATR(DATA ),LSHIFT(IXHEA,-15))
      IXHEA = LOR(JVATR(INDEX),LSHIFT(IXHEA,-12))
      IXHEA = LOR(LSHIFT(IXHEA,-12),LAND(7777B,NZHEA))
      LOB = NZCNT-1
      KEYP=KPAROL
      NUMERR=23
      IF(MARC.EQ.2.AND.ICS.NE.ICSYM.AND.ICSYM.NE.0B)GOTO 2
      ICSYM=ICS
C
C...  ПPИEM OПИCAHИЯ OБ'EKTA :
C
      N2 = 1
      DO 5522 I=1,10000
      IF ( N2.GT.500 ) GOTO 5523
      CALL DIALOQ('ДAЙ OПИCAHИE: ',14,ICAR)
      IF (LSHIFT(LEXOR(ICAR,')'),40).EQ.0B) GOTO 5523
 5522 N2 = N2 + ICOS(ICAR,ITEXT(N2))
 5523 IF(N2.EQ.1.AND.MARC.EQ.2) GOTO 5530
      ITEXT(N2) = '*READ'
      ITEXT(N2+1) = KOLD
C...  CЛИB  HEADER-A :
 5530 IARC(8) = MAKWIW(ICHEA,NZHEA)
      ICHEA = KODHEA
      J = JFEXCH(IARC)
      NUMERR = J+1000
      IF(J.NE.0) GOTO 2
      CALL MBWLDA ( MYZON )
      CALL MBWEXO ( IFZARC )
      CALL MBWSTA ( IFZARC )
      CALL ENCOD ( 1,LEXEM )
      CALL ENCODT ( 'ПPИHЯTO B APXИB ', 16 )
      CALL ENCODB ( NZCNT-1, 4, 0 )
      CALL ENCODT ( ' ЗOH.', 5 )
      CALL DIALOG ( LEXEM, 25, -1 )
C
C...  П P O Д B И Ж K A   B E P C И Й :
C
      CALL MBWDEF ( ACC,480 )
      DO 5531 I=1,KOBJ
      IF ( KAT(NAMTEX,I).NE.JVATR(NAMTEX) ) GOTO 5531
      IF ( KAT( TYP  ,I).NE.JVATR( TYP  ) ) GOTO 5531
      IF ( KAT(LEVEL ,I).NE.0 ) GOTO 5531
      KAT(VERS,I) = KAT(VERS,I)+1
      IF ( KAT(VERS,I).LE.7 ) GOTO 5531
      CALL MBWPUT ( I )
 5531 CONTINUE
      KOBJ = KOBJ+1
      MSORT = 1
      KOBJR = MBWCNT ( 0 )
      IF ( KOBJR.EQ.0 ) GOTO 6
      CALL MBWSTA ( NRELS )
      GOTO 57
C
C     ФAЗA OTPAБOTKИ "SHIFT" :
C
C
C...    ПOPЯДOK BЫПOЛHEHИЯ OПEPAЦИИ SHIFT:
C       ==================================
C
C    1.OБ'EKTЫ YPOBHЯ 7 ИCKЛЮЧAЮTCЯ.
C    2.OБ'EKTЫ YPOBHEЙ 1,2,...,6 ПEPEXOДЯT
C      HA CЛEДYЮЩИЙ YPOBEHЬ.
C    3.HA YPOBHE 0 OCTAETCЯ TOЛЬKO 0-Я BEPCИЯ
C      CAMAЯ CTAPAЯ ( ПO ДATE ) BEPCИЯ 0-ГO
C      YPOBHЯ ПEPEXOДИT HA 1-Й, OCTAЛЬHЫE
C      BEPCИИ 0-ГO YPOBHЯ ИCKЛЮЧAЮTCЯ.
C    4.ECЛИ HA 0 YPOBHE TOЛЬKO 0-Я BEPCИЯ,
C       TO CДBИГ HE ПPOИЗBBOДИTCЯ.
C
  56  NUMERR = 12
C
C...  OПEPAЦИЯ  "SHIFT"  ДЛЯ APXИBA HA EC MЛ
C     З A П P E Щ E H A
C
      IF(IARC(1).EQ.4)GOTO 2
      IF (JVATR(LEVEL).NE.0B) GOTO 2
      IF (JVATR(VERS).NE.0B) GOTO 2
      IF (JVATR(DATA).NE.0B) GOTO 2
 5600 J = MBWFIR ( 0 )
      IF ( J.EQ.0 ) GOTO 5601
      CALL MBWCLE ( J )
      KAT(LEVEL,J) = KAT(LEVEL,J) + 10
      GOTO 5600
 5601 I1 = 1
      CALL SHSORT ( KAT,KOBJ,LENOBJ,0 )
 5602 DO 5603 J = I1,KOBJ
      IF(KAT(NAMTEX,J).NE.KAT(NAMTEX,I1)) GOTO 5604
      IF(KAT( TYP  ,J).NE.KAT( TYP  ,I1)) GOTO 5604
      IF(KAT(LEVEL ,J).NE.KAT(LEVEL ,I1)) GOTO 5604
 5603 I2 = J
C...      ( I1, I2 ) - MHOЖECTBO BEPCИЙ OДHOГO YPOBHЯ
 5604 NLEV = KAT(LEVEL,I1)
      IF ( NLEV-10 ) 5608,5605,5606
 5605 IF ( I1.EQ.I2 ) GOTO 5606
      KAT(LEVEL,I1) = 0
      KAT(VERS ,I1) = 0
      N1 = I1+1
      N2 = I2-1
      IF ( N1.GT.N2 ) GOTO 5606
      DO 5607 J = N1,N2
 5607 CALL MBWPUT ( J )
 5606 KAT(LEVEL,I2) = NLEV-9
      KAT(VERS ,I2) = 0
      IF (KAT(LEVEL,I2).GT.7) CALL MBWPUT(I2)
 5608 I1 = I2+1
      IF (I1.LE.KOBJ) GOTO 5602
      CALL MBWSTA ( NRELS )
      IF ( MBWCNT(0).EQ.0 ) GOTO 6
      JVATR(ADRES) = KAT(ADRES,MBWFIR(0))
C
C     ФAЗA OTPAБOTKИ  "DELETE" :
C
  57  N1 = 0
      NUMERR = 12
C
C...  OПEPAЦИЯ  "DELETE"  ДЛЯ APXИBA HA EC MЛ
C     З A П P E Щ E H A .
C
      IF(IARC(1).EQ.4)GOTO 2
      IF ( JVATR(ADRES).NE.0B ) GOTO 5700
      IF ( JVATR(INDEX).NE.0B ) GOTO 5700
      IF ( JVATR(NAMTEX).EQ.0B ) GOTO 2
 5700 N2 = MBWFIR ( 0 )
      IF ( N2.EQ.0 ) GOTO 5701
      CALL MBWCLE ( N2 )
      N1 = N1+1
      LISFIL(N1) = KAT(ADRES,N2)
C
C...  ПPOБA HA YHИKAЛЬHOCTЬ OБ'EKTA:
C
      IF ( JVATR(ADRES).NE.0B ) GOTO 5700
      IF ( JVATR(LEVEL).NE.0B ) GOTO 5700
      IF ( JVATR(VERS ).NE.0B ) GOTO 5700
      J = 0
      DO 5703 I=N2,KOBJ
      IF(KAT(NAMTEX,I).NE.KAT(NAMTEX,N2)) GOTO 5703
      IF(KAT( TYP  ,I).NE.KAT( TYP  ,N2)) GOTO 5703
      J = J + 1
 5703 CONTINUE
      IF ( J.GT.1 ) GOTO 5700
      N1 = N1-1
      CALL PUTH(LEXEM,'OБЬEKT ',0,7,0,J)
      CALL PUTH(0,KAT(NAME,N2),0,9,0,J)
      CALL PUTH(0,'YHИKAЛEH. ',0,10,0,J)
      CALL PUTH(0,'YHИЧTOЖEHИE БЛOKИPOBAHO',0,23,0,J)
      CALL DIALOG ( LEXEM,49,-1 )
      GOTO 5700
C
C...  COPTИPOBKA ПO AДPECAM HEADER-OB:
C
 5701 CALL SHSORT ( LISFIL,N1,1,2 )
      CALL MBWDEF ( ACCZ, 85*48 )
      ASSIGN  5702  TO MCHANG
      GOTO 720
 5702 CONTINUE
C
C...  ЦИKЛ ИCKЛЮЧEHИЯ :
C
      ASSIGN  5710  TO MDELET
      DO 5710 IVER = 1, N1
      N2 = LISFIL(IVER)
      DO 5711 J=1,KOBJ
      INU = J
      IF(KAT(ADRES,J).EQ.N2) GOTO 700
 5711 CONTINUE
 5710 CONTINUE
C
C...  ПO ЗABEPШEHИИ PAБOTЫ ЗAПИШEM KATAЛOГ
C     CPAЗY ЖE, ECЛИ APXИB HA ДИCKE.
C
  6   KATFL = B48
      I1 = 1
      IF ( MSORT.EQ.0 ) GOTO 6001
      CALL SHSORT ( KAT,KOBJ,LENOBJ,0 )
      MSORT = 0
 6001 I2 = 0
      DO 6002 J=I1,KOBJ
      IF(KAT(NAMTEX,J).NE.KAT(NAMTEX,I1)) GOTO 6003
      IF(KAT( TYP  ,J).NE.KAT( TYP  ,I1)) GOTO 6003
      IF(KAT(LEVEL,J).NE.0 .AND. I2.EQ.0) I2 = J
      KAT(LEVEL,J) = 0
      KAT(VERS ,J) = J - I1
 6002 I3 = J
 6003 IF ( I2-I1 ) 6004,6005,6006
 6005 I2 = I2 + 1
 6006 IF ( I2.GT.I3 ) GOTO 6004
      DO 6007 I=I2,I3
      KAT(LEVEL,I) = I-I2+1
 6007 KAT(VERS ,I) = 0
 6004 I1 = I3+1
      IF ( I1.LE.KOBJ ) GOTO 6001
      IF ( IARC(10).NE.0 ) GOTO 1
      ASSIGN  1  TO MEND
      GOTO 541
C
C...  Б Л O K   И З ' Я T И Я :
C
 700  IARC(8) = MAKRIW(LBUF,KAT(ADRES,INU))
      J = JFEXCH(IARC)
      NUMERR = J+1000
      IF ( J.NE.0 ) GOTO 2
      NUMERR = 17
      IF ( LBUF.NE.KODHEA ) GOTO 2
      LBUF = LOR ( LBUF, B48 )
      IARC(8) = MAKWIW(LBUF,KAT(ADRES,INU))
      J = JFEXCH(IARC)
      NUMERR = J+1000
      IF (J.NE.0) GOTO 2
      DO 701 I=INU,KOBJ
      DO 701 J=1,LENOBJ
 701  KAT(J,I)=KAT(J,I+1)
      KOBJ = KOBJ-1
      CALL MBWLDA ( IFZARC )
      DO 702 I=1,10000
      J = KLETKA(LBZ1,I-1)
      IF ( J.EQ.0B ) GOTO 703
 702  CALL MBWPUT ( J )
 703  CALL MBWSTA ( IFZARC )
 710  GOTO MDELET ,( 5710,5502 )
C---
C
C     ФAЗA OTPAБOTKИ  "GET" :
C
  58  NUMERR = 19
      IF(MBWCNT(0).GT.1) GOTO 2
      N1 = MBWFIR(0)
      JVATR(TYP) = KAT(TYP,N1)
      IF(JVATR(TYP).EQ.4) GOTO 5800
      JRED = 1
      NUMERR = 14
      IF ( JVPAR(ZONE).EQ.0B ) GOTO 2
      NUMERR=12
      IF(MARC.EQ.2)GOTO 2
 5800 CONTINUE
      MREZON=0
      MCOPY=N1
      ICS=0B
      ASSIGN 5820 TO MERREP
      ASSIGN 5830 TO MERSKP
 5820 CONTINUE
      IARC(8) = MAKRIW(ICHEA,KAT(ADRES,N1))
      J = JFEXCH ( IARC )
      NUMERR = J+1000
      IF(J.NE.0) GOTO 2
      NUMERR = 17
      IF (ICHEA.NE.KODHEA) GOTO 2
      NUMERR=22
      IF(JVPAR(PAROL).NE.KEYP) GOTO 2
      CALL BRAND(KEYP)
      I = JVPAR(ZONE).OR.0
 5872 CONTINUE
      DO 5801 IZON=1,10000
      MREZON=IZON
      ASSIGN 5822 TO MERREP
      ASSIGN 5823 TO MERSKP
 5822 CONTINUE
      J = KLETKA ( LBZ, IZON )
      IF ( J.EQ.0B ) GOTO 5802
      IARC(8) = MAKRIW ( LBUF, J )
      J = JFEXCH ( IARC )
      NUMERR = J+1000
      IF(J.NE.0) GOTO 2
 5823 CONTINUE
      CALL ADDCS(LBUF,ICS)
      IF(JVPAR(PAROL).EQ.0B) GOTO 5811
      DO 5810 I=1,1024
      IF(LBUF(I).EQ.'*READ') GOTO 5811
 5810 LBUF(I) = MIXER ( LBUF(I) )
 5811 NTZON = JVPAR(ZONE)+IZON-1
      IF(JVATR(TYP).NE.4) GOTO 5899
      IF(JVPAR(ZONE).NE.0B) GOTO 5899
C...  ДЛЯ OБЬEKTA TИПA OUTPUT ECЛИ HE ЗAДAHA
C     ЗOHA, TO HE ПEPEПИCЬ, A PACПEЧATKA.
      IF(IZON.NE.1) GOTO 5812
      NPAG=JVPAR(PAGE) $ IF(NPAG.EQ.0B) NPAG=-2
      CALL DIALOP(0) $ CALL NOTLIS
      CALL CPRBEG(NPAG) $ JRED=3
 5812 J = LISPRI(LBUF) $ GOTO 5801
 5899 CONTINUE
      ASSIGN 5824 TO MERREP
      ASSIGN 5801 TO MERSKP
 5824 CONTINUE
      IFIL(8) = MAKWIW ( LBUF, NTZON )
      IFIL(7) = 'W'
      J = JFEXCH ( IFIL )
      NUMERR = J+2000
      IF(J.NE.0) GOTO 2
 5801 N2 = IZON
 5802 CALL MBWCLE ( N1 )
      NUMERR=23
      MCOPY=0
      IF ( ICS.NE.ICSYM.AND.ICSYM.NE.0B ) GOTO 2
      CALL ENCOD ( 1,LEXEM )
      CALL ENCODT(MTRED(JRED),11)
      CALL ENCODB (N2,4,0)
      CALL ENCODT (' ЗOH.',5)
      CALL DIALOG (LEXEM,20,-1)
      GOTO 1
 5830 NUMERR=18
      GOTO 2
C
C     ФAЗA OTPAБOTKИ  "COPY" :
C
  59  NUMERR = 1
      IF ( MARC.EQ.0 ) GOTO 2
      NUMERR = 9
      IF ( IFIL(3).LT.10 ) GOTO 2
      ICFIL = KODCAT
      KEYFIL = ISOTEX ( KEYBEG )
      KEYFIL(2) = KEYFIL
      CALL DATE ( ID )
      CALL DTOI ( ID, IDFIL )
      IDFIL = IDFIL+32768*IFIL(3)
      N1 = 0
 590  N2 = MBWFIR ( 0 )
      IF ( N2.EQ.0 ) GOTO 591
      CALL MBWCLE ( N2 )
      N1 = N1+1
      LISCOP(2*N1-1) = KAT(ADRES,N2)
      LISCOP(2*N1) = N2
      GOTO 590
 591  CALL SHSORT ( LISCOP,N1,2,2 )
      NTZON = 1
      NZCNT = 1
      MBAD = 0
      DO 5900 IVER = 1,N1
      NZCNTS=NZCNT
 5960 CONTINUE
C...   ФOPMИPOBAHИE CTPOKИ KATAЛOГA ДЛЯ OЧEPEДHOГO OБЬEKTA
      IA = LISCOP(2*IVER-1)
      I1 = LISCOP(2*IVER)
      LISFIL(2*IVER-1) = KAT(NAMTEX,I1)
      IXAP = 64*KAT(TYP,I1)+8*KAT(LEVEL,I1)+KAT(VERS,I1)
      IXAP = LOR(KAT(DATA ,I1),LSHIFT(IXAP,-15))
      IXAP = LOR(KAT(INDEX,I1),LSHIFT(IXAP,-12))
      LISFIL(2*IVER) = LOR(LSHIFT(IXAP,-12),LAND(NTZON,7777B))
      LISFIL(2*IVER+1) = 0B
      LISFIL(2*IVER+2) = 0B
 5961 CONTINUE
C...   ПEPEПИCЬ HEADER-A :
      IARC(8) = MAKRIW(ICHEA,IA)
      MCOPY = I1
      MREZON = -1
      ASSIGN 5911 TO MERREP
      ASSIGN 5830 TO MERSKP
 5911 CONTINUE
      J = JFEXCH ( IARC )
      NUMERR = J+1000
      IF ( J.NE.0 ) GOTO 2
      NUMERR = 18
      IF ( ICHEA.NE.KODHEA ) GOTO 2
      IXHEA = LISFIL(2*IVER)
      DO 592 I=1,500
 592  LBUF(I) = LBZ(I)
      NS = -36
      NL = 1
      NZHEA=NTZON
      J=0
      IF(IFIL(1).EQ.4.AND.ICSYM.EQ.0B)J=1
      DO 593 I=1,10000
      NZ = KLETKA ( LBZ,I-1 )
      IF ( NZ.EQ.0B ) GOTO 594
      IF(I.EQ.2)NTZON=NTZON+J
      KOD = LEXOR ( NZ,NTZON+I-1 )
      KOD = LSHIFT ( LAND(KOD,7777B), NS )
      LBZ(NL) = LEXOR ( LBZ(NL),KOD )
      NS = NS+12
      IF ( NS.LE.0 ) GOTO 593
      NS = -36
      NL = NL+1
 593  NZCNT = NZCNT+1
 594  NZCNT=NZCNT+J
      IF(NZCNT.GT.IFIL(3))GOTO 5902
      IFIL(8)=MAKWIW(ICHEA,NZHEA)
      ASSIGN 5912 TO MERREP
      ASSIGN 5922 TO MERSKP
 5912 CONTINUE
      J = JFEXCH ( IFIL )
      NUMERR = J+2000
      IF ( J.NE.0 ) GOTO 2
 5922 CONTINUE
      DO 595 I= 1,500
 595  LBZ(I) = LBUF(I)
      IF(IFIL(1).NE.4.OR.ICSYM.NE.0B) GOTO 5934
C
C...  KOПИPYEM OБ'EKT БEЗ KC HA EC MЛ.
C     ЗAPEЗEPBИPYEM ПOД HEADER ДBE ЗOHЫ,
C     T.K. ПOCЛE ПEPEПИCИ OБ'EKTA ПPИДETCЯ
C     ПEPEЗAПИCATЬ HEADER.
C
      DO 5931 I=1,1024
5931  LBUF=0B
      ASSIGN 5933 TO MERSKP
      IFIL(8)=MAKWIW(LBUF,NTZON)
      J=JFEXCH(IFIL)
      NUMERR=J+2000
      IF(J.NE.0)GOTO 2
 5933 CONTINUE
 5934 ICS=0B
      NTZON = NTZON+1
C...   ПEPEПИCЬ OБЬEKTA :
      DO 5901 IZON=1,2000
      NZ=KLETKA(LBZ,IZON)
      IF ( NZ.EQ.0B ) GOTO 5905
      IARC(8) = MAKRIW ( LBUF,NZ )
      MREZON=IZON
      ASSIGN 5913 TO MERREP
      ASSIGN 5923 TO MERSKP
 5913 CONTINUE
      J = JFEXCH ( IARC )
      NUMERR = J+1000
      IF ( J.NE.0 ) GOTO 2
 5923 ASSIGN 5914 TO MERREP
      ASSIGN 5924 TO MERSKP
      CALL ADDCS(LBUF,ICS)
 5914 CONTINUE
      IFIL(8) = MAKWIW ( LBUF,NTZON )
      J = JFEXCH ( IFIL )
      NUMERR = J+2000
      IF ( J.NE.0 ) GOTO 2
 5924 NTZON=NTZON+1
 5901 CONTINUE
 5905 CONTINUE
      IF ( ICS.EQ.ICSYM ) GOTO 5900
      IF ( ICSYM.NE.0B ) GOTO 5950
C
C...  KOПИPYEMЫЙ OБ'EKT - БEЗ KOHTPOЛЬHOЙ
C     CYMMЫ.  BПИCЫBAEM  ПOДCЧИTAHHYЮ  KC
C     B HEADER И ЗAПИCЫBAEM EГO  HA  CBOE
C     MECTO.
C
      ASSIGN 5916 TO MERREP
      ASSIGN 5926 TO MERSKP
 5916 IFIL(8)=MAKRIW(ICHEA,NZHEA)
      J=JFEXCH ( IFIL )
      NUMERR=J+2000
      IF ( J.NE.0 ) GOTO 2
 5926 CONTINUE
      ICSYM=ICS
      ASSIGN 5917 TO MERREP
      ASSIGN 5927 TO MERSKP
 5917 IFIL(8)=MAKWIW(ICHEA,NZHEA)
      J=JFEXCH(IFIL)
      NUMERR=J+2000
      IF(J.NE.0)GOTO 2
 5927 CONTINUE
      GOTO 5900
 5950 CONTINUE
C
C...  H E C O B П A Д E H И E   K. C.
C
      NUMERR=23
      IF ( ITUNIT.EQ.4 ) GOTO 2
      CALL PUTH(LEXEM,'HECOBП. KC ',0,11,0,IPOZ1)
      CALL PUTH(0,KAT(NAME,MCOPY),0,8,0,IPOZ1)
      CALL PUTH(0,' (A=',0,4,0,IPOZ1)
      CALL PUTO(0,IA,0,4,0,IPOZ1)
      CALL PUTH(0,'). ЧTO ДEЛATЬ (REPEAT,SKIP,EXC',0,30,0,IPOZ1)
      CALL PUTH(0,'LUDE):',0,6,0,IPOZ1)
      CALL DIALOQ(LEXEM,63,ICAR)
      CALL SCANER (ICAR,LEXEM,1,LEXTYP,KODR,IPOZ)
      J=JSEART( 'SKIP  REPEATEXCLUD',1,3,LEXEM)
      IF ( J.EQ.0 ) GOTO 3
      IF ( J-2 ) 5900,5952,5954
 5952 NZCNT=NZCNTS
      NTZON=NZHEA
      GOTO 5961
 5954 NZCNT=NZCNTS
      NTZON=NZHEA
      IF ( IVER.EQ.N1 ) GOTO 5958
      N1=N1-1
      DO 5956 I=IVER,N1
      LISCOP(2*IVER-1)=LISCOP(2*IVER+1)
      LISCOP(2*IVER)=LISCOP(2*IVER+2)
 5956 CONTINUE
      GOTO 5960
 5958 LISFIL(2*IVER-1)=0B
      LISFIL(2*IVER)=0B
 5900 CONTINUE
      IF ( MBAD.EQ.0 ) GOTO 5903
      LISFIL(2*MBAD-1) = 0B
      LISFIL(2*MBAD) = 0B
      CALL PUTH(LEXEM,'TPEБYETCЯ ',0,10,0,J)
      CALL PUTO(0,NZCNT,0,4,0,J)
      CALL PUTH(0,' ЗOH.',0,5,0,J)
C...   З A П И C Ь   K A T A Л O Г A :
 5903 IFIL(8) = MAKWIW ( ICFIL,0 )
      J = IFIL(3) - 1
      CALL MBWDEF ( IFZFIL, 85*48 )
      DO 5904 I = NTZON,J
 5904 CALL MBWPUT (I)
      MREZON = -1
      ASSIGN 5915 TO MERREP
      ASSIGN 5925 TO MERSKP
 5915 CONTINUE
      J = JFEXCH ( IFIL )
      NUMERR = J+2000
      IF ( J.NE.0 ) GOTO 2
 5925 CONTINUE
      IF ( MBAD.EQ.0 ) GOTO 1
      CALL DIALOG('KOПИPOBAHИE ПPEKPAЩEHO (MAЛO MECTA).',36,-1)
      CALL DIALOG(LEXEM,19,-1)
      GOTO 1
 5902 IF ( MBAD.EQ.0 ) MBAD=IVER
      GOTO 5900
C
C     ФAЗA OTPAБOTKИ  "INFORM" :
C
  60  CALL DIATEX ( 6 )
      CALL DIALOP ( 6 )
      CALL ITOD ( IDCAT,INFHEA(7) )
      CALL DIALOG ( INFHEA,62,-1 )
      CALL ENCOD ( 0,LEXEM )
      CALL ENCODT( '*',1 )
      CALL PUTBL ( 17 )
      CALL ENCODT( 'BCEГO:',6 )
      CALL MBWDEF ( ACCZ,85*48 )
      CALL MBWLDA ( IFZARC )
      N2 = MBWCNT ( 0 )
      N1 = LSHIFT ( IDCAT,15 )
      CALL ENCODB ( N1,4,0 )
      CALL PUTBL ( 3 )
      CALL ENCODT ( 'CBOБOДHO:',9 )
      CALL ENCODB ( N2,4,0 )
      CALL PUTBL ( 17 )
      CALL ENCODT ( '*',1 )
      CALL DIALOG ( LEXEM,62,-1 )
      INFHEA(19) = ' '
      IF(IARC(10).EQ.0 .OR. MPRI.NE.1) INFHEA(19) = 'K-BO'
      CALL DIALOG ( INFHEA(13),62,-1 )
      KSZON = 1
      DO 608 I=1,12
 608  LEXEM(I) = '******'
      CALL DIALOG ( LEXEM,62,-1 )
      CALL MBWDEF ( ACC,480 )
      CALL MBWLDA ( NRELS )
      N1=0
      J=ADRES
      IF(IARC(10).NE.0.AND.MPRI.NE.1) GOTO 61
      IF(JVPAR(SORTIR).NE.2) J=NAME
  61  N2 = MBWFIR(0)
      IF(N2.EQ.0) GOTO 62
      CALL MBWCLE(N2)
      N1=N1+1
      LISCOP(2*N1-1) = KAT(J,N2)
      LISCOP(2*N1) = N2
      GOTO 61
  62  CALL SHSORT(LISCOP,N1,2,0)
  63  DO 600 ILSORT=1,N1
      I = LISCOP(2*ILSORT)
      INTER = 0
      ICAR = 6H
      LET = '*' $ IF(MPRI.NE.1) LET = '****'
      CALL ENCOD  ( 0,LEXEM )
      CALL ENCODT ( LET,6 )
      CALL ENCODI ( I,3 )
      CALL ENCODT ( '.',1 )
      CALL ENCODI ( KAT(LEVEL,I),1 )
      CALL ENCODT ( '.',1 )
      CALL ENCODI ( KAT(VERS,I),1 )
      CALL PUTBL ( 2 )
      CALL ENCODT ( KAT(NAME,I),8 )
      CALL PUTBL ( 2 )
      LET = 6H
      IF ( KAT(INDEX,I).EQ.0 ) GOTO 602
      LET = 64 + KAT(INDEX,I)
      LET = LOR(LSHIFT(LET,-40),LSHIFT('.',8))
 602  CALL ENCODT ( LET,2 )
      J = 1+KAT(TYP,I)
      LET = ' '  $ IF(J.EQ.2 .OR. J.EQ.3) LET = 'Y'
      CALL ENCODT ( NAMTYP(J),6 )
      CALL ENCODT ( LET,4 )
      CALL PUTBL ( 5 )
      CALL ITOD ( KAT(DATA,I),ID )
      CALL ENCODT ( ID,8 )
      CALL PUTBL ( 2 )
      CALL ENCODB ( KAT(ADRES,I),5,0 )
      CALL PUTBL ( 4 )
      IF(MPRI.EQ.1 .OR. MPRIF.LT.6) CALL ENCODT('*',1)
      CALL PUTBL ( -72 )
      IARC(8) = MAKRIW(ICHEA,KAT(ADRES,I))
      IF ( INFHEA(19).EQ.' ' ) GOTO 603
      J = JFEXCH ( IARC )
      NUMERR=J+1000
      IF(J.NE.0)GOTO 2
      NUMERR = 18
      IF (ICHEA.NE.KODHEA) GOTO 2
      CALL PUTO ( LEXEM(7),LOB,0,4,0,IPOZ )
      J = LOB.AND.777B.OR.0
      KSZON = KSZON + J + 1
 603  CALL DIALOG ( LEXEM,62,-1 )
      IF ( MPRI.EQ.1 ) GOTO 601
      NWT7(1) = 4 4000 0000 B
      NWT7(2) = 0B
      NWT7(3) = 0B
      MAXLS  = 0B
      MAXKS  = 0B
      CALL TEXOUT ( ITEXT )
 601  IF ( INTER.EQ.2 ) GOTO 1
      IF ( LSHIFT(LEXOR(ICAR,'END'),24).EQ.0B ) GOTO 1
 600  CONTINUE
      DO 609 I=1,11
 609  LEXEM(I) = '******'
      IF(KSZON.EQ.1) GOTO 610
      LEXEM(5) = ' ЗAHЯT'
      LEXEM(6) = 'O ЗOH:'
      CALL PUTO(LEXEM(7),KSZON,0,4,0,IPOZ)
 610  CALL DIALOG ( LEXEM,62,-1 )
      GOTO 1
C
C
C      ФAЗA OTPAБOTKИ  "TEXOUT" :
C
  22  MPRI = 10
      NZREL = JVPAR (ZONE)
      NUMERR = 19
      IF ( NZREL.NE.0B ) GOTO 622
      MPRI = 0
      NZREL = LOR(0,JVPAR(KVANT))
      IF (KOBJR.GT.1) GOTO 2
      IARC(8) = MAKRIW(ICHEA,KAT(ADRES,KOBJR))
      J = JFEXCH(IARC)
      NUMERR = 18
      IF (ICHEA.NE.KODHEA) GOTO 2
      DO 1622 I=1,512
 1622 LBUF(I)=ITEXT(I)
      IF(NZREL.EQ.0) GOTO 623
 622  IA = NZREL
      IF(MPRI.EQ.0) IA=KLETKA(LBZ,IA-1)
      NUMERR = 11
      IF(IA.EQ.0B) GOTO 2
      IARC(MPRI+8) = MAKRIW(LBUF,IA)
      J = JFEXCH( IARC(MPRI+1) )
 623  NWT7(1)=0B
      NWT7(2)=0B
      NWT7(3)=0B
      MAXLS  =0B
      MAXKS  =0B
      INTER = 0
      ICAR  = 0
      CALL TEXOUT ( LBUF )
      IF(LSHIFT(LEXOR(ICAR,'NEXT'),24).NE.0B) GOTO 1
      NZREL = NZREL + 1
      GOTO 622
      END
       SUBROUTINE ASCOPY(K,S)
C*
C****   24.5.82   A.П.CAПOЖHИKOB
C*
C*   SUBROUTINE ASCOPY(K,S)
C*   SUBROUTINE ASCOPC(K,S)
C*   KOПИPOBAHИE TEKCTOBЫX ФAЙЛOB БЭCM-6
C*   HA ЛEHTЫ EC B KOДE ASCII.
C*   USER - SUBROUTINE PEДAKTOPA TEKCTOB
C*   ASCOPY - BЫXOДHAЯ MЛ ПPEДBAPИTEЛЬHO
C*            ПEPEMATЫBAETCЯ HA HAЧAЛO
C*   ASCOPC - БEЗ ПEPEMOTKИ (ДOЗAПИCЬ).
C*   BЫXOДHAЯ ЛEHTA ЗAKAЗЫBAETCЯ ПOД N 1
C*      *TAPE:<N БOБ>/NO CHECK,F1,W
C*   ЗAПИCЬ ПPOИЗBOДИTCЯ БЛOKAMИ ПO
C*   1024 CЛOBA БЭCM-6  (6144 БAЙTA).
C*   KAЖДЫЙ БЛOK COДEPЖИT 75 80-CИMB.
C*   ПEPФOKAPT, ПOCЛEДHИE 144 БAЙTA БЛOKA
C*   HE ИCПOЛЬЗYЮTCЯ. ПPИЗHAK KOHЦA TEKCTA
C*    - KAPTA  *READ OLD
C*   ЗA ПOCЛEДHИM БЛOKOM BCEГДA ПИШETCЯ
C*    E O F .
C*
      DIMENSION K(14),M(1024)
      DATA NS/0/,NR/-1/,LUN/1/
C---
      MREW=1
      GOTO 1
      ENTRY ASCOPC
      MREW=0
  1   IF(NR.GE.0) GOTO 2
      IF(MREW.EQ.1) J=MT9(LUN,7)
      NR=0
  2   DO 3 I=1,80
      LET=LAND(377B,IGETS(K,I-1))
      LET=LOR(LET,LSHIFT(LCNT(LET),-7))
      CALL IPUTS(LET,M,NS)
  3   NS=NS+1
      IF(K(1).EQ.'*READ' .AND. K(2).EQ.'OLD') NS=999999
      IF(NS.LT.5999) GOTO 4
      J = MT9A(LUN,12,M)
      NR=NR+1
      IF(NS.EQ.999999) J=MT9(LUN,9)
      NS1=NS
      NS=0
      IF(NS1.NE.999999) GOTO 4
      CALL PUTH(M,' HA ЛEHTY ',0,10,0,IPOZ)
      CALL PUTG(0,  LUN,       0, 2,0,IPOZ)
      CALL PUTH(0,' ЗAПИCAHO ',0,10,0,IPOZ)
      CALL PUTG(0,  NR,        0, 5,0,IPOZ)
      CALL PUTH(0,' БЛOKOB ПO 6000 CИMB.',0,21,0,IPOZ)
      CALL PRIN(M,M(8),14B)
      NR=-1
  4   CALL S(K)
      RETURN
      END
       SUBROUTINE BTLOOK
C*
C*********  5.11.82   A.П.CAПOЖHИKOB
C*
C*     ИCПOЛHИTEЛЬHAЯ ЧACTЬ ПPOГPAMMЫ ПPOCMOTPA
C*         COДEPЖИMOГO  ЛEHTЫ/ФAЙЛA.
C*            ( CM. ИCKATEЛЬ )
C*
C*     ДИPEKTИBA: REGIM=MAN  - ПOCЛOBHAЯ PAБOTA
C*
      COMMON /PROTO/ IAP,NUN,NL,NF,INT,K(20)
      COMMON /UNIT/ LTYP,LMN,LVOL,LDIA(3),LREG,LINF
      COMMON /CHARM/ MCHAR
      COMMON /NAME/ NAME(2),NSIG
      COMMON /P/ LIST1(1024),LIST(1024)
      DATA NL/15/
      DIMENSION MF(20),KK(20)
      DATA MBREC/6000 0000 0000 0000B/
      DATA MEOF/3000 0000 0000 0000B/
      DIMENSION MZEND(3),MWEND(3)
      DATA MZEND/'Ь','И','EЙ'/
      DATA MWEND/'O.','A.','.'/
C
C--
C
      MENT=1
  1   CALL DIALOQ('ПPOCMOTP ЛEHTЫ/ФAЙЛA : ',23,K)
      LMN = 0B
      LREG= 0B
      LVOL=0
      J=JFOCC(K,LTYP)
      IF(J.EQ.0) GOTO 3
      CALL DIALOG(LDIA,18,-1)
      IF(NUN.NE.4) GOTO 1
  2   RETURN
C
C--      BXOД: TOM YЖE ЗAKAЗAH
C
      ENTRY BTL1
      MENT=2
  3   NZ = 0
      NZOLD = -1
      NRELZ = 0
      NEW = 1
      JSTAT = 2
      IF(LVOL.EQ.0) LVOL=512
      IF(NUN.EQ.4) GOTO 10
      ASSIGN 10 TO M300
      GOTO 310
C
C--     БЛOK ПEPEXOДA K CЛEДYЮЩEЙ ЗOHE
C       BOЗBPAT:  M10
C
  4   NZ=NZ+1
      IF(NZ.GE.LVOL) GOTO 2
C
C--     ЧTEHИE ЗOHЫ  NZ
C       ПPИ NEW=0  BЫXOД ПO M10
C       ПPИ NEW=1  PACПOЗHABAHИE TИПA И
C       BЫXOД ПO ПEPEKЛЮЧATEЛЮ TИПA.
C
  10  KEX=JFEX1(LTYP,LIST,NZ,'READ')
      NRELZ=NRELZ+1
  13  KK(2)=' ЗOHA='
      KK(1)='****'
      KK(4)=' '
      KK(5)='HE ЧИT'
      KK(6)='AETCЯ.'
      KK(7)=' '
      KK(8)=' '
      KK(9)=' '
      KK(10)=' '
      CALL PUTO(KK(3),NZ,0,4,0,IPOZ)
      NZTYP=1
      LDAT=0
      IPOZ=60
      IF(KEX.NE.0) GOTO 11
      LDAT=LOR(0,LAND(37777B,LSHIFT(LDIA(3),11)))
      KK(4)=' ДATA='
      CALL ITOD(LDAT,KK(5))
      NZTYP=2+INFTYP(LIST)
  11  IF(NEW.EQ.0) GOTO M10,(121,110)
      NEW=0
      NRELZ=0
      NZTYP1=NZTYP
      MCHAR1=MCHAR
      LDAT1=LDAT
      GOTO (110,120,130,140,150,160,170,180,190) NZTYP
C
C--     ЗOHA HE ЧИTAETCЯ
C
 110  ASSIGN 4 TO M300
      NEW=1
      GOTO 300
C
C--     OБHAPYЖEH TEKCT
C
 120  KK(7)=' TEKCT'
      IPOZ=60
      ASSIGN 121 TO M10
      ASSIGN 121 TO M300
      ASSIGN 110 TO M14
      GOTO 300
 121  JL=1
      IPOZ=60
      ASSIGN 122 TO M300
      IF(NZTYP.NE.NZTYP1) GOTO 127
      IF(MCHAR.NE.0) NEW=1
 122  IF(JL.GT.1024) GOTO 14
      JK=1
 123  K(JK)=LIST(JL)
      JL=JL+1
      IF(LAND(377B,LEXOR(K(JK),12B)).EQ.0B) GOTO 124
      JK=JK+1
      IF(JL.LE.1024) GOTO 123
      K(JK)=LEXOR(' ',52B)
      IF(MCHAR.EQ.2) K(2)=LEXOR('OLD',52B)
 124  J=ISUNP(K,KK(3))
      KK(1)=KK(15)
      KK(2)=LEXOR(KK(16),LAND(377 7777 7777B,LEXOR(KK(16),' ')))
      J=LREGIM(0)
      IF(KK(3).EQ.'*READ'.AND.KK(4).EQ.'OLD') JL=2000
      IPOZ=60
      GOTO (125,126,126,300) J
C
C--      B PEЖИME *NO LIST  BЫДAEM TOЛЬKO YПP.KAPTЫ
C        *STAND   - YПP.KAPTЫ + HEAD LIST
C        *FULL LIST  - BЫДAEM BCE
C
 126  CALL HEADLP(KK(3))
      IF(NSIG.NE.0) GOTO 300
 125  IF(LSHIFT(LEXOR(KK(3),'*'),40).EQ.0B) GOTO 300
      GOTO 122
C
C--      HOPMAЛЬHЫЙ KOHEЦ OБЬEKTA
C
  14  IF(NEW.EQ.0) GOTO 4
      NRELZ=NRELZ+1
      CALL PUTH(KK,'ДЛИHA OБЬEKTA = ',0,16,0,IPOZ)
      CALL PUTO(0,NRELZ,0,4,0,IPOZ)
      CALL PUTH(0,' ЗOH.',0,5,0,IPOZ)
      GOTO M14,(110,200)
C
C--      TEKCT OБOPBAЛCЯ
C
 127  CALL PUTH(KK,'ИCПOPЧEHO B ',0,12,0,IPOZ)
      CALL PUTO(0,NZ,0,4,0,IPOZ)
      IF(NZTYP1.NE.9) NZ=NZ-1
 200  NEW=1
      ASSIGN 13 TO M300
      IF(NZTYP.NE.2) ASSIGN 4 TO M300
C
C
C--     БЛOK BЫДAЧИ HA TEPMИHAЛ  IPOZ  CИMBOЛOB
C       MACCИBA  KK .  OПPOC : HE БЫЛO ЛИ ПPИKAЗA
C       HA CMEHY PEЖИMA.   BЫXOД ПO  M300.
C
 300  CALL DIALOG(KK,IPOZ,-1)
      NZOLD=NZ
      IF( JSTAT.NE.3 ) GOTO 301
      IF(NZTYP1.EQ.3) NZ=NZ-1
      CALL W1LOOK(NZ)
      INT=1 $ NEW=1
 301  ITYP=5
      MF=0
      IF(INT.NE.0) CALL SCANER(K,MF,3,ITYP,KODR,IPOZ1)
 311  INT=0
      IF(ITYP.EQ.5) GOTO 313
      NATR=MF
      MF=0
      CALL SCANER(0,MF,3,ITYP,KODR,IPOZ1)
      J = JSEART('ZONE  REGIM EXIT',1,3,NATR)
      IF(J.NE.0) GOTO (303,304,2) J
      IF(MENT*JSEART('NEW',1,1,NATR).EQ.1) GOTO 1
 302  CALL DIALOQ('OШИБKA. ПOBTOPИTE ЗAKAЗ CMEHЫ PEЖИMA : ',39,K)
      INT=1
      GOTO 301
 303  IF(ITYP.EQ.2) MF=IOCTAL(MF)
      IF(ITYP.NE.1.AND.ITYP.NE.2) GOTO 302
      NZ1=LOR(0,MF)
      IF(NZ1.GE.LVOL) GOTO 302
      NZ=NZ1
      NZOLD=-1
      GOTO 310
 304  J = JSEART('*NOLIS*STANDMAN   *FULLL',1,4,MF)
      IF(J.EQ.0) GOTO 302
      JSTAT = J
      IF(J.NE.3)  J=LREGIM(J)
C--      BXOД ИЗ HAЧ.YЧACTKA ПPOГPAMMЫ
 310  MF=0
      CALL SCANER(0,MF,3,ITYP,KODR,IPOZ1)
      GOTO 311
 313  IF(NZOLD.EQ.NZ) GOTO M300,(10,121)
      NEW=1
      GOTO 10
C
C
C
C--      OБHAPYЖEHA  LIBRARY
C
 130  CONTINUE
      KKK=KK(3)
      DO 131 I=1,1024
 131  LIST1(I)=LIST(I)
      ASSIGN 200 TO M14
      ASSIGN 132 TO M10
      GOTO 4
C---      ПPOБA HA KOHEЦ LIBRARY
 132  IF(NRELZ.GE.MCHAR1) GOTO 139
      IF(NZTYP.EQ.1) GOTO 110
C---      ПPOБA HA TOЖДECTBEHHOCTЬ ДATЫ
      LD=IABS(LDAT1-LDAT)
      IF(LD.LE.1) GOTO 133
      IF(LDAT1.EQ.0) GOTO 133
      IF(NRELZ.NE.1) GOTO 127
      KK(3)=KKK
      GOTO 154
C---     ПOCЛE ЧTEHИЯ 1-Й ЗOHЫ AHAЛИЗ KATAЛOГA
 133  IF(NRELZ.NE.1) GOTO 4
      KK(3)=KKK
      JL=1
C---     ПEPEBOД KATAЛOГA B ISO
 134  CALL TEXISO(LIST1(JL+2),LIST1(JL))
      JL=JL+2
      IF(LSHIFT(LIST1(JL+1),15).EQ.0B)
     *          LIST1(JL-1)=LEXOR(LIST1(JL-1),3120 0000B)
      IF(LIST1(JL).NE.0B) GOTO 134
      IF(LIST1(JL+1).NE.7777 7777 7777 7777B) GOTO 154
C---     ИЗBЛEЧEHИE KOMMEHTAPИЯ
      JL=JL+2
      IF(LIST1(JL).EQ.'LIBRAR') ASSIGN 135 TO M300
      IF(LIST1(JL).EQ.'LIBRAR') GOTO 300
      KK(7)='OБCП'
      KK(8)='OT'
      KK(9)=LIST1(JL)
      ASSIGN 400 TO M300
      GOTO 300
 135  KK(1)=' '
      DO 136 I=1,9
 136  KK(I+1)=LIST1(JL+I-1)
      ASSIGN 400 TO M300
      GOTO 300
C---     ПPOЧИTAHA ЛИШHЯЯ ЗOHA
 139  NEW=1 $ NZ=NZ-1
      NRELZ=NRELZ-1
      ASSIGN 200 TO M14
      GOTO 14
C---     BЫДAЧA KATAЛOГA ПPИ LREGIM>*NO LIST
 400  IPOZ=60
      KK(1)=' '
      KK(2)=' '
      IF(LREGIM(0).EQ.1) GOTO 4
      JL=1
      ASSIGN 401 TO M300
 401  IF(LIST1(JL).EQ.' ') GOTO 4
      IF(LREGIM(0).EQ.1) GOTO 4
      DO 402 I=3,10
 402  KK(I)=' '
      DO 403 I=1,7,2
      KK(I+2)=LIST1(JL+I-1)
      KK(I+3)=LIST1(JL+I)
      IF(KK(I+2).EQ.' ') ASSIGN 4 TO M300
      IF(KK(I+2).EQ.' ') GOTO 300
 403  CONTINUE
      JL=JL+8
      GOTO 300
C
C--      OБHAPYЖEH  OVERLAY
C
 140  CONTINUE
      JL=1
 141  CALL TEXISO(LIST(JL),LIST1(JL))
      JL=JL+2
      IF(LIST(JL-2).NE.0B) GOTO 141
      ASSIGN 142 TO M300
      GOTO 300
C---     BЫДAЧA KOMMEHTAPИЯ
 142  KK(1)=' '
      DO 143 I=1,9
 143  KK(I+1)=LIST(I+1010)
      ASSIGN 400 TO M300
      ASSIGN 144 TO M10
      GOTO 300
C---     ЧTEHИE TEЛA OVERLAY'A
 144  IF(NRELZ.GE.MCHAR1) GOTO 139
      IF(NZTYP.EQ.1) GOTO 110
      LD=IABS(LDAT1-LDAT)
      IF(LD.GT.1.AND.LDAT1.NE.0) GOTO 127
      GOTO 4
C
C--      HEOПOЗHAHHAЯ ЗOHA
C
 150  CONTINUE
      ASSIGN 110 TO M14
 154  CALL PUTH(KK(7),'BIN: ',0,5,0,IPOZ)
      CALL PUTO(0,LIST,0,16,4,IPOZ)
      IPOZ=IPOZ+36
      GOTO M14,(110,200)
C
C--      ЗOHA ФAЙЛA BЫBOДA
C
 160  CONTINUE
      ASSIGN 161 TO M10
      ASSIGN 161 TO M300
      CALL PUTH(KK(7),'ЛИCTИHГ:',0,8,0,IPOZ1)
      CALL PUTO(0,MCHAR1,0,2,0,IPOZ1)
      GOTO 300
 161  IF(NZTYP1.NE.NZTYP) GOTO 139
      IF(MCHAR1.NE.MCHAR) GOTO 139
      GOTO 4
C
C--      OБHAPYЖEHA  COMMON LIBRARY
C
 170  CONTINUE
      ASSIGN 171 TO M10
      ASSIGN 4 TO M300
      KK(7)='COMMON'
      GOTO 300
 171  IF(NRELZ.GE.MCHAR1) GOTO 139
      IF(NZTYP.EQ.1) GOTO 110
      LD=IABS(LDAT1-LDAT)
      IF(LD.LE.1) GOTO 4
      GOTO 127
C
C--      ЗOHA ФAЙЛA ПPЯMOГO ДOCTYПA
C
 180  CONTINUE
      ASSIGN 181 TO M10
      ASSIGN 4 TO M300
      KK(7)='ФAЙЛ П'
      KK(8)='PЯMOГO'
      KK(9)=' ДOCTY'
      KK(10)='ПA.'
      IF(MCHAR1.EQ.0) GOTO 300
      ASSIGN 181 TO M300
      MCHAR1=0
      GOTO 300
 181  IF(NZTYP.NE.NZTYP1) GOTO 139
      IF(MCHAR.EQ.MCHAR1) GOTO 4
      IF(LREGIM(0).EQ.1) GOTO 4
      ASSIGN 4 TO M300
      KK(1)=' '
      KK(3)=' '
      KK(4)=MCHAR
      CALL PUTO(KK(2),NZ,1,4,0,IPOZ)
      IPOZ=24
      GOTO 300
C
C--      OБHAPYЖEH ФOPTPAHHЫЙ ФAЙЛ
C
 190  CONTINUE
      ASSIGN 200 TO M14
      ASSIGN 191 TO M10
      ASSIGN 191 TO M300
      KLEN=0
      ISEOF=0
      ISBL=0
      KK(7)='ФOPTPA'
      KK(8)='HHЫЙ'
      KK(9)='ФAЙЛ.'
      GOTO 300
 191  JL=10
      IF(NZTYP1.EQ.NZTYP) GOTO 192
      NEW=1
      ASSIGN 14 TO M1190
      IF(ISEOF.EQ.0) ASSIGN 127 TO M1190
C---      ДOCБPOC ПOCЛEДHEГO COOБЩEHИЯ
 1190 IF(KLEN.NE.0) GOTO 1192
 1191 IPOZ=60
      GOTO M1190,(14,127)
 1192 CALL PUTH(KK,' ',0,6,0,IPOZ)
      CALL PUTG(0,KLEN,0,5,0,IPOZ)
      CALL PUTH(0,' ЗAПИC',0,6,0,IPOZ)
      CALL PUTH(0,MZEND(NUMFOR(KLEN)),0,2,0,IPOZ)
      CALL PUTH(0,' ДЛИHOЙ ',0,8,0,IPOZ)
      CALL PUTG(0,LEN,0,5,0,IPOZ)
      CALL PUTH(0,' CЛOB',0,5,0,IPOZ)
      CALL PUTH(0,MWEND(NUMFOR(LEN)),0,2,0,IPOZ)
      KLEN=0
      IF(LREGIM(0).EQ.1) GOTO 1191
      ASSIGN 1191 TO M300
      GOTO 300
C---     ПPOБA ПEPBOГO CЛYЖ.CЛOBA
 192  IF(LIST(JL+1).NE.MEOF) GOTO 195
      ASSIGN 193 TO M1190
      GOTO 1190
 193  CALL PUTH(KK,'   END FILE',0,12,0,IPOZ)
      ISEOF=1
      ISBL=0
      ASSIGN 194 TO M300
      ASSIGN 200 TO M14
      IF(LREGIM(0).EQ.1) GOTO 194
      GOTO 300
 195  NZTYP=-1
      ASSIGN 110 TO M14
      IF(LIST(JL+1).EQ.0B) GOTO 196
      IF(LIST(JL+1).NE.MBREC) GOTO 191
      ISEOF=0
      ISBL=1
C---     ПPOБA BTOPOГO CЛYЖ.CЛOBA
 196  LEN1=LOR(0,LIST(JL+26))
      IF(LEN1.EQ.0) GOTO 194
      IF(ISBL.EQ.0) GOTO 191
      IF(KLEN.EQ.0) GOTO 197
      ASSIGN 197 TO M1190
      IF(LEN1.NE.LEN) GOTO 1190
C---     PEГИCTPAЦИЯ OЧEPEДHOЙ ЗAПИCИ
 197  LEN=LEN1
      KLEN=KLEN+1
      ISBL=0
C---     ПPOДBИЖKA HA CЛEДYЮЩИЙ KBAHT
 194  JL=JL+26
      IPOZ=60
      IF(JL.LT.1020) GOTO 192
      GOTO 4
      END
      SUBROUTINE COSYPR(LINE)
C*
C****  11.5.85    A.П.CAПOЖHИKOB
C*
C*    SUBROUTINE COSYPR(LINE)
C*  - ПEЧATЬ CTPOKИ  LINE  ИЗ ФAЙЛA BЫBOДA
C*    CTPOKA OФOPMЛEHA ПO ПPABИЛAM  COSY-GOST
C*    T.E.  1 БAЙT = ЧИCЛO ПPOTЯЖEK ПEPEД
C*    ПEЧATЬЮ, ДAЛEE TEKCT B KOДE GOST,
C*    ПPИЧEM  N+1 ПPOБEЛOB KOДИPOBAHЫ
C*    БAЙTOM "177+N".  CИMBOЛ "176" - KOHEЦ.
C*
C*    SUBROUTINE CPRBEG(NP)
C*  - YCTAHOBOЧHOE OБPAЩEHИE.
C*    MOДYЛЬ NP ЗAДAET HOMEP ПEPBOЙ ПEЧATAEMOЙ
C*    CTPAHИЦЫ ЛИCTИHГA.  ECЛИ NP<0, HYMEPAЦИЯ
C*    CTPAHИЦ HE ПPOИЗBOДИTCЯ.
C*
      DIMENSION NUM(2),KODP(2)
      DATA LF/0/
C------------------
      NT=LINE.SHIFT.40.OR.0
      LINE=LINE.AND.0017 7777 7777 7777B
      IF(LF.NE.0) GOTO 1
      CALL NEWLIS
      NT=0 $ NPAG=0 $ LF=1
      NLOLD=4 $ NSTR=4
  1   NSTR=NSTR+NT
      IF(NPAG.EQ.0) GOTO 2
      IF(NSTR.LT.72) GOTO 10
      NSTR=NSTR-72 $ IF(NSTR.GE.72) NSTR=NSTR-72
      NT=74-NLOLD $ NEWP=72
  2   NPAG=NPAG+1 $ IF(NPAG-NPGIV) 999,3,4
  3   NT=0
  4   IF(NSTR.LT.4) GOTO 10
      NUM(1)=' ' $ NUM(2)=' '
      IF(LNUM.EQ.0) GOTO 5
      CALL PUTG(NUM,2*NPAG-1,0,3,0,IP)
      CALL PUTH(0,4040 0000 0000 0000B,0,1,0,IP)
      CALL PUTG(0,2*NPAG,1,3,0,IP)
  5   CALL IPUTS(NT,KODP,0)
      CALL IPUTS(273B,KODP,1)
      DO 6 I=1,7
      LET=IGETS(NUM,I-1)
      IF(LET.EQ.32) LET=128
      IF(LET.LT.60) LET=LET-48
  6   CALL IPUTS(LET,KODP,I+1)
      DO 7 I=9,11
  7   CALL IPUTS(176B,KODP,I)
      J=LOCF(KODP).SHIFT.-24.OR.100 0000 0000 0000B
      J=JEXTRI(0,64B,J)
      NLOLD=2 $ NEWP=0
  10  IF(NPAG.LT.NPGIV) GOTO 999
      NT=NSTR+NEWP-NLOLD
      NEWP=0 $ NLOLD=NSTR
      LINE=NT.SHIFT.-40.OR.LINE
      J=LOCF(LINE).SHIFT.-24.OR.100 0000 0000 0000B
      J=JEXTRI(0,64B,J)
 999  RETURN
      ENTRY CPRBEG
      LF=0 $ NPGIV=IABS(LINE)
      LNUM=0 $ IF(LINE.GT.0) LNUM=1
      RETURN
      END
      SUBROUTINE CTLOOK
C*
C*******  8.12.81.  A.П.CAПOЖHИKOB
C*
C*   ПPOГPAMMA ДЛЯ ПPOCMOTPA C TEPMИHAЛA
C*   COДEPЖИMOГO ЛEHTЫ, ЗAПИCAHHOЙ HA ЭBM
C*   CDC-6500 ПO  COPYBF.
C*   OБPAЩEHИE :  *CALL CTLOOK
C*   ЛEHTA ДOЛЖHA БЫTЬ ЗAKAЗAHA ПOД HOM.1 :
C*            *TAPE:1/NO CHECK,F1,R,H
C*   ПЛOTHOCTЬ ЗAПИCИ 800 БИT/ДЮЙM.
C*
C*   B ПPOЦECCE ПPOCMOTPA MOЖHO KOПИPOBATЬ
C*   ИHФOPMAЦИЮ HAЧИHAЯ C TEKYЩEГO БЛOKA MЛ.
C*   ДЛЯ ЭTOГO CYЩECTBYET ПPИKAЗ  COPY :
C*    COPY TEXT <KYДA>  - ПEPEПИCЬ TEKCTA
C*    COPY DATA <KYДA>  - ПEPEПИCЬ ДAHHЫX
C*   <KYДA> - ДECKPИПTOP ЛEHTЫ/ФAЙЛA БЭCM6
C*   OФOPMЛEHHЫЙ ПO ПPABИЛAM ФYHKЦИИ JFOCC
C*   (CM.OПИCAHИE JFOCC).
C*   B CЛYЧAE ПEPEПИCИ TEKCTA MOЖHO ЗAДATЬ
C*   HAЧAЛЬHYЮ ЗOHY (B CKOБKAX ПOCЛE <KYДA>)
C*   ПPИMEP:  COPY TEXT T1/WORKIN(40)
C*   B CЛYЧAE ПEPEПИCИ ДAHHЫX MOЖHO ЗAДATЬ
C*   ПAPAMETP CONT - ПPИЗHAK ДOЗAПИCИ :
C*   ПPИMEP:  COPY DATA D664/SYS,BOSS,N CONT
C*   TOГДA HOBЫЙ ФAЙЛ ДAHHЫX ЗAПИШETCЯ ПOCЛE
C*   ПPEДЫДYЩEГO  EOF.
C*
C*   ЛEHTA/ФAЙЛ ДЛЯ ПEPEПИCИ BCEГДA
C*   ПOДЗAKAЗЫBAETCЯ ПOД HOMEPOM 2.
C*
C*   KPATKAЯ ИHCTPYKЦИЯ ПO ПOЛЬЗOBAHИЮ
C*   BЫДAETCЯ HA TEPMИHAЛ B HAЧAЛE CEAHCA,
C*   A TAKЖE ПO ПPИKAЗY  TEACH.
C*
      DIMENSION MISO(64)
      DATA MISO / 1H:,1HA,1HB,1HC,1HD,1HE,1HF,1HG,1HH,1HI,
     1            1HJ,1HK,1HL,1HM,1HN,1HO,1HP,1HQ,1HR,1HS,
     2            1HT,1HU,1HV,1HW,1HX,1HY,1HZ,1H0,1H1,1H2,
     3            1H3,1H4,1H5,1H6,1H7,1H8,1H9,1H+,1H-,1H*,
     4            1H/,1H(,1H),1H$,1H=,1H ,1H,,1H.,1H#,1H[,
     5            1H],1H%,1H",1H_,1H!,1H&,1H',1H?,1H<,1H>,
     6            1H@,1H\,1H^,1H; /
      DIMENSION MF(10),M(1030)
      DIMENSION MJOB(5),MK(14)
      DATA(MJOB='READ','STOP','TEACH','WORDS','REWIND')
      DATA LUN/1/, NTEK/0/, IS/0/
       DIMENSION MCSYM(8,640)
       DIMENSION KUNP(100)
      COMMON /ICHECK/ IC(6)
      DATA IC/1,0,0,0,0,0/
      DATA NFIL/0/
      COMMON / PROTO / AP,NUNIT,NLIN,NFREE,INTER,K(20)
      DATA NUNIT/2/,NLIN/15/,INTER/-1/
C
C----------------------------------------------
C
      CALL DIALOP(1)
      J=MT9(LUN,7)
  1   CALL QOUT('KOMAHДЫ CTLOOK:',15)
      CALL QOUT('REWIND - ПEPEMOTKA ЛEHTЫ B HAЧAЛO.              ',48)
      CALL QOUT('READ N - ЧTEHИE N-ГO БЛOKA ЛEHTЫ (N=1,2,3,...)  ',48)
      CALL QOUT('   READ  БEЗ ПAPAMETPA - ЧTEHИE CЛEДYЮЩEГO БЛOKA',48)
      CALL QOUT('TEACH  - BЫДAЧA ШПAPГAЛKИ.                      ',48)
      CALL QOUT('STOP   - KOHEЦ PAБOTЫ.                          ',48)
      CALL QOUT('WORDS N1-N2  - BЫДAЧA 60-PAЗPЯДHЫX CЛOB CDC-6500',48)
      CALL QOUT('   C N1-ГO ПO N2-E B PAЗHЫX BИДAX.              ',48)
      CALL QOUT('MOДИФИKAЦИЯ:  WORDS N   - BЫДAЧA N-ГO CЛOBA     ',48)
      CALL QOUT('COPY TEXT <ИMЯ ЛEHTЫ>   -  ПEPEПИCЬ TEKCTA',42)
      CALL QOUT('COPY DATA <ИMЯ ЛEHTЫ>   -  ПEPEПИCЬ ДAHHЫX',42)
  5   CALL DIALOQ('JOB:',5,1)
      CALL SCANER(K,MF,0,ITYP,KOD,IPOZ)
      IF(ITYP.NE.4) GOTO 77
      IF(JSEART('COPY',1,1,MF).NE.0) GOTO 399
      J=JSEART(MJOB,1,5,MF)
      IF(J.EQ.0) GOTO 77
      CALL SCANER(0,MF,0,ITYP,KOD,IPOZ)
      N1=0
      N2=0
      IF(ITYP.EQ.5) GOTO 3
      IF(ITYP.NE.2) GOTO 77
      N1=MF
      CALL SCANER(0,MF,0,ITYP,KOD,IPOZ)
      IF(ITYP.EQ.5) GOTO 3
      IF(ITYP.NE.2) GOTO 77
      N2=MF
  3   IF(N2.EQ.0) N2=N1
      GOTO (12,100,1,14,11) J
 100  CALL DIALOG('ДO CBИДAHИЯ.',12,-1)
      CALL DIALOP(0)
      STOP
  77  CALL DIALOG('OШ.KOMAHДA',10,-1)
      GOTO 5
  11  J=MT9(LUN,7)
      NTEK=0
      IS=0
      GOTO 5
  12  KR=0
      IF(N1.EQ.0) GOTO 120
      IF(N1.GT.NTEK) GOTO 121
      JOB=4
      KR=NTEK-N1+1
      GOTO 120
 121  JOB=3
      KR=N1-NTEK-1
 120  IF(KR.LE.0) GOTO 125
      DO 122 I=1,KR
      NTEK=NTEK-1
      IF(JOB.EQ.3) NTEK=NTEK+2
 122  J=MT9(LUN,JOB)
 125  ASSIGN 5 TO MREAD
 888  J=MT9A(LUN,1,M)
      IS=IABS(J)
      ISB = IS
      IF(IS.GT.1024) IS=0
      NTEK=NTEK+1
      M(IS+1) = 0B
      J1 = 4*IS/5
      J2 = 4*IS-5*J1
      IF(J2.NE.0) J1 = J1+1
      IS = J1
      CALL PUTH(K,'БЛOK:',1,5,0,IPOZ)
      CALL PUTG(0,NTEK,1,4,0,IPOZ)
      CALL PUTH(0,'.  CЧИTAHO ',1,10,0,IPOZ)
      CALL PUTG(0,ISB,1,4,0,IPOZ)
      CALL PUTH(0,' CЛOB БЭCM-6 ИЛИ ',1,17,0,IPOZ)
      CALL PUTG(0,IS,0,3,0,IPOZ)
      CALL PUTH(0,' CЛOB CDC.',0,10,0,IPOZ)
      IF(J.LT.0) CALL PUTH(0,' OШ.ЧETH.',0,9,0,IPOZ)
      CALL DIALOG(K,IPOZ,-1)
      GOTO MREAD,(5,332,402,408)
  14  IF(N1.EQ.0) GOTO 77
      DO 140 I=N1,N2
      CALL PUTG(K,I,1,4,0,IPOZ)
      IF(I.GT.IS) GOTO 220
      CALL GWCDC(M,I,MF)
      CALL PUTH(0,':  OCTAL= ',1,9,0,IPOZ)
      CALL PUTO( 0,   MF,         1, 4, 4, IPOZ )
      CALL PUTH(0,' ',1,1,0,IPOZ)
      CALL PUTO( 0,   MF(2),      1,17, 4, IPOZ )
      CALL PUTH(0,'   TEXT= ',1,9,0,IPOZ)
      MK(1) = LOR(0,LAND(77B,LSHIFT(MF,6)))
      MK(2) = LOR(0,LAND(77B,MF))
      DO 114 J=1,8
 114  MK(J+2) = LOR(0,LAND(77B,LSHIFT(MF(2),6*(8-J))))
      DO 115 J=1,10
 115  CALL PUTH(0,MISO(1+MK(J)),1,1,0,IPOZ)
      CALL PUTH(0,'   DEC= ' ,1,8,0,IPOZ)
      J1=12
      J2=0
      J=NCDTB6(MF,MK) + 1
      GOTO(141,142,143) J
 141  CALL PUTH( 0, 'INDEFINIT', 1, 9, 0, IPOZ )
      GOTO 147
 143  J1=20
      J2=6
 142  CALL PUTG ( 0,MK,0,J1,J2,IPOZ )
 147  CALL DIALOG(K,IPOZ,-1)
      IF(JSEART('NEWJOB',1,1,K).EQ.1) GOTO 5
 140  CONTINUE
      GOTO 5
 220  CALL DIALOG('HET ИHФOPMAЦИИ.',15,-1)
      GOTO 5
C
C
 399  CALL SCANER(0,MF,0,ITYP,KOD,IPOZ)
      IF(ITYP.NE.4) GOTO 77
      JTYP=JSEART('TEXT  DATA',1,2,MF)
      IF(JTYP.EQ.0) GOTO 77
      CALL TAKTAP(2)
      MF(1)=0
      MF(2)=2
      MF(3)=0
      MF(7)='W'
      J=JFOCC(0,MF)
      IF(J.EQ.0) GOTO(300,400) JTYP
      CALL DIALOG(MF(4),18,-1)
      GOTO 5
 300  CALL WBEGIN(LOR(420000B,LAND(7777B,MF(3))))
       DO 301 I=1,14
 301   MK(I)=6H
       LAST=1000
       NB=0
      NBU=0
       NCARD=0
 302  ASSIGN 332 TO MREAD
      GOTO 888
 332  CONTINUE
       NC=1
       DO 303 I=1,640
       J1=M(I)
       DO 303 J=1,8
       MCSYM(9-J,I)=LOR(0,LAND(77B,J1))
 303   J1=LSHIFT(J1,6)
 304   IF(LAST.EQ.0) GOTO 306
 305   LAST=MCSYM(NC)
      CALL IPUTS(LSHIFT(MISO(LAST+1),40),MK,NB)
      NBU=NBU+1
      KUNP(NBU)=MISO(LAST+1)
       NB=NB+1
       NC=NC+1
       IF(NC.GT.8*640) GOTO 302
       GOTO 304
 306   IF(MCSYM(NC).NE.0) GOTO 305
       CALL IPUTS(32,MK,NB-1)
       IF(MK.EQ.' S2)W=') GOTO 310
      MK(13)=0B
      CALL SCANER(MK(2),MF,1,ITYP,KOD,IPOZ)
      IF(ITYP.NE.4) GOTO 316
      IF(MF.EQ.'PROGRA') GOTO 317
      KREST='RETURN' $ IF(MF.EQ.KREST) GOTO 318
      KREST='STOP'   $ IF(MF.EQ.KREST) GOTO 318
 316  MK(13)=6H
       CALL QN(MK,0B)
       CALL WRCARD(MK)
       NCARD=NCARD+1
       DO 307 I=1,14
 307   MK(I)=6H
       NB=0
      NBU=0
       LAST=1000
 308   NC=NC+1
       IF(NC.GT.8*640) GOTO 302
       IF(MCSYM(NC).NE.0) GOTO 305
       GOTO 308
 310   DO 311 I=1,14
 311   MK(I)=6H
       MK(1)='*READ'
       MK(2)='OLD'
       CALL WRCARD(MK)
       CALL WRIEND
      CALL PUTH(MK,'ЗAПИCAHO ',1,9,0,IPOZ)
      CALL PUTG(0,NCARD,0,6,0,IPOZ)
      CALL PUTH(0,' KAPT.',0,6,0,IPOZ)
      CALL DIALOG(MK,IPOZ,-1)
      CALL TAKTAP(2)
      GOTO 5
 317  IF(LSHIFT(LEXOR(MF(2),'M'),40).NE.0B) GOTO 316
      DO 327 I=1,72
      J=I
      IF(KUNP(J).EQ.'(') GOTO 337
 327  CONTINUE
 337  DO 347 I=J,72
 347  CALL IPUTS(32,MK,I-1)
      CALL DIALOG(MK,J+1,-1)
      GOTO 316
 318  IF(LAND(377B,LEXOR(KOD,'$$$$$$')).NE.0B) GOTO 316
      DO 328 I=3,14
 328  MK(I)=6H
      MK(2)=KREST
      CALL QN(MK,0B)
      CALL WRCARD(MK)
      CALL PUTH(MF,'PAЗДEЛEHЫ ',1,10,0,IPOZ)
      CALL PUTH(0,KREST,1,6,0,IPOZ)
      CALL PUTH(0,' И END',1,6,0,IPOZ)
      CALL DIALOG(MF,IPOZ,-1)
      NCARD=NCARD+1
      MK(2)='END'
      MK(1)=6H
      GOTO 316
C-----------------------
C
 400  ND=10000
      CALL SCANER(0,MK,0,ITYP,KOD,IPOZ)
      IF(ITYP.NE.4) GOTO 420
      IF(JSEART('CONTIN',1,1,MK).EQ.0) GOTO 420
      IF(NFIL.EQ.0) GOTO 420
      CALL DIALOG('PEЖИM ДOЗAПИCИ.',15,-1)
      GOTO 401
 420  NFIL=0
      REWIND 2
       NRALL=0
       LEN=0
       KLEN=0
 401   ND=ND+1
      IF(ND.LE.512) GOTO 402
       ND=2
      ASSIGN 402 TO MREAD
      GOTO 888
 402   CALL GWCDC(M,ND,MF)
       LEN1=LOR(0,LAND(77777B,MF(2)))
      MEND=2
       IF(LEN1.EQ.0) GOTO 477
       DO 407 I=1,LEN1
       ND=ND+1
      IF(ND.LE.512) GOTO 408
       ND=2
      ASSIGN 408 TO MREAD
      GOTO 888
 408   CALL GWCDC(M,ND,MF)
       J=NCDTB6(MF,MCSYM(I))
       IF(J.NE.0) GOTO 407
C.....     INDEFINIT
       MCSYM(I)=0B
      J=NRALL+1
      CALL PUTH(MK,'INDEFINIT:',1,10,0,IPOZ)
      CALL PUTG(0,J,1,6,0,IPOZ)
      CALL PUTG(0,I,1,6,0,IPOZ)
      CALL DIALOG(MK,IPOZ,-1)
 407   CONTINUE
       WRITE(2)(MCSYM(I),I=1,LEN1)
       NRALL=NRALL+1
       KL11=KLEN
        L11= LEN
       KLEN=KLEN+1
       IF(LEN1.EQ.LEN) GOTO 401
       LEN=LEN1
       IF(L11.EQ.0) GOTO 401
       KLEN=1
      MEND=1
 477  CALL PUTH(MK,'ЗAПИCAHO ',1,9,0,IPOZ)
      CALL PUTG(0,KL11,0,6,0,IPOZ)
      CALL PUTH(0,' PEKOPДOB ДЛИHOЙ ',0,17,0,IPOZ)
      CALL PUTG(0,L11,0,5,0,IPOZ)
      CALL DIALOG(MK,IPOZ,-1)
      IF(MEND.EQ.1) GOTO 401
      END FILE 2
      NFIL=NFIL+1
      CALL PUTH(MK,'KOHEЦ ',1,6,0,IPOZ)
      CALL PUTG(0,NFIL,1,2,0,IPOZ)
      CALL PUTH(0,'-ГO ФAЙЛA ДAHHЫX.',1,17,0,IPOZ)
      CALL DIALOG(MK,IPOZ,-1)
      J=IC(2)+1
      IC(3)=0
      CALL PUTH(MK,'ЗAПИCAHO ',1,9,0,IPOZ)
      CALL PUTG(0,NRALL,1,6,0,IPOZ)
      CALL PUTH(0,' PEKOPДOB  (',1,12,0,IPOZ)
      CALL PUTO(0,J,1,4,0,IPOZ)
      CALL PUTH(0,' ЗOH).',1,6,0,IPOZ)
      CALL DIALOG(MK,IPOZ,-1)
      NRALL=0
      GOTO 5
      END
      SUBROUTINE ECB6(ICARD,SERVIS)
C*
C*************************************************
C*     16.01.84                    ФAЙH B.Э.
C*     AЛMA-ATA            KAЗГOCYHИBEPCИTET
C*
C*     USER-ПOДПPOГPAMMA PEДAKTOPA   'ECB6'
C*  ПPEДHAЗHAЧEHA ДЛЯ ЧTEHИЯ TEKCTOB, ЗAПИCAHHЫX
C*        HA MAГHИTHЫE ЛEHTЫ EC ЭBM
C*           KOДИPOBKA ДKOИ (IBM)
C*
C*    ИCПOЛЬЗOBAHИE:
C*    -------------
C*    *NAME
C*    *PASS:
C*    *LIBRA:1,23  <ИCПOЛЬЗOBAHЫ 1 И 23 OБCП.>
C*    *TAPE:1060/NO CHECK,43,R,H <ЗAKAЗ EC MЛ>
C*    *TAPE:**/*****,54,W   <ЗAKAЗ OБЫЧHOЙ MЛ>
C*                              ИЛИ ФAЙЛA
C*    *EDIT
C*    *W:<KYДA ПИCATЬ> (*W:54010)
C*    *U:ECB6          (ЗAKAЗ HECTAHД.CEPBИCA>
C*    < CПИCOK ПAPAMETPOB ДЛЯ PAБOTЫ ECB6 >
C*    *EE
C*    .
C*    .        OБЫЧHAЯ PAБOTA B OC "ДYБHA"
C*    .
C*    *END FILE
C* ..............................................
C*  CПИCOK ПAPAMETPOB ЗAДAETCЯ TAK:
C*
C*   LABEL=FILE,BLKSIZE=BLOKE,LRECL=LEN,UNIT=LUN
C*
C*  ГДE FILE   -  ПOPЯДKOBЫЙ HOMEP ФAЙЛA HA MЛ
C*      BLOKE  -  PAЗMEP БЛOKA HA MЛ
C*      LEN    -  ДЛИHA OДHOЙ ЗAПИCИ B БЛOKE
C*      LUN    -  ЛOГИЧECKИЙ (ФOPTPAHHЫЙ) HOMEP,
C*                ПOД KOTOPЫM ЗAKAЗAHA BXOДHAЯ MЛ
C*                (HAПPИMEP:
C*                *TAPE:1022/NO CHECK,41,R,H
C*                  UNIT=1)
C*  ПOPЯДOK CЛEДOBAHИЯ ПAPAMETPOB ПPOИЗBOЛЬHЫЙ,
C*  BHYTPEHHИE ПPOБEЛЫ ИГHOPИPYЮTCЯ, ПAPAMETPЫ
C*  OTДEЛЯЮTCЯ ДPYГ OT ДPYГA ЗAПЯTOЙ ",".
C*      ЗAПЯTAЯ B  KOHЦE CTPOKИ OЗHAЧAET,  ЧTO
C*  OЖИДAETCЯ ПPOДOЛЖEHИE CПИCKA ПAPAMETPOB HA
C*  HA CЛEДYЮЩEЙ KAPTE.
C*
C*  ДOЛЖEH OБЯЗATEЛЬHO ПPИCYTCTBOBATЬ XOTЯ БЫ OДИH
C*                    ПAPAMETP
C*
C*  HA BOЗMOЖHЫE ЗHAЧEHИЯ ПAPAMETPOB HAKЛAДЫBAЮTCЯ
C*  OГPAHИЧEHИЯ (CM.TAБЛ.), ЗHAЧEHИЯ  HE YKAЗAHHЫX
C*  ПAPAMETPOB OПPEДEЛЯЮTCЯ "ПO YMOЛЧAHИЮ"
C*
C*    -----------------------------------------
C*    I   TИП   I ЗHAЧEHИE  I   MIN  I   MAX  I
C*    IПAPAMETPAIПO YMOЛЧAH.IЗHAЧEHИEIЗHAЧEHИEI
C*    -----------------------------------------
C*    I   UNIT  :     1     :    1   :    15  I
C*    I  LABEL  :     1     :    1   :  9999  I
C*    I BLKSIZE :    80     :   80   :  6144  I
C*    I  LRECL  :    80     :    4   :    80  I
C*    =========================================
C*   ЛOГИЧECKИE ЗAПИCИ C LRECL<80 ПPИ ФOPMИPOBAHИИ
C*   ФAЙЛA ЗAПИCИ ДOПOЛHЯЮTCЯ ПPOБEЛAMИ CПPABA  ДO
C*   ПOЛHOЙ П/K, T.E. ДO 80 CИMBOЛOB
C*
C*   HAПPИMEP,ЛEHTY ЗAПИCAHHYЮ HA EC ЭBM B OC EC
C*   C ИCПOЛЬЗOBAHИEM CЛEДYЮЩEГO  DD-ПPEДЛOЖEHИЯ
C*
C* //TAPE DD UNIT=TAPE,LABEL=(3,NL),VOL=SER=1022,
C* //        DCB=(BLKSIZE=800,LRECL=80,RECFM=FB)
C*
C*   MOЖHO ПEPEПИCATЬ HA MБ БЭCM-6 B OC "ДYБHA":
C*
C*   *NAME ...
C*   *PASS:...
C*   *LIBRA:1,23
C*   *TAPE:1022/NO CHECK,41,R,H
C*   *EDIT
C*   *W
C*   *U:ECB6
C*    LABEL=3,BLKSIZE=800
C*   *EE
C*
C*
C*      ЗHAЧEHИE ПAPAMETPOB UNIT И LRECL,ПPИ
C*      ЭTOM,БYДYT OПPEДEЛEHЫ "ПO YMOЛЧAHИЮ",
C*      COOTBETCTBEHHO, 1 И 80.
C*
         COMMON /WRDKEY/ NKEY, UNIT, BLKSIZ, LRECL, LABEL, NBLKS
         DIMENSION KEY(5)
         INTEGER NKEY,UNIT,BLKSIZ,LRECL,LABEL,NBLKS
         EQUIVALENCE (KEY,UNIT)
C
         COMMON /ECCMD/ IRDR, IWRT, IFSP, IBSP,
     *                  IFSF, IBSF, IRWD, IRWU,
     *                  IEOF, IFCL, IBCL, ILWR,
     *                  RECORD(1024)
         DIMENSION ICMD(12)
         EQUIVALENCE (ICMD,IRDR)
         DATA NCMD /12/
C
         DIMENSION ICARD(14),OUTBUF(80),ITABL(256)
C
C                     0   1   2   3   4   5   6   7
C                     8   9   A   B   C   D   E   F
         DATA ITABL /64*1H    ,
     4     8*1H ,    ' ',' ','[','.','<','(','+','!',
     5               '&',7*1H ,
     5               ' ',' ',']','$','*',')',';',' ',
     6                '-','/',6* 1H   ,
     6               ' ',' ','!',',','%','_','>','?',
     7     6*1H ,                            'Ю','A',
     7               'Б',' ',':','#','@',1H','=',1H",
     8               'Ц','A','B','C','D','E','F','G',
     8               'H','I','Д','E','Ф','Г','X','И',
     9               'Й','J','K','L','M','N','O','P',
     9               'Q','R','K','Л','M','H','O','П',
     A               'Я','-','S','T','U','V','W','X',
     A               'Y','Z','P','C','T','Y','Ж','B',
     B               'Ь','Ы','З','Ш','Э','Щ','Ч','Ь',
     B               'Ю','A','Б','Ц','Д','E','Ф','Г',
     C               ' ','A','B','C','D','E','F','G',
     C               'H','I','X','И','Й','K','Л','M',
     D               ' ','J','K','L','M','N','O','P',
     D               'Q','R','H','O','П','Я','P','C',
     E               ' ',' ','S','T','U','V','W','X',
     E               'Y','Z','T','Y','Ж','Ж','Ь','Ы',
     F               '0','1','2','3','4','5','6','7',
     F               '8','9','З','Ш','Э','Щ','Ч',' '
     *             /
C
        INTEGER PAЗБOP, OUTBUF
        DIMENSION IEND(14)
        DATA IEND /'*READ ','OLD',12*1H   /
        DATA IBLANK / 1H  /
         EXTERNAL SERVIS
C
C     PRINT 8005,ICARD
C8005 FORMAT(' *** ECB6 **',13A6,A2)
         DO 5 I=1,NCMD
   5     ICMD(I) = I
C--
C--      CИHT AHAЛИЗ KOMAHД. CTPOKИ И ЗAПOЛHEHИE ATPИБYTOB
C
       IF (PAЗБOP(ICARD) .GT. 0) RETURN
C--
C--      OTPAБOTKA ATPИБYTA  'LABEL'
C
          ISTAPE = MT9A(UNIT,IRWD,RECORD)
         LAB = LABEL - 1
         IF (LAB   .LE. 0)             GO TO   12
C--
C--      ПOИCK HYЖHOГO ФAЙЛA
C
         DO 10 I=1,LAB
          ISTAPE = MT9A(UNIT,IFSF,RECORD)
   10    CONTINUE
C--
C--      HAШЛИ ФAЙЛ, TEПEPЬ ПOЙДEM ПOЧИTAEM
C
   12    CONTINUE
          ISTAPE = MT9A(UNIT,IRDR,RECORD)
         IST    = IANALS(ISTAPE)
                     IF (IST)           990, 15, 14
   14                                  GO TO (12,999,12), IST
C--
C--      TEПEPЬ ПEPEKOДИPYEM
C
   15    CONTINUE
         NBYTE = 0
         DO 40 I=1,NBLKS
             DO 30 J=1,LRECL
                   INDEX = IGETS(RECORD,NBYTE) + 1
                   OUTBUF(J) = ITABL(INDEX)
                   NBYTE = NBYTE + 1
   30        CONTINUE
C
             CALL VBLANK(ICARD,14)
             CALL UBUNCH(OUTBUF,ICARD,LRECL)
C--
C--          ECЛИ KAPTA ИЗ OДHИX ПPOБEЛOB,TO HE ПИШEM
C
             DO 35 JJ=1,14
                 IF(ICARD(JJ).NE.IBLANK)         GO TO  37
   35        CONTINUE
                                                 GO TO  40
   37        CONTINUE
             CALL SERVIS(ICARD)
   40    CONTINUE
                                                 GO TO   12
C--
C--      БЫЛИ ФATAЛЬHЫE OШИБKИ
C
  990    CONTINUE
C--
C--      O'KEY
C
  999    CONTINUE
          ISTAPE = MT9A(UNIT,IRWU,RECORD)
        CALL SERVIS(IEND)
         RETURN
         END
       SUBROUTINE ETLOOK
C*
C***   31.5.84    A.П.CAПOЖHИKOB
C*
C*     ДИAЛOГOBAЯ ПPOГPAMMA ДЛЯ ПPOCMOTPA
C*     TEKCTOBЫX ЛEHT EC ЭBM (KOД EBCDIC).
C*     ПEPEФOPMATИPOBAHИE И ПEPEПИCЬ B
C*     PEДAKTOPCKИЙ ФAЙЛ БЭCM-6.
C*
C*     MЛ EC ДOЛЖHA БЫTЬ ПPEДBAPИTEЛЬHO
C*     ЗAKAЗAHA ПOД ЛOГИЧECKИM HOMEPOM 1.
C*     CПИCOK ПPИKAЗOB ПPOГPAMMЫ
C*     BЫДAETCЯ ПO ДИPEKTИBE "HELP".
C*
       COMMON/PROTO/AP,NU,NL,NF,INT,KAP(40)
       DIMENSION JOBS(14),IFDB(10),LIST(30,80)
       DATA NJOB/7/
       DATA JOBS/'LOOK','END','HELP','PROTO',
     *           'FILE','TEXT','COPY' /
       DATA NREP/5/, INT/0/, NFIL/0/
       DATA LSTR/0/, LPAG/0/
       EXTERNAL WRCARD
       DATA LUN/1/
       DATA JREAD/1/,JFORV/3/,JBACK/4/
       DATA JSMF/5/,JSMB/6/,JREV/7/
       NL=14
C
C---     OCHOBHAЯ ЧACTЬ ДИAЛOГA :
C
  1    CALL DIALOQ('JOB>',4,KAP)
       JOB=0
       CALL SCANER(KAP,JOB,0,ITYP,KOD,IPOZ)
       KBSYM=KOD
       J=JSEART(JOBS,1,NJOB,JOB)
       IF(J.NE.0) GOTO (100,200,300,400,500,600,700 ), J
  2    CALL DIALOG('OШ.ПPИKAЗ',9,-1)
       GOTO 1
C
C...         "PROTO:<N>"
C
 400   IPRO=-1
       CALL SCANER(0,IPRO,0,ITYP,KOD,IPOZ)
       IF(IPRO.LT.0.OR.IPRO.GT.2) GOTO 2
       CALL DIALOP(IPRO)
       GOTO 1
C
C...          "HELP"
C
 300  CALL DIALOG('LOOK          - ИHФOPMAЦИЯ O CTPYKTYPE ЛEHTЫ',48,-1)
      CALL DIALOG('PROTO:<N>     - PEЖИM ПPOTOKOЛA. N=0,1,2    ',48,-1)
      CALL DIALOG('FILE:<N>      - ПOДBOД K N-MY ФAЙЛY. N=1,2..',48,-1)
      CALL DIALOG('FILE:NEXT     - ПOДBOД K CЛEДYЮЩEMY ФAЙЛY.  ',48,-1)
      CALL DIALOG('TEXT          - PACПEЧATKA TEKYЩEГO ФAЙЛA.  ',48,-1)
      CALL DIALOG('COPY:<TOM>(<ЗOHA>) - ПEPEПИCЬ TEKYЩEГO ФAЙЛA',48,-1)
      CALL DIALOG('END           - KOHEЦ CEAHCA.               ',48,-1)
      GOTO 1
C
C...         "LOOK"
C
 100   J=MT9(LUN,JREV)
       NFIL=1
 101   N1=0
       N2=0
       LEN1=100000
 102   IF(INT.NE.0.AND.KAP.EQ.'GOHOME') GOTO 1
       DO 103 I=1,NREP
       J=MT9(LUN,JREAD)
       IF(J.GE.0.OR.I.EQ.NREP) GOTO 104
 103   J=MT9(LUN,JBACK)
 104   IF(IABS(J).EQ.1) J=1027
       LEN=0
       IF(J.GT.1024) GOTO 105
       LEN=6*IABS(J)-6
       DO 106 I=1,6
       IF(IGETSL(LEN).EQ.0) GOTO 105
 106   LEN=LEN+1
 105   IF(LEN.EQ.LEN1) GOTO 108
       IF(LEN1.GT.9000) GOTO 107
       CALL PUTH(KAP,'ФAЙЛ:',0,5,0,IPOZ)
       CALL PUTG(0,NFIL,0,3,0,IPOZ)
       CALL PUTH(0,'  БЛOKИ:',0,8,0,IPOZ)
       CALL PUTG(0,N1,1,4,0,IPOZ)
       CALL PUTH(0,'-',0,1,0,IPOZ)
       CALL PUTG(0, N2,0,4,0,IPOZ)
       CALL PUTH(0,'  ДЛИHOЙ ',0,9,0,IPOZ)
       CALL PUTG(0,LEN1,0,4,0,IPOZ)
       CALL PUTH(0,' БAЙT.',0,6,0,IPOZ)
       CALL DIALOG(KAP,IPOZ,-1)
 107   N1=N2+1
       LEN1=LEN
 108   N2=N2+1
       IF(J.NE.1027) GOTO 109
       NFIL=NFIL+1
       CALL DIALOG(' E O F',6,-1)
       GOTO 101
 109   IF(J.LT.1025) GOTO 110
       CALL DIALOG(' E O T',6,-1)
       GOTO 1
 110   IF(J.GT.0) GOTO 102
       CALL PUTH(KAP,'  БЛOK:',0,7,0,IPOZ)
       CALL PUTG(0,N2,0,4,0,IPOZ)
       CALL PUTH(0,' OШ.ЧETH.',0,10,0,IPOZ)
       CALL DIALOG(KAP,IPOZ,-1)
       LEN1=100000
       GOTO 102
C
C...          "FILE"
C
 500   NFIL1=-1
       CALL SCANER(0,NFIL1,0,ITYP,KOD,IPOZ)
       J=JSEART('FIRST NEXT',1,2,NFIL1) + 1
       GOTO (501,502,503), J
 503   NFIL=NFIL+1
       J=MT9(LUN,JSMF)
       GOTO 505
 502   NFIL1=1
       ITYP=2
 501   IF(ITYP.NE.2.OR.NFIL1.LE.0) GOTO 2
       NFIL=NFIL1
       J=MT9(LUN,JREV)
       NFIL1=NFIL1-1
       IF(NFIL1.EQ.0) GOTO 505
       DO 504 I=1,NFIL1
 504   J=MT9(LUN,JSMF)
 505   J=MT9(LUN,JREAD)
       LEN=IABS(J)
       IF(LEN.EQ.1.OR.LEN.EQ.1027) GOTO 505
       IF(LEN.GT.1024) CALL DIALOG('KOHEЦ ЛEHTЫ.',12,-1)
       IF(LEN.GT.1024) GOTO 1
       LEN=6*LEN-6
       DO 506 I=1,6
       IF(IGETSL(LEN).EQ.0) GOTO 507
 506   LEN=LEN+1
 507   CALL PUTH(KAP,'ПEPBЫЙ БЛOK=',0,12,0,IPOZ)
       CALL PUTG(0,LEN,1,4,0,IPOZ)
       CALL PUTH(0,' БAЙT.',0,6,0,IPOZ)
       IF(LEN.LT.90) GOTO 509
       CALL PUTH(0,' BAPИAHTЫ CTPOK:',0,16,0,IPOZ)
       DO 508 J=45,170
       I=LEN/J
       IF(I*J.EQ.LEN) CALL PUTG(0,J,0,4,0,IPOZ)
 508   CONTINUE
 509   CALL DIALOG(KAP,IPOZ,-1)
       GOTO 1
C
C...         "COPY"
C
 700   IFDB(7)='W'
       J=JFOCC(0,IFDB)
       IF(J.NE.0) CALL DIALOG(IFDB(4),18,-1)
       IF(J.NE.0) GOTO 1
       IADR=IFDB(2).SHIFT.-12
       IADR=IADR.OR.IFDB(3)
       IADR=IADR.AND.777777B
       CALL WBEGIN(IADR)
       NKAPT=0
       JOB='COPY'
       IASPID=6H
       CALL SCANER(0,IASPID,0,ITYP,KOD,IPOZ)
C
C...         "TEXT"
C
 600   KAP=12B
       CALL DIALOQ('PAЗMEP CTPOKИ И CTPAHИЦЫ:',25,KAP)
       CALL SCANER(KAP,N1,0,ITYP,KOD,IPOZ)
       IF(ITYP-2) 2,601,602
 601   CALL SCANER(0,N2,0,ITYP,KOD,IPOZ)
       IF(ITYP.NE.2) GOTO 2
       LSTR=N1
       LPAG=N2
       LBIL=0
       IF(LSTR.LE.80) GOTO 602
       CALL DIALOQ('ШИPИHA БИЛИCTA:',15,KAP)
       CALL SCANER(KAP,LBIL,0,ITYP,KOD,IPOZ)
       IF(ITYP.NE.2.OR.LBIL.LE.0.OR.LBIL.GE.LSTR) GOTO 2
 602   IF(LSTR*LPAG.EQ.0) GOTO 2
       J=MT9(LUN,JSMB)
       IF(J.EQ.1027) J=MT9(LUN,JSMF)
       MEOF=0
       MB=0
       MER=0
C
C...     ФOPMИPOBAHИE CTPAHИЦЫ
C
 609   DO 610 I=1,30
       DO 610 J=1,80
 610   LIST(I,J)=6H@@@@@@
       IP=0
 620   IP=IP+1
       DO 621 IS=1,LSTR
       IF(MB.NE.0) GOTO 611
       J=MT9(LUN,JREAD)
       IF(J.LT.0) MER=MER+1
       IF(J.GT.1024.OR.IABS(J).EQ.1) MEOF=1
       IF(MEOF.NE.0) GOTO 622
       LEN=6*IABS(J)-5
 611   LET=IGETSL(MB)
       MB=MB+1
 621   CALL IPUTS(LET,LIST(1,IP),IS-1)
       IF(MB.GT.LEN) MB=0
       IF(IP.LT.LPAG) GOTO 620
C
C...     ПPИ ПEPEKOДИPOBKE ДЛЯ ЗAБИBKИ
C        БPEДOBЫX CИMBOЛOB ИCПOЛЬЗYETCЯ
C        TOT CИMBOЛ, KOTOPЫЙ БЫЛ YKAЗAH
C        ПOCЛE KOДA OПEPAЦИИ B OCHOBHOЙ
C        ДИPEKTИBE.
C
 622   CALL EBCISO(LIST,LIST,30*IP,KBSYM)
C
C...     BЫДAЧA CTPAHИЦЫ ПO БИЛИCTY
C
       N1=1
       IF(LBIL.NE.0) N1=2
       N2=LSTR
       IF(LBIL.NE.0) N2=LBIL
       N3=1
       DO 630 I=1,N1
       DO 631 J=1,IP
       CALL PUTG(KAP,J,1,5,0,IPOZ)
       CALL PUTH(0,':',0,1,0,IPOZ)
       DO 632 II=1,14
 632   KAP(II+1)=6H
       IS=0
       DO 633 II=N3,N2
       LET=IGETS(LIST(1,J),II-1)
       CALL IPUTS(LET,KAP(2),IS)
 633   IS=IS+1
       ASSIGN 631 TO MRETW
       IF(JOB.EQ.'COPY') GOTO 660
       CALL DIALOG(KAP,IS+6,-1)
       IF(INT.NE.0) GOTO 1
 631   CONTINUE
       N3=N2+1
 630   N2=LSTR
       IF(MEOF.EQ.0) GOTO 609
       J=MT9(LUN,JSMB)
       IF(MER.NE.0) CALL DIALOG('БЫЛИ OШИБKИ ПPИ ЧTEHИИ.',24,-1)
       IF(JOB.NE.'COPY' ) GOTO 1
       DO 634 I=4,15
 634   KAP(I)=6H
       KAP(2)='*READ'
       KAP(3)='OLD'
       ASSIGN 635 TO MRETW
C
C...     ПPИBЯЗKA, ECЛИ HAДO, K ACПИДY
C
 660   IF(IASPID.EQ.'ASPID') CALL PREASP(KAP(2),WRCARD)
       IF(IASPID.NE.'ASPID') CALL WRCARD(KAP(2))
       NKAPT=NKAPT+1
       GOTO MRETW, ( 631, 635 )
 635   CALL WRCARD(KAP)
       CALL WRIEND
       CALL PUTH(KAP,'ПEPEПИCAHO KAPT - ',0,18,0,IPOZ)
       CALL PUTG(0,NKAPT,0,6,0,IPOZ)
       CALL DIALOG(KAP,IPOZ,-1)
       GOTO 1
C
C...      "END"
C
 200   CALL DIALOG('ДO CBИДAHИЯ',12,-1)
       CALL DIALOP(0)
       RETURN
       END
      SUBROUTINE F1PLOT(X,Y,SIZE,S1,S2,S3,N,T)
C*
C****  27.4.84   A.П.CAПOЖHИKOB
C*
C*       ДOПOЛHEHИE K CИCTEME "ГPAФOP"
C*       -----------------------------
C*   SUBROUTINE F1PLOT(X,Y,SIZE,S1,S2,S3,N,T)
C*
C*   PИCOBAHИE ФOPMYЛ HA ГPAФOПOCTPOИTEЛE.
C*   B ФOPMYЛAX ДOПYCKAЮTCЯ CИMBOЛЫ BCEX 4-X
C*   HAБOPOB "ГPAФOP"-A.  ЗAПИCЬ ФOPMYЛ
C*   ЛИHEЙHAЯ, ДOПYCKAЮTCЯ BEPXHИE И HИЖHИE
C*   ИHДEKCЫ, ИЛИ OБA ИHДEKCA OДHOBPEMEHHO
C*   (HAПP.ДЛЯ YKAЗAHИЯ ПPEДEЛOB Y ИHTEГPAЛA).
C*   "ДBYXЭTAЖHЫE" ИHДEKCЫ HE ДOПYCKAЮTCЯ.
C*
C*   X,Y   - KOOPДИHATЫ ЛEBOГO HИЖHEГO YГЛA
C*       ПEPBOГO CИMBOЛA ФOPMYЛЫ B BЫБPAHHЫX
C*       EДИHИЦAX ИЗMEPEHИЯ.
C*   SIZE  - BЫCOTA CИMBOЛOB OCHOBHOЙ ЧACTИ
C*       ФOPMYЛЫ B BЫБPAHHЫX EДИHИЦAX ИЗMEPEHИЯ
C*       BЫCOTA CИMBOЛOB ИHДEKCHЫX ЧACTEЙ
C*       ФOPMYЛЫ = 0.7*SIZE
C*   N     - ЧИCЛO CИMBOЛOB B ФOPMYЛE
C*           ИЛИ CИMBOЛ, ЗABEPШAЮЩИЙ ФOPMYЛY
C*           S2    (ФOPMAT  1H<CИMBOЛ>)
C*   T     - YГOЛ HAKЛOHA ФOPMYЛЫ K OCИ  X
C*           ( B ГPAДYCAX).
C*   S2    - CИMBOЛЬHAЯ CTPOKA, ГДE ЗAПИCAHA
C*       ФOPMYЛA (N ПЛOTHO YПAKOB. CИMBOЛOB )
C*   S1,S3 - PAЗMETKA CTPOKИ  S2  - MACCИBЫ
C*       ИЗ N ПЛOTHO YПAKOBAHHЫX CИMBOЛOB.
C*
C*    K-Й CИMBOЛ B  S1  (K=1,2,...,N) ЗAДAET
C*    HOMEP ШPИФTA ДЛЯ PИCOBAHИЯ K-ГO CИMBOЛA
C*    ИЗ CTPOKИ  S2 :
C*     0 ИЛИ L - БOЛЬШИE ЛAT.ИЛИ PYC. БYKBЫ
C*     1 ИЛИ A - MAЛЫE   ---"---  ---"---
C*     2 ИЛИ G - БOЛЬШИE ГPEЧECKИE БYKBЫ
C*     3 ИЛИ R - MAЛЫE   ---"---  ---"---
C*     ПPOЧEE  - ШPИФT HE MEHЯETCЯ.
C*     ПEPEД HAЧAЛOM И ПO KOHЦY PИCOBAHИЯ
C*     YCTAHABЛИBAETCЯ ШPИФT - 0.
C*
C*    K-Й CИMBOЛ B  S3  (K=1,2,...,N) ЗAДAET
C*    ПOЗИЦИЮ B ФOPMYЛE ДЛЯ K-ГO CИMBOЛA S2 :
C*     1 ИЛИ U - B ПOЛE BEPXHИX ИHДEKCOB
C*     2 ИЛИ D - B ПOЛE HИЖHИX ИHДEKCOB
C*     ПPOЧEE  - B OCHOBHOЙ ЧACTИ ФOPMYЛЫ.
C*
C*    HAПPИMEP, ФOPMYЛA ИHTEГPAЛA OT A ДO B
C*    ДЛЯ ЭKCПOHEHTЫ ЗAДAETCЯ TAK :
C*     INTEGER S1(2),S2(2),S3(2)
C*     DATA S1/ 9H21   31   /
C*     DATA S2/ 9HSABE-LTDT /
C*     DATA S3/ 9H UD UUU   /
C*    (BMECTO CИMBOЛA "S" БYДET HAPИCOBAH ЗHAK
C*    ИHTEГPAЛA, BMECTO "L" - ГPEЧ."ЛЯMБДA")
C*
C*    ИCПOЛЬЗYЮTCЯ ПPOГPAMMЫ "ГPAФOP"-A :
C*          SET, SYMBOL
C*
      DIMENSION NC(3)
      DATA PI/3.14159265/
      DATA C/0.666666/,CIN/0.7/,CUP/1./,CDW/0.666666/
C
C   C   - ШИPИHA CИMBOЛA / SIZE
C   CIN - BЫCOTA CИMBOЛOB ДЛЯ ИHДEKCOB / SIZE
C   CUP - ПOДЬEM BEPXHИX ИHДEKCOB / SIZE
C   CDW - CПYCK   HИЖHИX ИHДEKCOB / SIZE
C
      COST=COS(T*PI/180.)
      SINT=SIN(T*PI/180.)
      XT=X
      YT=Y
      CALL SET(0)
      LASIND=0
      NC(1)=0
      NC(2)=0
      NC(3)=0
C---
      NN=N $ LFIN=-1
      LET=N.SHIFT.42 $ IF(LET.EQ.64B) GOTO 7
      NN=1000 $ LFIN=N
  7   DO 1 ILET=1,NN
      LET=IGETS(S1,ILET-1)
      IF(LET.EQ.76) LET=48
      IF(LET.EQ.65) LET=49
      IF(LET.EQ.71) LET=50
      IF(LET.EQ.82) LET=51
      IF(LET.GE.48.AND.LET.LE.51) CALL SET(LET-48)
      IND=IGETS(S3,ILET-1) - 47
      IF(IND.EQ.38) IND=2
      IF(IND.EQ.21) IND=3
      IF(IND.NE.2.AND.IND.NE.3) IND=1
      LET=IGETS(S2,ILET-1).SHIFT.-40.OR.0002 0040 1002 0040B
      IF(LET.EQ.LFIN) GOTO 8
      IF(IND.NE.LASIND) GOTO (100,200,300), IND
C---   ИЗ TOЙ ЖE KOMПOHEHTЫ :
      CALL SYMBOL(0,0,SIZ1,LET,-1,T)
      GOTO 3
C---   HAЧAЛO OCH.KOMПOHEHTЫ :
 100  MAX=NC(2)
      IF(MAX.LT.NC(3)) MAX=NC(3)
      XT=XT+MAX*SIZE*C*CIN*COST
      YT=YT+MAX*SIZE*C*CIN*SINT
      SIZ1=SIZE
      CALL SYMBOL(XT,YT,SIZ1,LET,1,T)
      GOTO 2
C---   HAЧAЛO BEPX.ИHДEKCA :
 200  DX=-SIZE*CUP*SINT
      DY= SIZE*CUP*COST
      GOTO 230
C---   HAЧAЛO HИЖ.ИHДEKCA
 300  DX= SIZE*CDW*SINT
      DY=-SIZE*CDW*COST
C---   HAЧAЛO ИHДEKCA :
 230  SIZ1=CIN*SIZE
      XT=XT+NC(1)*SIZE*C*COST
      YT=YT+NC(1)*SIZE*C*SINT
      CALL SYMBOL(XT+DX,YT+DY,SIZ1,LET,1,T)
   2  NC(1)=0
      NC(2)=0
      NC(3)=0
   3  NC(IND)=NC(IND)+1
   1  LASIND=IND
  8   CONTINUE
      CALL SET(0)
      RETURN
      END
      SUBROUTINE FELIS
C
C************** ФEДЮHЬKИH A.E.  15/02/82
C*
C*      SUBROUTINE FELIS
C*
C*   BЫДAET HA ПEЧATЬ MOPДY KOTA.
C*
      PRINT1
      PRINT2
      PRINT3
      PRINT 4
      PRINT5
      PRINT6
      PRINT7
      PRINT8
      PRINT9
      PRINT10
      PRINT11
      PRINT12
      PRINT13
      PRINT14
      PRINT15
      PRINT16
      PRINT17
      PRINT18
      PRINT19
      PRINT20
      PRINT21
      PRINT22
      PRINT23
      PRINT24
      PRINT25
      PRINT26
      PRINT27
      PRINT28
      PRINT29
      PRINT30
      PRINT31
      PRINT32
      PRINT33
      PRINT34
      PRINT33
      PRINT32
      PRINT31
      PRINT30
      PRINT29
      PRINT28
      PRINT27
      PRINT26
      PRINT25
      PRINT24
      PRINT23
      PRINT22
      PRINT21
      PRINT20
      PRINT19
      PRINT18
      PRINT17
      PRINT16
      PRINT15
      PRINT14
      PRINT13
      PRINT12
      PRINT11
      PRINT10
      PRINT9
      PRINT8
      PRINT7
      PRINT6
      PRINT5
      PRINT 4
      PRINT3
      PRINT2
      RETURN
 1    FORMAT(1H172X'FELIS DOMESTICA.'6X'PROGRAMMED BY ALEXANDR FEDYUNKIN
     R.'/1H+72X'FELIS DOMESTICA.'20X'ALEXANDR FEDYUNKIN.')
2     FORMAT(1H/10('V')1H:,2X,3H::O,79X,1H:,11X,1H:,13X,1H:/1H+,15X,1HV)
3     FORMAT(2H//,6HVVVVVV,5HCCC/:,4X,3H::V,76X,1H:,10X,1H:,13
     RX,1H:,/1H+,18X,1HO)
4     FORMAT(3H///7('V')6HCCCC/:,4X,3H::V,73X,1H:,10X,1H:,12X,1H:/1H+,21
     RX,1HO)
 5    FORMAT(4(1H/),8(1HV),3HCCC,2H/:,6X,3H::V,10X,7(1HV),6X,3HVVV,17X,
     R5(1HV)6(1HЖ)16X1H:9X1H:12X1H:/1H+24X1HO10X8(1HO)5X3HOOO17X11(1HO))
6     FORMAT(5('/')9('V')2HCC6H/////:4X,3H::V,3X,6HVVVV//,6X5('V')6H///V
     RVV6X11('V'),2HЖЖ8('V')14X,1H:,9X,1H:,11X,1H:/1H+,27X,1HO,3X4('O')8
     RX5('O')3X3('O')6X13('O')7X,1HO)
7     FORMAT(2X,3H///11(1HЖ)7(1HC)6H//::::3HVVV,4X,1H/14X4('/')6('V')2H/
     R/7('V')2HЖЖ13('V')11X,1H:,8X,1H:,11X,1H:/1H+,28X,3HOOO,1X,3HOOO,18
     RX21('O')7X,2HOO)
8     FORMAT(1HV,3X,1H/,3X11('/')2HVV7('C')3H///,9X,3H///3X18('/')4('V')
     R2HЖЖ17('V'),9X,1H:,8X,1H:,10X,1H:/1H+,49X28('O')7X,2HOO)
9     FORMAT(1X,1HO,4X,1H:,9X,1H/,1X,6H://///,3HVVV4('C')6H///CCC5('O')3
     RH///,1X,14(1H/),6(1HV),2HЖЖ,22(1HV)/1H+,1HO35X,5(1HO),3X,34(1HO),7
     RX,4HOOOO6X1H:7X1H:10X1H:)
10    FORMAT(3X1HV3X5H////:5X5H// //2H :5(1H/)9(1HC)7X14(1H/)2HVV3X3HVЖЖ
     R3X11(1HV)7(1HC)4HVVVV4X1H:7X1H:9X1H:/1H+2X1HO34X43(1HO)7X4HOOOO)
11    FORMAT(5X1HV3X5H////:5X1H/3X1H/4X3H://8(1HC)8X13(1H/)1HV3X2HЖЖ9X9(
     R1HV)4HCCCC8(1HV)1H:6X1H:9X1H:/1H+4X1HO33X45(1HO)4X8(1HO))
 12    FORMAT(7X1HV3X5H////:6X1H/3X2H//3X4H:///4HCCC/7X2HCC15X1HV
     R  16X6(1HV)
     R2HCC8(1HV)2H:Ж5X1H:8X1H:12X2H::/1H+6X1HO31X7(1HO)2X38(1HO)2X8(1HO)
     R2H O)
13    FORMAT(9X1HV2X6H/////:7X1H/4X4H/  :9(1H/)5(1HC)14X2HVV19X11(1HV)3H
     R//:4HVVЖЖ2H :8X1H:11X2H::/1H+8X1HO38X16(1HO)6X26(1HO)5H OOOO)
14    FORMAT(11X1HV2X7(1HV)1H:10X1H:8(1H/)7(1HC)13X3HVV/23X4HVVVV5(1H/)1
     RH:4HVVVV2HЖ:7X1H:10X2H::/1H+10X1HO36X15(1HO)11X22(1HO)6H OOOOO)
15    FORMAT(12X1HV,2X9(1H/),1H:,4X1H:,9(1H/),9(1HC),12X4HVV//,25X,7(1H/
     R ),6H://VV:,3HVЖЖ,4X1H:,10X1H:/1H+11X1HO,35X14(1HO),14X20(1HO),1X4
     RH0000,4H 000)
16    FORMAT(13X4HV   ,11(1H/),1H:,8(1H/),10(1HC),13X4HЖЖЖ/,5(1HЖ),21X6(
     R1H/),6H:VV//:,5HVVVЖЖ,2H :,9X2H::/1H+12X1HO,33X16(1HO),6H OOOOO,9X
     R,18(1HO),3X2HOO,6H OOOOO)
17    FORMAT(13X2H//,3X6(1H/),5X6(1H/),9(1HC),16X3HЖЖ/,8(1HЖ),19X6H////C
     RC,5H:VVV:,6H///VVV,2H:Ж,8X1H:/1H+12X2HOO9X5(1HO),15X18(1HO),2H O,5
     RX2HOO,9X14(1HO),7X6(1HO),2H O)
18    FORMAT(14X2H//,3X8(1H/),6H /////,8(1HC),17X14(1HЖ),17X4H////,2HCC,
     R6H://V:V,5H////:,3HVЖЖ,5X2H::/1H+13X2HOO,3X9(1HO),13X21(1HO),8X2HO
     RO,8X13(1HO),4X1HO,3X4HOOOO,4H OOO)
19    FORMAT(14X4H////,3X7(1H/),6H //// ,6(1HC),19X15(1HЖ),15X4H////,4HC
     RCC:,5H///:/,4HVVV:,5HVVVЖЖ,4H   :/1H+13X4HOOOO,3X8(1HO),4X1HO,6X22
     R(1HO),2X5HOOOOO,4X1HO,8X11(1HO),8X1HO,4X5(1HO))
20    FORMAT(15X4H////,4X5HVV///,4H ///,4X3HCCC,19X4HЖЖЖV,9(1HЖ),4HVЖЖЖ,
     R14X6H///CCC,2HCV,8(1H/),5H:VV/V,4HЖЖ::/1H+14X4HOOOO,4X6(1HO),3X4HO
     ROOO,3X33(1HO),2X1HO,7X10(1HO),4X1HO,6X1HO,4X4HOOOO)
21    FORMAT(16X6HV/////,2X1H/,6HV/////,19X9(1H/),10(1HЖ),1HV,6(1HЖ),12X
     R4H////,4HCCCC,12(1H/),5HVVV:Ж/1H+15X6(1HO),3X3HOOO,3X19(1HO),9X13(
     R1HO),3X1HO,7X9(1HO),12X6HO OO O,3HO O)
22    FORMAT(17X6HV/////,2X5HV////,8X2HCC,12X7(1H/),5(1HЖ),3HV V,9(1HЖ),
     R11X5(1H/),4HCCCC,1HЖ,10(1H/),1X6H//:VVЖ/1H+16X6(1HO),2X3HOOO,2X8(1
     RHO),2X12(1HO),7X6(1HO),1X6(1HO),3X1HO,7X9(1HO),4X1HO,7X1HO,3X1HO,2
     RX3HOOO)
23    FORMAT(19X6HV//VVV,4H////,8X5HCCCCC,12X6(1H/),16(1HЖ),9X6(1H ),5(1
     RHC),4H ///,1HV,5(1H/),2X6H/:VVVЖ/1H+18X9(1HO),1X8(1HO),5X12(1HO),6
     RX11(1HO),4X1HO,7X8(1HO),9X1HO,3X1HO,3X6HO OOOO)
24    FORMAT(20X1HV,3X4HCCCC,8X8(1HC),2X10(1HV),4H////,9(1HЖ),1HV,4HЖЖЖЖ
     R,2HVЖ,7X6(1H/),7(1HC),1HЖ,8(1H/),2X1H/,2X4H/VVЖ,3X3H:::/1H+19X4HOO
     ROO,4X8(1HO),8X12(1HO),4X10(1HO),4X2HOO,6X7(1HO),7X1HO7X1HO,4X5(1HO
     R))
25    FORMAT(19X3HV  ,6(1HC),1HV,6X9(1HC),13(1HV),4H////,5(1HЖ),1HV,5(1H
     RЖ),4HVЖЖЖ,4H VVV,8(1H/),8(1HC),1X9(1H/),5X6H/VЖ:::/1H+18X3HOOO,6X,
     R7(1HO),9X12(1HO),5X6(1HO),5X4HOOOO,1X11(1HO),12X1HO,3X1HO,3X6(1HO)
     R)
26    FORMAT(19X1HV,7(1HC),4HVVVV,4X6(1HC),5HVVVCC,6(1HV),7(1H/),3X16(1H
     RЖ),8(1H/),10(1HC),1HЖ,8(1H/),6X4HV::Ж/1H+18X1HO,7X8(1HO),11X40(1HO
     R),10X1HO,7X1HO,3X4HOOOO,2X1HO)
27    FORMAT(18X5(1HV),3HCCC,7(1HV),2H C,11(1HV),13(1HC),7X11(1HЖ),7(1HV
     R),12(1HC),1H/,3X3H///,9X3H//Ж/1H+17X5(1HO),3X8(1HO),3H OO,22X,1HO,
     R6X18(1HO),16X1HO,7X7(1HO))
28    FORMAT(18X27(1HV),14(1HC),13X1H:,3H/ /,4H////,4HVVVV, 8(1HC),1H/,5
     RX1H/,9X5HV/////1H+17X20(1HO),2X1HO,18X3HOOO,15X10(1HO),21X6(1HO))
29    FORMAT(17X1H/,5X11(1HV),2HCC,8(1HV),4HCCVV,11(1HC),20X,7(1H/),4(1H
     RV),6HCCVVЖЖ,12X4H/ VV,5H/V///,8X2H::/1H+16X17(1HO),2X7(1HO),3X2HOO
     R,11X5(1HO),15X11(1HO),2X4HOOOO,13X4HOOOO,3X1HO)
30    FORMAT(17X3HV V,5X5(1HV),6(1HC),4HVVVV,2X8(1HV),6(1HC),17X3H///,2X
     R10(1H/),5(1HV),4(1HЖ),11X3H/VV,7(1H/),4X2H::/1H+16X13(1HO),6X14(1H
     RO),6X17(1HO),3X17(1HO))
31    FORMAT(16X2HV ,2HVV,4H  VV,7X6(1HC),6X4HVVVV,2X3H/VV,2HCC,23X2H//,
     R2X11(1H/),6HЖЖЖЖЖЖ,10X5HVVV//,2X4H////,3H ::/1H+15X15(1HO),6X15(1H
     RO),2X38(1HO),4X2HOO,10X4HOOOO,6X1HO)
32    FORMAT(16X10(1HV),6X1HV4(1HC),3HVVV,,6X2HVV,28X1H/,6X9(1H/),4HЖЖЖЖ
     R,5HVЖЖVV,7X3HVЖЖ,5X4H////,3X2H::/1H+15X17(1HO),4X55(1HO),4X5(1HO),
     R7X3HOOO,8X1HO)
33    FORMAT(16X4HV//V,4H CCC,2X6HVVVVVV,6H VVCVV,2X4HVVVV,2H V,2X4HVVVV
     R,41X11(1HЖ),6H////ЖЖ,6X1H:,6(1H/)/1H+15X5(1HO),3X11(1HO),1X57(1HO)
     R,9X2HOO,4X2HOO,9X1HO)
34    FORMAT(16X4HVV//,3X3HCCC1X2HV/,6X2HVV,7X3HVVV,3X3HVVV,2X1H/,38X7(1
     RHЖ),4HVЖЖЖ,5HV/ЖЖЖ,6X5H:///:/1H+15X7(1HO),3X68(1HO),7X9(1HO)9X1HO)
      END
         FUNCTION IANALS(ISTAT)
C.
C...     AHAЛИЗ PEЗYЛЬTATA OБMEHA C EC-5017
C.
C.       OUTPUT HOMEP OШИБKИ   < 0     -- HEИCПPABИMAЯ OШИБKA
C.                             = 0     --  O'KEY
C.                             > 0     -- ИCПPABИMAЯ OШИБKA
         COMMON /WRDKEY/NKEY,UNIT,BLKSIZ,LRECL,LABEL,NBLKS
         DIMENSION KEY(5)
         INTEGER        NKEY,UNIT,BLKSIZ,LRECL,LABEL,NBLKS
         EQUIVALENCE (KEY,UNIT)
C
         COMMON /ECCMD/ IRDR, IWRT, IFSP, IBSP,
     *                  IFSF, IBSF, IRWD, IRWU,
     *                  IEOF, IFCL, IBCL, ILWR,
     *                   RECORD(1024)
C
C--
C--      TAБЛИЦA COCT. OШИБKИ
C
         DIMENSION IWARN(8,3)
         DATA NERROR /8/
         DATA NCOUNT /16/
         DATA IWARN /
     1   -1024,1025,1026,1027,1028,'BLK6+1',    1   ,'BLK6-1'
     2,    -1 ,1025,1026,1027,1028,   1024 ,'BLK6-2','BLK6'
     3,     1 ,  -1,  -2,   2,   3,     -3 ,   -4   , 0
     *   /
         DIMENSION ITEXT(5,9)
         DATA ITEXT /30HOШИБKA ЧTEHИЯ
     2,              30HCOBCEM ПYCTAЯ ЛEHTA
     3,              30HBЫШЛИ HA KOHEЦ ЛEHTЫ (EOT)
     4,              30HCЧИTAH END OF FILE
     5,              30HBЫШЛИ HA HAЧAЛO ЛEHTЫ
     6,              30HCЛИШKOM ДЛИHHЫЙ БЛOK
     7,              30HCЛИШKOM KOPOTKИЙ БЛOK
     8,              30HHEИЗBECTHAЯ OШИБKA
     9,              30HПOCTOЯHHЫE CБOИ
     *              /
C--
C--      YCTAHOBИM ПEPEMEHHЫE ПOЛЯ
C
         IFIELD = (BLKSIZ +4)/6
         IWARN(6,1) = IFIELD + 1
         IWARN(7,2) = IFIELD - 2
         IWARN(NERROR,1) = IFIELD - 1
         IWARN(NERROR,2) = IFIELD
C
         DO 10 I=1,NERROR
         IF (ISTAT .LT. IWARN(I,1) .OR. ISTAT .GT. IWARN(I,2)) GO TO 10
         N = I
         IST = IWARN(I,3)
                                       GO TO  90
   10    CONTINUE
         IST = -5
         N = NERROR
C
   90    CONTINUE
         IF (IST .EQ. 0)               GO TO  999
         IF (IST .LT. 0)               GO TO   95
         ISTA = MT9A(UNIT,IBSP,RECORD)
         NCOUNT = NCOUNT - 1
         IF (NCOUNT .GT. 0)            GO TO  999
         NN = NERROR + 1
         PRINT 9090,IST,(ITEXT(I,NN),I=1,5)
         IST = -IST
   95    CONTINUE
         PRINT 9090,IST,(ITEXT(I,N),I=1,5)
 9090    FORMAT(' ***** OШИБKA HOMEP ',I3,' ПPИ PAБOTE MT9A'/
     *             5A6)
         PRINT 9091,(KEY(I),I=1,NKEY)
 9091    FORMAT(1X,' UNIT  = ',I4/
     *,         1X,'BLKSIZE= ',I4/
     *,         1X,' LRECL = ',I4/
     *,         1X,' LABEL = ',I4
     *            )
C
  999    CONTINUE
         IANALS = IST
         RETURN
         END
      SUBROUTINE IPT10
C*
C*****   1.6.82   A.П.CAПOЖHИKOB
C*
C*    *CALL IPT10   - BBOД ПEPФOЛEHTЫ
C*     ЭBM EC1010 И ЗAПИCЬ HA MБ 1.
C*    *CALL OPT10   - OБPATHAЯ OПEPAЦИЯ
C*
C*      Ф O P M A T   ПEPФOЛEHTЫ :
C*    KOДИPOBKA  A S C I I
C*    KOHEЦ CTPOKИ - KOMБИHAЦИЯ CR+LF
C*    ( '215' + '012' )
C*    KOHEЦ ЛEHTЫ  - CTPOKA  "%EOD"
C*
      DIMENSION K(40),K1(72),KB(1000)
      CALL WBEGIN(030000B)
      MER = 0
      NS = 0
  1   LET = INPSPT(8)
      IF(LET.EQ.0) GOTO 1
      LET = LAND(LET,377B)
      IF(LAND(1B,LCNT(LET)).NE.0B) MER=MER+1
      IF(LET.EQ.215B) GOTO 2
      CALL IPUTS(LAND(LET,177B),K,NS)
      NS=NS+1
      GOTO 1
  2   IF(INPSPT(8).NE.10) GOTO 2
      IF(NS.GT.83) GOTO 4
      DO 3 I=NS,83
  3   CALL IPUTS(40B,K,I)
  4   NS = 0
      IF(K.EQ.'%EOD') GOTO 5
      CALL WRCARD(K)
      GOTO 1
  5   CALL PUTH(K,'ERRORS:',0,7,0,IPOZ)
      CALL PUTG(0,MER,0,4,0,IPOZ)
      CALL PUTH(0,'INPUT=(YES,NO) ?',0,16,0,IPOZ)
  6   J = JOPER(K,5,1)
      MER = 0
      IF(J.EQ.'YES') GOTO 1
      IF(J.NE.'NO ') GOTO 6
      DO 7 I=3,14
  7   K(I)=' '
      K(1)='*READ'
      K(2)='OLD'
      CALL WRCARD(K)
      CALL WRCARD(K)
      CALL WRIEND
      RETURN
C
C
C
      ENTRY OPT10
      CALL RBEGIN(030000B)
      CALL PTPBEG(KB,1000,0,0)
      DO 10 I=1,40
  10  CALL PTPUNM(0B,6)
  11  CALL RECARD(K)
      IF(K.EQ.'*READ'.AND.K(2).EQ.'OLD') GOTO 15
      J = 0
      DO 12 I=1,72
      K1(I)=IGETS(K,I-1)
      IF(K1(I).NE.32) J=I
  12  CONTINUE
      IF(J.EQ.0) GOTO 11
      DO 13 I=1,J
      LET=LAND(K1(I),377B)
      LET=LOR(LET,LSHIFT(LCNT(LET),-7))
  13  CALL PTPUNS(LET)
      CALL PTPUNS(215B)
      CALL PTPUNS(012B)
      GOTO 11
  15  CALL PTPUNM( 5134 2717 6110 6412B, 6 )
      CALL PTPEND(240)
      RETURN
      END
       FUNCTION LCONEC (N,MATR,IT,IS,ACC)
C*
C*********  04.05.81.  E.Ю.MAЗEПA
C*
C*      БЫCTPЫЙ TECT HA CBЯЗHOCTЬ ГPAФA.
C*
C*     N - ЧИCЛO BEPШИH ГPAФA;
C*     MATR - MATPИЦA CMEЖHOCTИ, MACCИB PAЗMEPHOCTИ (N,L)
C*            ГДE L=N/48, ECЛИ N KPATHO 48, ИHAЧE 1+N/48
C*            ПOCTPOИTЬ MATR MOЖHO C ПOMOЩЬЮ П/П MTRLNK.
C*     IT,IS,ACC - PAБOЧИE MACCИBЫ PAЗMEPHOCTИ L.
C*
C*     BЫXOД: LCONEC=0 - ГPAФ CBЯЗEH,  LCONEC=1 - HECBЯЗEH.
C*     ИCПOЛЬЗYETCЯ ПOДПPOГPAMMA  MBWDEF.
C*
       DIMENSION MATR (2)
       J = N/48
       IF (48*J.NE.N) J=J+1
       CALL MBWDEF (ACC,N)
       CALL MBWSTA (IS)
       CALL MBWLDA (MATR)
  4    CALL MBWSTA (IT)
       CALL MBWEXO (IS)
       I = MBWFIR (0)
       IF (I.EQ.0) GOTO 99
       CALL MBWLDA (IS)
       CALL MBWPUT (I)
       CALL MBWSTA (IS)
       CALL MBWLDA (IT)
       CALL MBWOR (MATR(1+(I-1)*J))
       GOTO 4
  99   K = MBWCNT (0)
       LCONEC = 0
       IF (K.NE.N) LCONEC = 1
       RETURN
       END
      FUNCTION LCROSS(X11,Y11,X12,Y12,X21,Y21,X22,Y22,X0,Y0)
C*
C***   29.10.85   A.П.CAПOЖHИKOB
C*
C*   ПPOГPAMMA BЫЧИCЛЯET KOOPДИHATЫ
C*   TOЧKИ (X0,Y0) ПEPECEЧEHИЯ ДBYX
C*   OTPEЗKOB ПPЯMЫX HA ПЛOCKOCTИ.
C*
C*   KAЖДЫЙ OTPEЗOK ЗAДAETCЯ ДBYMЯ TOЧKAMИ.
C*    I.   (X11,Y11) - (X12,Y12)
C*   II.   (X21,Y21) - (X22,Y22)
C*   BCE ПAPAMETPЫ - TИПA  REAL !
C*
C*   LCROSS ПPИHИMAET OДHO ИЗ 5 ЗHAЧEHИЙ:
C*   1 : ЗAДAHHЫE OTPEЗKИ ПAPAЛЛEЛЬHЫ
C*       И HE ЛEЖAT HA OДHOЙ ПPЯMOЙ;
C*   2 : OTPEЗKИ ЛEЖAT HA OДHOЙ ПPЯMOЙ,
C*       HO HE ИMEЮT OБЩИX TOЧEK;
C*   3 : OTPEЗKИ ЛEЖAT HA OДHOЙ ПPЯMOЙ И
C*       ИMEЮT XOTЯ БЫ OДHY OБЩYЮ TOЧKY;
C*   4 : OTPEЗKИ ПEPECEKAЮTCЯ B OБЩEЙ
C*       TOЧKE  (X0,Y0);
C*   5 : OTPEЗKИ HE ИMEЮT OБЩИX TOЧEK,
C*       HO ИX HAПPABЛEHИЯ ПEPECEKAЮTCЯ
C*       B TOЧKE  (X0,Y0).
C*
C*   B CЛYЧAЯX 1-2 ЗHAЧEHИЯ X0,Y0 HE OПPEДEЛEHЫ.
C*   B CЛYЧAE 3 B KAЧECTBE  (X0,Y0) BЫДAETCЯ :
C*    - OБЩAЯ TOЧKA OБOИX OTPEЗKOB, БЛИЖAЙШAЯ K
C*      (X12,Y12), ECЛИ (X11,Y11) ПPИHAДЛEЖИT
C*      OБЩEЙ ЧACTИ OБOИX OTPEЗKOB;
C*    - OБЩAЯ TOЧKA OБOИX OTPEЗKOB, БЛИЖAЙШAЯ K
C*      (X11,Y11), ECЛИ ПOCЛEДHЯЯ HE ПPИHAДЛEЖИT
C*      OБЩEЙ ЧACTИ OБOИX OTPEЗKOB.
C*
C*   ИCПOЛЬЗYETCЯ KAHOHИЧECKOE YPABHEHИE ПPЯMOЙ
C*            A*X + B*Y + C = 0 ,
C*   ГДE  A=Y2-Y1;  B=X1-X2;  C=X2*Y1-X1*Y2;
C*   (X1,Y1) И (X2,Y2) - ЗAДAHHЫE 2 TOЧKИ ПPЯMOЙ
C*
C*   TOЧKИ ПEPECEЧEHИЯ ПPЯMЫX
C*            A1*X+B1*Y+C1 = 0    И
C*            A2*X+B2*Y+C2 = 0
C*   BЫЧИCЛЯЮTCЯ ПO ФOPMYЛAM :
C*    X0 = (B1*C2-B2*C1) / (A1*B2-A2*B1)
C*    Y0 = (C1*A2-C2*A1) / (A1*B2-A2*B1)
C*
      A1=Y12-Y11$ B1=X11-X12$ C1=X12*Y11-X11*Y12
      A2=Y22-Y21$ B2=X21-X22$ C2=X22*Y21-X21*Y22
      DET = A1*B2 - A2*B1
      IF(DET.EQ.0.) GOTO 10
      X0=(B1*C2-B2*C1)/DET
      Y0=(C1*A2-C2*A1)/DET
      IF(X0.GT.X11.AND.X0.GT.X12) GOTO 5
      IF(X0.LT.X11.AND.X0.LT.X12) GOTO 5
  4   LCROSS=4 $ RETURN
  5   LCROSS=5 $ RETURN
C---
  10  IF(A1.EQ.0.) GOTO 11
      IF(A2*C1.EQ.A1*C2) GOTO 12
  1   LCROSS=1 $ RETURN
C---    ПPOEKЦИИ HA OCЬ X :
  11  IF(B2*C1.NE.B1*C2) GOTO 1
      DET=ABS(X11-X12)+ABS(X21-X22)
      IF(ABS(X11+X12-X21-X22).GT.DET) GOTO 2
      IF(B1.EQ.0.) GOTO 2
      X0=X21 $ Y0=X22
      IF(X21.GT.X22) X0=X22
      IF(X21.GT.X22) Y0=X21
      IF(X0.LT.X11.AND.X0.LT.X12) X0=Y0
      Y0=-(C1+A1*X0)/B1 $ GOTO 3
C---    ПPOEKЦИИ HA OCЬ  Y :
  12  DET=ABS(Y11-Y12)+ABS(Y21-Y22)
      IF(ABS(Y11+Y12-Y21-Y22).GT.DET) GOTO 2
      Y0=Y21 $ X0=Y22
      IF(Y21.GT.Y22) Y0=Y22
      IF(Y21.GT.Y22) X0=Y21
      IF(Y0.LT.Y11.AND.Y0.LT.Y12) Y0=X0
      X0=-(C1+B1*Y0)/A1
  3   LCROSS=3 $ RETURN
  2   LCROSS=2 $ RETURN
      END
      FUNCTION LISPRI(M)
C*
C***    12.5.85     A.П.CAПOЖHИKOB
C*
C*    ПEЧATЬ ЗOHЫ ФAЙЛA BЫBOДA.
C*    ЗOHA ПPOЧИTAHA B MACCИB ЮЗEPA
C*    M (1024 CЛOBA).  PEЗYЛЬTAT=0,
C*    ECЛИ ЭTO ПOCЛEДHЯЯ ЗOHA ФAЙЛA.
C*
      DIMENSION M(2),LINE(30)
      DATA NZ/0/
C------------------
      J=10 $ KOD=M.AND.7777 7700 0000B
      IF(NZ.NE.0) GOTO 99
      NZ=KOD
  1   LL=0 $ ASSIGN 10 TO MWR
  2   J=J+1 $ IF(J.GT.1024) GOTO 100
      IW=M(J) $ GOTO MWR,(10,11,21)
  10  IF(IW.EQ.7777 7777 7777 7777B) GOTO 101
      LET=IW.AND.0017 7777 7777 7777B
      IF(LET.EQ.0005 7274 2747 7176B) GOTO 101
      LET=IW.SHIFT.40
      IF(LET.EQ.376B) GOTO 20
      ASSIGN 11 TO MWR
  11  LL=LL+1
      IF(LL.EQ.30) IW=176B
      LINE(LL)=IW
      LET=IW.AND.377B $ IF(LET.NE.176B) GOTO 2
      CALL COSYPR(LINE) $ GOTO 1
  20  N=N.AND.77777B.OR.0
      ASSIGN 21 TO MWR $ GOTO 2
  21  IF(N.EQ.0) GOTO 1
      N=N-1 $ GOTO 2
  99  IF(NZ.EQ.KOD) GOTO 2
 101  NZ=0 $ LISPRI=0 $ RETURN
 100  LISPRI=M(2).AND.777B.OR.0
      RETURN
      END
      SUBROUTINE LLC(K,S)
C*
C*******  12.03.82   A.П.CAПOЖHИKOB
C*
C*    USER-SUBROUTINE PEДAKTOPA
C*    ДЛЯ ПEЧATИ TEKCTOB, ПOДPAЗДEЛEHHЫX
C*    HA ГЛABЫ, ПAPAГPAФЫ И AБЗAЦЫ.
C*    HAЧAЛO KAЖДOГO ПOДPAЗДEЛEHИЯ
C*    OПPEДEЛЯET ФYHKЦИЯ  LLCHEK(K)
C*    CTAHДAPTHЫЙ BAPИAHT LLCHEK
C*    COOTBETCTBYET CИHTAKCИCY, BBEДEHHOMY
C*    B.M.KAДЫKOBЫM.  ПPИ HEOБXOДИMOCTИ
C*    ПOЛЬЗOBATEЛЬ MOЖET ПOДЛOЖИTЬ CBOЙ
C*    BAPИAHT LLCHEK C TEM ЖE ИHTEPФEЙCOM.
C*
C*    ПPABИЛA ПEЧATИ :
C*    1. ГЛABA BCEГДA ПEЧATAETCЯ C HOBOЙ
C*       CTPAHИЦЫ.
C*    2. ПAPAГPAФ ПEЧATAETCЯ C HOBOЙ
C*       CTPAHИЦЫ, ECЛИ OH BMECTE CO
C*       CBOИM ПEPBЫM AБЗAЦEM HE YMEЩA-
C*       ETCЯ HA OCTATKE TEKYЩEЙ CTPAHИЦЫ.
C*    3. AБЗAЦ ПEЧATAETCЯ C HOBOЙ CTPAHИЦЫ
C*       ECЛИ OH HE YMEЩAETCЯ B TEKYЩEЙ.
C*    4. OГЛABЛEHИE - CПИCOK HAЗBAHИЙ
C*       ПAPAГPAФOB.
C*
C*    ДЛЯ ПEЧATИ OГЛABЛEHИЯ HEOБXOДИMO
C*    ПOCЛE   KAPTЫ    *U:LLC
C*    ПOЛOЖИTЬ KAPTY   =CONTENTS
C*
      COMMON / PROTO / IAP,NUN,NL1(3),MW(20)
      DIMENSION K(14),MTIT(30),JTYP(201),MB(11,200),
     *          MCON(12,500)
      DATA (MTIT=4(' '),'CTP.',18(' '),'O Г Л A B Л E H И E :',
     * 3(' ')), (MC=-1), (NPAG=0), (NEWPAG=1), (JSTAT=1)
      DATA(MHIS=0)
      EXTERNAL KLIN
C---
      ASSIGN 1000 TO MSRET
      IF(K.EQ.'*READ') GOTO 500
      IF(NUN.NE.0B) GOTO 1
      IF(K.EQ.'=CONTE') MC=0
      IF(K.EQ.'=CONTE') RETURN
      J = JEXTRA(MEMORR(46B),70B,0)
      J = JEXTRI(0,70B,0010370000200000B)
      DO 66 I=1,1020,2
      J=I-1025
      IF(MEMORR(J).EQ.5657545163465412B) GOTO 67
  66  CONTINUE
  67  NLF=MEMORR(MEMORR(J+1))
      J = JEXTRA(MEMORR(45B),70B,0)
      NUN=4
      IF(NLF.EQ.0B) GOTO 68
      CALL DIALOP(2)
      CALL DIALOG(' PAБOTAET ПPOГPAMMA  LLC ',24,-1)
      GOTO 69
  68  IAP=LSHIFT(MEMORR(LOCF(KLIN)),24)
  69  CALL DIALOP(200)
C---
  1   JTYP = LLCHEK(K)
      IF(JTYP.EQ.5) GOTO 500
      GOTO ( 10,20,30 ) JSTAT
C---     ДO ПEPBOЙ ГЛABЫ BCE ПEЧATAEM CPAЗY
  10  IPOIN = LOCF(K)
      ASSIGN 999 TO MLRET
      IF(JTYP.NE.1) GOTO 501
      CALL DIALOP(200)
      NEWPAG=1
      JSTAT=2
      GOTO 501
C---    ДO ПEPBOГO ПAPAГPAФA - TOЖE
  20  IF(JTYP.EQ.1) JTYP=4
      IF(JTYP.NE.2) GOTO 10
      NB=0
C---    BKЛЮЧAEM БYФEPИЗAЦИЮ
  21  NB=NB+1
      JTYP(NB+1)=JTYP
      DO 22 I=1,11
  22  MB(I,NB)=K(I)
      JSTAT=3
      ASSIGN 999 TO MSRET
      IF(NB.GE.200) GOTO 500
 999  RETURN
C---    ПPOБA KOHЦA AБЗAЦA
  30  ASSIGN 21 TO MSRET
      GOTO ( 32,500,31,21 ) JTYP
  32  IF(NB.EQ.0) GOTO 10
      ASSIGN 10 TO MSRET
      DO 332 I=1,NB
      IF(JTYP(I+1).NE.3) GOTO 500
 332  CONTINUE
      NB=0
      GOTO 10
  31  IF(JTYP(2).NE.2) GOTO 500
      IF(NB.LT.7) GOTO 21
C---     CБPOC БYФEPA
 500  IF(NB.EQ.0) GOTO 555
C
      IF(NB.LT.KLIN(0)) GOTO 520
      IF(KLIN(0).GT.40) GOTO 520
      IF(NEWPAG.EQ.0) CALL DIALOP(200)
      NEWPAG=1
 520  DO 521 I=1,NB
      IPOIN=LOCF(MB(1,I))
      ASSIGN 521 TO MLRET
C---     ПEЧATЬ OДHOЙ CTPOKИ
 501  IF(NEWPAG.EQ.0) GOTO 502
      NPAG=NPAG+1
      CALL PUTG(MTIT(6),NPAG,0,3,0,IPOZ)
      CALL DIALOG(MTIT,60,-1)
      CALL DIALOG(MTIT(10),60,-1)
      NEWPAG=0
 502  DO 503 II=1,11
 503  MW(II)=MEMORR(IPOIN+II-1)
      CALL DIALOG(MW,62,-1)
      IF(LLCHEK(MW).NE.2) GOTO 505
      IF(MC.LT.0) GOTO 505
      IF(MC.LT.500) MC=MC+1
      DO 504 II=1,11
 504  MCON(II+1,MC)=MW(II)
      CALL PUTG(MCON(1,MC),NPAG,1,3,0,IPOZ)
      CALL PUTH(0,'.',0,1,0,IPOZ)
 505  CONTINUE
       II=KLIN(0)
       IF(II.LT.2) NEWPAG=1
       IF(II.LT.2) CALL DIALOP(200)
      GOTO MLRET, ( 521,999 )
 521  CONTINUE
 555  NB=0
      GOTO MSRET,(999,1000,10,21)
C---     ПEЧATЬ OГЛABЛEHИЯ :
 1000 IF(MC.LE.0) GOTO 1002
      IF(MHIS.EQ.1) GOTO 1002
      MHIS=1
      CALL DIALOP(200)
      CALL DIALOG(MTIT(22),48,-1)
      CALL DIALOG(MTIT(10),60,-1)
      DO 1001 I=1,MC
 1001 CALL DIALOG(MCON(1,I),62,-1)
 1002 CALL DIALOP(0)
      IF(K.EQ.'*READ') CALL S(K)
      RETURN
      END
      FUNCTION LLCHEK(K)
C*
C******   PACПOЗHAЮЩИЙ БЛOK ДЛЯ  LLC (CM.BЫШE)
C*        OПPEДEЛЯET TИП ПOДAHHOЙ HA BXOД KAPTЫ  K :
C*        1 - HOBAЯ ГЛABA
C*        2 - HOBЫЙ ПAPAГPAФ
C*        3 - HOBЫЙ AБЗAЦ
C*        4 - ПPOCTAЯ KAPTA
C*        5 - KOHEЦ TEKCTA
C*
      DIMENSION K(14),M(11)
      LLCHEK=5
      IF(K.EQ.'*END') RETURN
      LLCHEK=3
      DO 1 I=1,10
      IF(K(I).NE.' ') GOTO 2
  1   CONTINUE
      RETURN
  2   LLCHEK=1
      KK=K(12)
      K(12)=0B
      CALL SCANER(K,M,2,IT,KP,IP)
      K(12)=KK
      IF(IT.EQ.4.AND.LSHIFT(LEXOR(M,'***'),24).EQ.0B) RETURN
      LLCHEK=4
      IF(IT.EQ.0.AND.KP.EQ.43) LLCHEK=2
      RETURN
      END
      FUNCTION MGAUSS(NDIM,A,A1,LB,IIJ,C,X,JOB)
      DIMENSION A(LB),A1(LB),IIJ(NDIM),C(NDIM),X(NDIM)
C*
C****   18.04.84   П.Г.AKИШИH
C*
C*    FUNCTION MGAUSS (NDIM,A,A1,LB,IIJ,C,X,JOB)
C*    PEШEHИE CИCTEMЫ ЛИHEЙHЫX YPABHEHИЙ
C*            M * X  =  C
C*    C MATPИЦEЙ  M  HA BHEШHEЙ ПAMЯTИ.
C*
C*    NDIM - PAЗMEPHOCTЬ CИCTEMЫ
C*    A,A1 - PAБOЧИE MACCИBЫ ДЛИHOЙ LB KAЖДЫЙ
C*           ИCПOЛЬЗYЮTCЯ KAK OБMEHHЫE БYФEPA
C*    LB   - ДЛИHЫ БYФEPOB, ЧEM БOЛЬШE-TEM ЛYЧШE
C*           XOPOШO, ECЛИ  LB > 2000
C*    IIJ  - PAБOЧИЙ MACCИB ДЛИHOЙ  NDIM
C*           B HEM XPAHИTCЯ BEKTOP ПEPECTAHOBOK
C*           CTPOK MATPИЦЫ
C*    C    - MACCИB ДЛИHOЙ  NDIM,  COДEPЖИT
C*           ПPABYЮ ЧACTЬ CИCTEMЫ.
C*    X    - MACCИB ДЛИHOЙ  NDIM,  B HEГO
C*           ПOMEЩAETCЯ PEШEHИE CИCTEMЫ.
C*    JOB  - KOД OПEPAЦИИ :  1,2 ИЛИ 3
C*
C*    JOB=1 : ФOPMИPOBAHИE MATPИЦЫ И ЗAПИCЬ HA
C*         YCTPOЙCTBO C ЛOГИЧECKИM HOMEPOM  1.
C*         ПAPAMETPЫ  IIJ  И  C  HECYЩECTBEHHЫ.
C*         ПAPAMETP  X  -  OЧEPEДHOЙ CTOЛБEЦ.
C*         ПOCЛEДOBATEЛЬHOCTЬ ПOДAЧИ CTOЛБЦOB -
C*         - 1,2,3,...,NDIM.
C*
C*    JOB=2 : ФAKTOPИЗAЦИЯ MATPИЦЫ ПO METOДY
C*         AKИШИHA - ГAYCCA  И ПOЛYЧEHИE OДHOГO
C*         PEШEHИЯ  X  ДЛЯ ПPABOЙ ЧACTИ  C.
C*         ФAKTOP-MATPИЦA ЗAПИCЫBAETCЯ HA
C*         YCTPOЙCTBO C ЛOГИЧECKИM HOMEPOM 2.
C*         ИCXOДHAЯ MATPИЦA COXPAHЯETCЯ.
C*         MACCИB  C  HE COXPAHЯETCЯ.
C*
C*    JOB=3 : PEШEHИE CИCTEMЫ ПO YЖE ФAKTOPИЗO-
C*         BAHHOЙ MATPИЦE. ИCПOЛЬЗYETCЯ MACCИB
C*         IIJ, ПOЛYЧEHHЫЙ B XOДE ФAKTOPИЗAЦИИ.
C*         ПPABAЯ ЧACTЬ  C  HE COXPAHЯETCЯ.
C*         MATPИЦЫ B ФAЙЛAX 1 И 2 COXPAHЯЮTCЯ.
C*
C*    B KAЧECTBE BHEШHEЙ ПAMЯTИ ДЛЯ XPAHEHИЯ
C*    MATPИЦ YДOБHO ЗAKAЗATЬ  SCRATCH-ФAЙЛЫ.
C*    TPEБYEMЫЙ OБЬEM KAЖДOГO ИЗ ФAЙЛOB 1 И 2
C*    OПPEДEЛЯETCЯ COOTHOШEHИEM  :
C*        V > 1 + NDIM * NDIM / 936
C*    (B ЗOHE PAЗMEЩAETCЯ 936 CЛOB ФOPTP.ФAЙЛA)
C*    HACTOЯTEЛЬHO PEKOMEHДYEM ПEPEД KAPTOЙ
C*    *EXECUTE     ПOЛOЖИTЬ B KOЛOДY KAPTЫ:
C*    *CALL FT*REGIM:F1=BUF
C*    *CALL FT*REGIM:F2=BUF
C*    ЭTO ЗHAЧИTEЛЬHO COKPATИT ЧИCЛO OБMEHOB.
C*
C*    ЗHAЧEHИEM ФYHKЦИИ  MGAUSS ЯBЛЯETCЯ 0,
C*    ECЛИ BCE HOPMAЛЬHO, ИHAЧE HOMEP OШИБKИ.
C*    ПPИ OШИБKAX ПEЧATAETCЯ COOБЩEHИE.
C*
C*     ПPИBEДEM ПPИMEP ИCПOЛЬЗOBAHИЯ MGAUSS
C*     ДЛЯ ПEЧATИ (ПO CTOЛБЦAM) MATPИЦЫ,
C*     OБPATHOЙ ЗAДAHHOЙ MATPИЦE.
C*
C*     DIMENSION A(2000),A1(2000)
C*     DIMENSION IND(200),C(200),X(200)
C*     N=200 $ LB=2000
C*     DO 1 J=1,N
C*      <ФOPMИPOBAHИE J-ГO CTOЛБЦA
C*       ИCXOДHOЙ MATPИЦЫ B MACCИBE X>
C*  1  M=MGAUSS(N,A,A1,LB,0,0,X,1)
C*     JOB=2
C*     DO 2 J=1,N
C*     DO 3 I=1,N
C*  3  C(I)=0.
C*     C(J)=1.
C*     M=MGAUSS(N,A,A1,LB,IND,C,X,JOB)
C*     IF(M.NE.0) STOP
C*     PRINT 100,(X(I),I=1,N)
C*  2  JOB=3
C*
      DIMENSION MER(4,3)
      DATA LASJOB/1/,NCOL/0/,MDET/1/
      DATA EPS/1.E-10/
      DATA MER/
     1      24HБYФEPA CЛИШKOM MAЛЫ.      ,
     2      24HMATPИЦA EЩE HE ГOTOBA.    ,
     3      24HMATPИЦA BЫPOЖДEHA.        /
C-----------------------------------------
      IDIM=NDIM
      IDIM1=LB/IDIM
      IF(IDIM1.GT.IDIM) IDIM1=IDIM
      NMAX=IDIM*IDIM1
      MG=1
      IF(LB.LT.IDIM) GOTO 5000
      MG=2
      IF(JOB.LT.1.OR.JOB.GT.LASJOB) GOTO 5000
      MG=3
      IF(MDET.EQ.0) GOTO 5000
      MG=0
      GOTO ( 101, 201, 301 ), JOB
C
C... 1. ЗAПOЛHEHИE MATPИЦЫ
C
  101 IF(NCOL.EQ.0) NCOL1=0
      IF(NCOL.EQ.0) REWIND 1
      NCOL=NCOL+1
      NCOL1=NCOL1+1
      K = (NCOL1-1)*IDIM
      DO 102 I=1,IDIM
  102 A(I+K)=X(I)
      IF(NCOL1.LT.IDIM1) GOTO 103
      NCOL1=0
      WRITE(1) (A(I),I=1,NMAX)
  103 IF(NCOL.LT.IDIM) GOTO 5000
      IF(NCOL1.NE.0) WRITE(1) (A(I),I=1,NMAX)
      LASJOB=2
      NCOL=0
      MDET=1
      GOTO 5000
C
C... 2. ФAKTOPИЗAЦИЯ MATPИЦЫ
C
  201 REWIND 1
      N0=IDIM
      K0=IDIM1
      KT0=IDIM1
      DO 10 K=1,N0
10    IIJ(K)=K
      KKK0=0
      LLL0=0
      READ(1) (A(LK),LK=1,NMAX)
      REWIND 2
      GO TO 80
11    CONTINUE
      IF(KKK0.EQ.N0)GO TO 2000
      IF(KKK0+K0.GT.N0)KT0=N0-KKK0
      READ(1) (A(LK),LK=1,NMAX)
      REWIND 2
      KK0=0
      DO 40 K1=1,LLL0
      READ(2) (A1(LK),LK=1,NMAX)
      NNN0=-N0
      DO 50 K2=1,K0
      NNN0=NNN0+N0
      KK0=KK0+1
      KK1=KK0+1
      KK5=IIJ(KK0)
      NNN1=-N0
      DO 60 K3=1,KT0
      NNN1=NNN1+N0
      R1=A(NNN1+KK5)
      DO 70 K4=KK1,N0
      I1=IIJ(K4)
70    A(NNN1+I1)=R1*A1(NNN0+I1)+A(NNN1+I1)
60    CONTINUE
50    CONTINUE
40    CONTINUE
80    CONTINUE
      NNN0=-N0
      DO 20 K1=1,KT0
      KKK0=KKK0+1
      NNN0=NNN0+N0
      KK1=KKK0+1
      IF(KK1.GT.N0)GO TO 20
      IMAX=KKK0
      RMAX=ABS(A(NNN0+IIJ(KKK0)))
      DO 30 K2=KK1,N0
      IF(ABS(A(NNN0+IIJ(K2))).LE.RMAX)GO TO 30
      IMAX=K2
      RMAX=ABS(A(NNN0+IIJ(IMAX)))
30    CONTINUE
      K7=IIJ(IMAX)
      I1=IIJ(KKK0)
      IIJ(KKK0)=K7
      IIJ(IMAX)=I1
      IF(ABS(A(NNN0+K7)).LT.EPS) GOTO 1000
      RMAX=-1./A(NNN0+K7)
      DO 140 K2=KK1,N0
      K5=IIJ(K2)+NNN0
140   A(K5)=A(K5)*RMAX
      IF(K1.EQ.KT0)GO TO 20
      KK2=K1+1
      NNN1=NNN0
      DO 150 K3=KK2,KT0
      NNN1=NNN1+N0
      R1=A(NNN1+K7)
      DO 160 K4=KK1,N0
      I1=IIJ(K4)
160   A(NNN1+I1)=A(NNN1+I1)+R1*A(NNN0+I1)
150   CONTINUE
20    CONTINUE
      WRITE(2) (A(LK),LK=1,NMAX)
      LLL0=LLL0+1
      GO TO 11
C------------ BЫPOЖДEHHAЯ MATPИЦA
1000  CONTINUE
      MDET=0
C------------ HOPMAЛЬHЫЙ KOHEЦ ФAKTOPИЗAЦИИ
2000  CONTINUE
      LASJOB=3
C
C... 3. БЫCTPOE PEШEHИE ПO ФAKTOPИЗ.MATPИЦE
C
  301 REWIND 2
      KKK0=0
      KT0=IDIM1
      NNNN1=N0*(KT0-1)
2003  CONTINUE
      IF(KKK0+IDIM1.GT.N0)KT0=N0-KKK0
      READ(2) (A(LK),LK=1,NMAX)
      NNN0=-N0
      DO 2001 K1=1,KT0
      NNN0=NNN0+N0
      KKK0=KKK0+1
      KK1=KKK0+1
      IF(KK1.GT.N0)GO TO 2001
      R1=C(IIJ(KKK0))
      DO 2002 K2=KK1,N0
      I1=IIJ(K2)
2002  C(I1)=C(I1)+R1*A(NNN0+I1)
2001  CONTINUE
      IF(KKK0.NE.N0)GO TO 2003
2005  I1=IIJ(KKK0)
      X(KKK0)=C(I1)/A(NNN0+I1)
      KK1=KKK0-1
      R1=X(KKK0)
      IF(KK1.EQ.0)GO TO 2010
      DO 2004 K1=1,KK1
      I1=IIJ(K1)
2004  C(I1)=C(I1)-A(NNN0+I1)*R1
2010  CONTINUE
      KKK0=KKK0-1
      NNN0=NNN0-N0
      IF(NNN0.GE.0)GO TO 2005
      IF(KKK0.EQ.0)GO TO 5000
      BACKSPACE 2
      BACKSPACE 2
      READ(2) (A(LK),LK=1,NMAX)
      NNN0=NNNN1
      GO TO 2005
5000  MGAUSS=MG
      IF(MG.NE.0) PRINT 5001,MG,(MER(I,MG),I=1,4)
      RETURN
5001  FORMAT(' ПPOГPAMMA MGAUSS.  OШИБKA-',I1,' : ',4A6)
      END
       FUNCTION MTRLNK (NV,NR,LISTR,MATR,MAC)
C*
C************   06.05.81.  A.П.CAПOЖHИKOB.
C*
C*     ПOCTPOEHИE MATPИЦЫ CMEЖHOCTИ  MATR  ДЛЯ ГPAФA,
C*     ЗAДAHHOГO CПИCKOM PEБEP  LISTR.
C*
C*     NV - KOЛИЧECTBO BEPШИH ГPAФA
C*     NR - KOЛИЧECTBO PEБEP  ГPAФA
C*     LISTR - MACCИB PAЗMEPHOCTИ NR, ПO OДHOMY CЛOBY
C*          HA PEБPO.  1-15 И 16-30 PAЗPЯДЫ KAЖДOГO
C*          CЛOBA COДEPЖAT HOMEPA BEPШИH, COCTABЛЯЮЩИX
C*          PEБPO ( N = 1,2,3,...,NV ).  COДEPЖИMOE
C*          OCTAЛЬHЫX PAЗPЯДOB, A TAKЖE ПOPЯДOK ЗAДAHИЯ
C*          BEPШИH И PEБEP HECYЩECTBEHHЫ.
C*     MATR - MACCИB PAЗMEPHOCTИ  (NV,L) ,  ГДE L=NV/48
C*          ПPИ NV KPATHOM 48, ИHAЧE  L=1+NV/48
C*     MAC - PAБOЧИЙ MACCИB ДЛИHOЙ L.
C*
C*     ПPИ HOPMAЛЬHOM ЗABEPШEHИИ PAБOTЫ  MTRLNK = 0
C*     ECЛИ B LISTR OБHAPYЖEHA BEPШИHA C HOMEPOM, HE
C*     BXOДЯЩИM B ИHTEPBAЛ  [ 1 : NV ] ,  MTRLNK
C*     ПOЛAГAETCЯ PABHЫM HOMEPY PEБPA B LISTR,
C*     COДEPЖAЩEMY HEДOПYCTИMYЮ BEPШИHY.
C*
       DIMENSION LISTR(2), MATR(2)
       LENS = NV/48
       IF (NV.NE.48*LENS) LENS = LENS + 1
       LL = NV*LENS
       DO 2 I=1,LL
  2    MATR(I) = 0B
       CALL MBWDEF (MAC,NV)
       DO 1 I=1,NR
       MTRLNK = I
       J = LISTR(I)
       N2 = LOR(0,LAND(77777B,J))
       N1 = LOR(0,LAND(77777B,LSHIFT(J,15)))
       IF (N1.LT.1.OR.N1.GT.NV) GOTO 13
       IF (N2.LT.1.OR.N2.GT.NV) GOTO 13
       J1 = 1+LENS*(N1-1)
       J2 = 1+LENS*(N2-1)
       CALL MBWLDA (MATR(J1))
       CALL MBWPUT (N2)
       CALL MBWSTA (MATR(J1))
       CALL MBWLDA (MATR(J2))
       CALL MBWPUT (N1)
       CALL MBWSTA (MATR(J2))
  1    CONTINUE
       MTRLNK = 0
  13   RETURN
       END
      SUBROUTINE NNN (ICAR,SERV)
C*
C*            USER-ПOДПPOГPAMMA
C*      HYMEPAЦИИ HEHYMEPOBAHHЫX KAPT.
C*
C*    OБPAЩEHИE:
C*    *U:NNN:<HOMEP KAPTЫ>
C*    HAПPИMEP:
C*    *U:NNN:DD87-001
C*
C*    (ECЛИ ПOCЛEДHИЙ CИMBOЛ - HE ЦИФPA,
C*    OH ЗAMEHЯETCЯ HA "1")
C*
      EXTERNAL SERV
      DIMENSION ICAR(14),NUMB(8)
      COMMON /TIKTAK/ A(10),CARD(14),JRO
      DATA NUMB /8*0B/
C
      IF    (JRO.EQ.1)              GOTO 90
      IF    (ICAR(13).NE.1H .OR.
     *      ICAR(14).NE.1H )        GOTO 90
      IF    (NUMB.NE.0B)            GOTO 40
            N=1
      DO 10 I=2,71
      IF    (IGETS(CARD,I).NE.58)   GOTO 10
      IF    (N.EQ.0)                GOTO 20
            N=0
10    CONTINUE
                                    GOTO 90
20    CONTINUE
      DO 30 N=1,8
            I=I+1
      NUMB(N)=IGETS(CARD,I)
30    CONTINUE
      IF    (NUMB(8).LT.48.OR.NUMB(8).GE.58)
     *      NUMB(8)=48
                                    GOTO 70
40    CONTINUE
            N=8
50    CONTINUE
      NUMB(N)=NUMB(N)+1
      IF    (NUMB(N).LT.58)         GOTO 70
      NUMB(N)=48
            N=N-1
      IF    (N.EQ.0)                GOTO 70
      IF    (NUMB(N).LT.48.OR.NUMB(N).GE.58)
     *      NUMB(N)=48
                                    GOTO 50
70    CONTINUE
            I=72
      DO 80 N=1,8
      CALL IPUTS(NUMB(N),ICAR,I)
            I=I+1
80    CONTINUE
90    CONTINUE
      CALL SERV(ICAR)
                                    RETURN
      END
      FUNCTION NTRANC( N, WBESM, WCDC )
C*
C*****  25.5.82    A.П.CAПOЖHИKOB
C*
C*    ПPEOБPAЗOBAHИE  N  ЧИCEЛ ИЗ
C*    MACCИBA  WBESM  B 60-PAЗPЯДHOE
C*    ПPEДCTABЛEHИE ЭBM CDC-6500
C*    (MACCИB WCDC). TИПЫ ЧИCEЛ:
C*    ЦEЛOE,BEЩECTBEHHOE - COXPAHЯЮTCЯ.
C*    PEЗYЛЬTAT PAБOTЫ ФYHKЦИИ -
C*    KOЛИЧECTBO 48-PAЗPЯДHЫX CЛOB,
C*    ЗAHИMAEMЫX MACCИBOM WCDC, T.E.
C*    NTRANC = 60*N/48  ИЛИ HA 1 БOЛЬШE.
C*    ИCПOЛЬЗYETCЯ ПPOГPAMMA CONV60.
C*
      INTEGER WBESM(2),WCDC(2),M(5)
C
C---
C
      INDEX = 0
      NS = 0
      DO 1 I=1,N
      CALL CONV60(WBESM(I),M)
      DO 2 J=1,4
  2   M(6-J) = LAND(7777B,LSHIFT(M(2),12*(J-1)))
      DO 3 J=1,5
      NS = NS + 12
      IF ( NS.LE.0 ) GOTO 3
      NS = -36
      INDEX = INDEX+1
      WCDC(INDEX) = 0B
  3   WCDC(INDEX) = LOR(WCDC(INDEX),LSHIFT(M(J),NS))
  1   CONTINUE
      NTRANC = INDEX
      RETURN
      END
      FUNCTION OVTREE(MCAR)
C*
C****   22.4.86.   A.П.CAПOЖHИKOB
C*
C*   *CALL OVTREE:<YK.MЛ>
C*   BOCCTAHOBЛEHИE ДEPEBA PAЗДEЛOB
C*   ПO KATAЛOГY  OVERLAY-БИБЛИOTEKИ.
C*   OПИCAHИE ДEPEBA ФOPMИPYETCЯ HA
C*   MБ 03,  A TAKЖE ПEЧATAETCЯ HA AЦПY.
C*
      INTEGER CAT(520),LEV(520),S(2000)
      INTEGER NAM(2),KAP(14)
      DATA KAP/14(' ')/, NAM/'MONITOR*'/
C
C---   BЫБOPKA <YK.MЛ>, ЧTEHИE KATAЛOГA
C
      I=IGETS(MCAR,13).AND.7B
      J=IGETS(MCAR,14).AND.7B
      NZ=0B $ MT=I.SHIFT.-3.OR.J
      DO 1 I=1,4
      J=IGETS(MCAR,I+14)
      IF(J.LT.48.OR.J.GT.55) GOTO 2
  1   NZ=NZ.SHIFT.-3.OR.(J.AND.7B)
  2   MT=MT.SHIFT.-12.OR.NZ.OR.0010 3700 0000 0000B
      J = JEXTRI(0,70B,MT)
      DO 3 I=1,512
      LEV(I+1)=MEMORR(2*I+31743).AND.77777B.OR.0
  3   CAT(I+1)=MEMORR(2*I+31742)
      LEV(1)=0 $ S(1)=0 $ CAT(1)=0B
      K=1 $ MAXL=0
C
C---  ЗAMEHA B LEV AДPECOB HAЧAЛ PAЗДEЛOB
C     HA HOMEPA YPOBHEЙ = 0,1,2,...
C
      DO 4 I=2,512
      IF(CAT(I).EQ.0B) GOTO 10
   5  IF(S(K)-LEV(I)) 7,8,6
   6  K=K-1 $ GOTO 5
   7  K=K+1 $ IF(K.GT.MAXL) MAXL=K
      S(K)=LEV(I)
   8  LEV(I)=K
   4  N = I
C
C---  ФOPMИPOBAHИE CTEKA ПOДДEPEBЬEB
C     ПOДДEPEBO - CПИCOK BИДA BN,...,B1,H,L,0
C
  10  S(1)=0 $ S(2)=0B $ K=2
      OVTREE=MAXL $ MAXL=MAXL+1
  20  MAXL=MAXL-1 $ IF(MAXL.EQ.0) GOTO 30
C
C---   ПOИCK PAЗДEЛA YPOBHЯ MAXL.
C
  21  J=N+1
  22  J=J-1 $ IF(J.LT.0) GOTO 20
      IF(LEV(J).NE.MAXL) GOTO  22
      JJ=J $ J=J+1
C
C---   ПOДДEPEBO - B CTEK
C
  23  J=J-1 $ K=K+1 $ S(K)=CAT(J)
      IF(LEV(J).EQ.MAXL) GOTO 23
      S(K+1)=MAXL $ S(K+2)=0B $ K=K+2
      NZ=JJ-J $ N=N-NZ $ J=J+1
C
C---   YБИEHИE ПOДДEPEBA
C
      DO 24 I=J,N
      CAT(I)=CAT(I+NZ)
  24  LEV(I)=LEV(I+NZ)
      GOTO 21
C
C---   PAЗГPYЗKA CTEKA HA MБ 03
C
  30  CALL WBEGIN(030000B)
      K=K-1 $ IPH=2 $ IP=2 $ MAXL=1
      ASSIGN 31 TO MRET $ GOTO 91
C
C---   ГOЛOBHOЙ PAЗДEЛ BЫБPAH
C
  31  CALL IPUTS('((((((',KAP,IP)
      IP=IP+1 $ IPC=IP
C
C---   OЧEPEДHAЯ BETBЬ ПOДДEPEBA
C
  32  IF(IP.LT.60) GOTO 34
      CALL WRCARD(KAP) $ PRINT 1000,KAP
      IP=IPC $ DO 33 I=1,14
  33  KAP(I)=6H
  34  CALL IPUTS('++++++',KAP,IP) $ IP=IP+1
      ASSIGN 35 TO MRET
C
C---   BЫБOPKA ИMEHИ PAЗДEЛA ИЗ CTEKA.
C      ПEPEBOД B ISO,  ЗAПИCЬ B KAP.
C
  90  NAM(2)=' ' $ CALL TEXISO(S(K-1),NAM)
  91  K=K-1 $ DO 92  I=1,9
      LET=IGETS(NAM,I-1)
      IF(LET.EQ.32) GOTO MRET,(31,35)
      CALL IPUTS(LET,KAP,IP)
  92  IP=IP+1
C
C---   ПPOБA KOHЦA ПOДДEPEBA
C
  35  CALL IPUTS(',,,,,,',KAP,IP) $ IP=IP+1
      IF(S(K-1).NE.0B) GOTO 32
      CALL IPUTS('))))))',KAP,IP-1)
      CALL WRCARD(KAP) $ PRINT 1000,KAP
      DO 36 I=1,14
  36  KAP(I)=6H
      K=K-2 $ IF(S(K).NE.MAXL) IPH=IPH+2
      MAXL=S(K) $ IP=IPH
      ASSIGN 31 TO MRET
      IF(MAXL.NE.0.AND.K.GT.1) GOTO 90
C
C---    C Л И B :
C
      KAP(1)='*END R' $ KAP(2)='ECORD'
      CALL WRCARD(KAP) $ PRINT 1000,KAP
      KAP(1)='*READ'  $ KAP(2)='OLD'
      CALL WRCARD(KAP) $ CALL WRIEND
      RETURN
 1000 FORMAT(2X,14A6)
      END
       INTEGER FUNCTION PAЗБOP(ICARD)
C.
C...     ПOДПPOГPAMMA ДЛЯ OПPEДEЛEHИЯ TИПA И ЗHAЧ. ПAPAMETPOB
C...               BXOДHOЙ KOMAHД.CTPOKИ
C.
C.  CИHTAKCИC --   LABEL=FILE,BLKSIZE=BLOKE,LRECL=LEN,UNIT=LUN
C-
C-  ГДE FILE   -  ПOCЛEДOBATEЛЬHЫЙ HOMEP ФAЙЛA HA MЛ
C-      BLOKE  -  PAЗMEP БЛOKA HA MЛ
C-      LEN    -  ДЛИHA OДHOЙ ЗAПИCИ B БЛOKE
C-      LUN    -  ЛOГИЧECKИЙ (ФOPTPAHHЫЙ) HOMEP,
C-                ПOД KOTOPЫM ЗAKAЗAHA BXOДHAЯ MЛ
C-                (HAПPИMEP:
C-                *TAPE:1022/NO CHECK,41,R,H
C-                  UNIT=1)
C-  ПOPЯДOK CЛEДOBAHИЯ ПAPAMETPOB ПPOИЗBOЛЬHЫЙ,
C-  BHYTPEHHИE ПPOБEЛЫ ИГHOPИPYЮTCЯ, ПAPAMETPЫ
C-  OTДEЛЯЮTCЯ ДPYГ OT ДPYГA ЗAПЯTOЙ ",".
C-      ЗAПЯTAЯ B  KOHЦE CTPOKИ OЗHAЧAET,  ЧTO
C-  OЖИДAETCЯ ПPOДOЛЖEHИE CПИCKA ПAPAMETPOB HA
C-  HA CЛEДYЮЩEЙ KAPTE.
C*
         DIMENSION ICARD(14)
         COMMON /WRDKEY/ NKEY,UNIT,BLKSIZ,LRECL,LABEL,NBLKS
         DIMENSION KEY(5)
         INTEGER        NKEY,UNIT,BLKSIZ,LRECL,LABEL,NBLKS
         EQUIVALENCE (KEY,UNIT)
C
C--
C--      CTYKTYPA TAБЛИЦЫ ПAPAMETPOB:
C--
C--      1.        TИП ПAPAMETPA (0 - ПOЗИЦИOHHЫЙ, 1 - KЛЮЧEBOЙ)
C--      2.        KЛЮЧ ИЛИ HOMEP ПOЗИЦИИ
C--      3.        ЗHAЧEHИE ПAPAMETPA ПO YMOЛЧAHИЮ
C--      4.        HИЖHEE ПPEДEЛЬHOE ЗHAЧEHИE ПAPAMETPA
C--      5.        BEPXHEE ППPEДEЛЬHOE ЗHAЧEHИE ПAPAMETPA
C
          DIMENSION KEYWRD(4,5)
         DATA NKEY /4/
         DATA KEYWRD /    1     ,    1   ,   1    ,   1    ,
     2                  'UNIT  ','BLKSIZ','LRECL ','LABEL ',
     3                    1     ,   80   ,   80   ,    1   ,
     4                    1     ,   80   ,    4   ,    1   ,
     5                   15     ,  6144  ,   80   ,  9999
     *                /
C--
C--      CTYKTYPA TAБЛ.ДOПYCT.TИПOB:
C--
C--      1.        TИП ФPAГMEHTA
C--      2.        ПEPBЫЙ ДOПYCTИMЫЙ PAЗДEЛИTEЛЬ
C--      3.        AЛЬTEPHATИBHЫЙ PAЗДEЛИTEЛЬ
C
         DIMENSION ITOLER(3,2)
          DATA ITOLER/
     *                  4,'=','='
     *,                 2,',',' '
     *                /
          COMMON /SLATE/ ND,  NE, CPC(40)
         DIMENSION ITEMP(80),IFRAG(80),IOTSTR(80)
         DIMENSION ERRTXT(6,2)
         DATA ERRTXT / 36H*** OШИБKA B KЛЮЧEBOM CЛOBE ***
     *,                36H*** HEBEPHOE ЗHAЧEHИE ПAPAMETPA ***
     *               /
         LOGICAL LEOF
       DIMENSION IEND(2)
       DATA IEND /'*READ ','OLD'/
       DATA IBEG /0/
C
C     PRINT 8000,IBEG
C8000 FORMAT(' *** PAЗБOP ***',O16)
         IF (IBEG .NE. 0)              GO TO   12
       KOD = JBYT(ITOLER(2,2),41,8)
       KOД = KOD
C--
C--      ПPИCBOИM YMOЛЧAHИЯ
C
         DO 10 I=1,NKEY
   10    KEY(I) = KEYWRD(I,3)
C
   12    CONTINUE
         LEOF = IEND(1).EQ.ICARD(1).AND.IEND(2).EQ.ICARD(2)
         ITMP = IBEG
         IBEG = -1
         IF (LEOF .AND. ITMP .EQ. 0)   GO TO 1000
         IBEG = 1
         IF (LEOF .OR. KOD .NE.KOД)    GO TO 1000
C--
C--      YБEPEM ПPOБEЛЫ
C
         CALL UBLOW(ICARD,ITEMP,80)
         CALL ULEFT(ITEMP,1,80)
         CALL UBUNCH(ITEMP,ICARD,80)
C
         ISTEP = 1
         CALL SCANER(ICARD,IFRAG,0,ITYP,KOD,IPOINT)
   15    CONTINUE
C      PRINT 8015,IFRAG(1),ITYP,KOD
C8015  FORMAT(' 15:',3O16)
C
         IDEF1 = JBYT(ITOLER(2,ISTEP),41,8)
         IDEF2 = JBYT(ITOLER(3,ISTEP),41,8)
         IF (ITYP .NE. ITOLER(1,ISTEP)
     *       .OR. (KOD .NE. IDEF1 .AND.
     *             KOD .NE. IDEF2))      GO TO  100
C
                                         GO TO (20,30), ISTEP
C--
C--      PACПOЗHAEM KЛЮЧ
C
   20    CONTINUE
         KK = IUCOMP(IFRAG,KEYWRD(1,2),NKEY)
         IF (KK .LE. 0)                 GO TO 100
         ISTEP = 2
                                        GO TO  40
C--
C--      OПPEДEЛИM ЗHAЧEHИE ПAPAMETPA
C
   30    CONTINUE
C      PRINT 8030,IFRAG(1),KK
C8030  FORMAT(1X,2O16)
         IF (IFRAG .LT. KEYWRD(KK,4) .OR.
     *       IFRAG .GT. KEYWRD(KK,5))  GO TO  100
         KEY(KK) = IFRAG
         ISTEP = 1
C--
C--      ПOШЛИ ЗA CЛEДYЮЩИM ПAPAMETPOM
C
   40    CONTINUE
         IF (IPOINT .GE. NE-1)         GO TO  999
         CALL SCANER(0,IFRAG,0,ITYP,KOD,IPOINT)
                                       GO TO   15
C======================================================================
C--
C--      PEAKЦИЯ HA OШИБKИ
C
  100    CONTINUE
         CALL VBLANK(IOTSTR,80)
         IOTSTR(IPOINT) = '$'
         PRINT 9100,(ERRTXT(I,ISTEP),I=1,6),ICARD,IOTSTR
         STOP
C----------------------------------------------------------------------
C--
C--      O'KEY
C
  999    CONTINUE
         NBLKS = BLKSIZ/LRECL
         IF (KOD .NE. KOД)   IBEG=-1
 1000    PAЗБOP = IBEG
         RETURN
 9100    FORMAT(20X,6A6/20X,13A6,A2/20X,80A1)
         END
      SUBROUTINE PEC(K,S)
C*
C*****   4.1.84   A.П.CAПOЖHИKOB
C*
C*   USER - SUBROUTINE PEДAKTOPA
C*   ДЛЯ ИЗBЛEЧEHИЯ BHEШHИX KOMMEHTAPИEB
C*   ИЗ ФAЙЛA TEKCTOB ПPOГPAMM.
C*
C*   KAЖДAЯ CTPOKA BHEШHEГO KOMMEHTAPИЯ
C*   HAЧИHAETCЯ C ПAPЫ CИMBOЛOB:  C* ...
C*
C*   KOMMEHTAPИИ ПEЧATAЮTCЯ HA ЛИCTИHГE,
C*   A TAKЖE ЗAПИCЫBAЮTCЯ B ФAЙЛ ЗAПИCИ,
C*   ECЛИ TAKOBOЙ БЫЛ YKAЗAH.
C*   OTTYДA OHИ MOГYT БЫTЬ PACПEЧATAHЫ
C*   ПAKETHЫM PEДAKTOPOM TEKCTOB
C*   C ПOMOЩЬЮ ДИPEKTИBЫ:  *LT
C*
      COMMON /NAME/ NAM(2),ITYP
      DIMENSION K(14),NK(4),MH(14,11),LIST(1000)
      DATA MSW/1/, LEN/9/, IND/1/, MEND/0/
      DATA MH/'C*',13(' '),'C*----',9('------'),121(' ')/
      DATA LIST/1000(' ')/, NK/'HET KOHЦA :          '/
C---
      IF(K.EQ.'*READ') GOTO 900
      IF(MSW.NE.1) GOTO 200
C...    ПPOБA HA ЗAГOЛOBOK
      CALL HEADLP(K)
      IF(NAM.EQ.' '.OR.ITYP.EQ.0) RETURN
      DO 101 I=1,12
 101  MH(I+2,3)=K(I)
      MH(1,3)=K(13)
      MH(2,3)=K(14)
      MEND=1
      NK(3)=NAM(1)
      NK(4)=NAM(2)
      LTYP='     A'
      DO 102 I=1,50
      LET=IGETS(K,I)
      IF(LET.EQ.58) GOTO 103
 102  CONTINUE
      LTYP='     F'
 103  NSTRI=4
      KOMM=1
      MSW=2
      LNAM=JCOUNS(NAM) + JCOUNS(NAM(2))
      CALL IPUTS(32,MH(1,2),57-LNAM)
      CALL IPUTS(LTYP,MH(1,2),58-LNAM)
      CALL IPUTS(58,MH(1,2),59-LNAM)
      DO 104 I=1,LNAM
 104  CALL IPUTS(IGETS(NAM,I-1),MH(1,2),I+59-LNAM)
      IF(IND.GE.1000) RETURN
      IND=IND+2
      LIST(IND)=NAM(1)
      LIST(IND+1)=NAM(2)
      RETURN
C...    ПPOБA HA KOMMEHTAPИЙ
 200  LET=LEXOR(K,'C*').SHIFT.32
      IF(LET.NE.0B) GOTO 300
      DO 201 I=1,12
 201  MH(I,NSTRI)=K(I)
      NSTRI=NSTRI+1
      IF(NSTRI.LT.LEN) RETURN
      NSTRI=NSTRI-1
C...    CБPOC БYФEPA KOMMEHTAPИEB
      DO 202 I=KOMM,NSTRI
      M11=MH(11,I) $ MH(11,I)=6H
      M12=MH(12,I) $ MH(12,I)=6H
      CALL S(MH(1,I))
      CALL LLФPRI(MH(1,I),MH(10,I),1B)
      IF(M11.EQ.' '.AND.M12.EQ.' ') GOTO 202
      MH(2,1)=M11 $ MH(3,1)=M12
      CALL LLФPRI(MH(1,1),MH(10,1),1B)
      MH(2,1)=' ' $ MH(3,1)=' '
 202  CONTINUE
      KOMM=NSTRI
      RETURN
C...    ПPOБA HA KOHEЦ ПPOГPAMMЫ
 300  NAM=6H
      ITYP=0
      DO 301 I=1,72
      LET=IGETS(K,I-1)
      IF(LET.EQ.32) GOTO 301
      CALL IPUTS(LET,NAM,ITYP)
      ITYP=ITYP+1
      J=JSEART( ',END, END', 1,2,NAM )
      IF(J.EQ.0) RETURN
      IF(ITYP.EQ.5) GOTO 302
 301  CONTINUE
 302  MSW=1
      MH(9,2)='------' $ MH(10,2)='------'
      MEND=0
      IF(KOMM.EQ.1) RETURN
      CALL S(MH(1,2))
      CALL LLФPRI(MH(1,2),MH(10,2),1B)
      IF(IND.GT.1.AND.IND.LT.1000) IND=IND-2
      RETURN
C...    KOHEЦ ФAЙЛA
 900  IF(MEND.NE.0) CALL LLФPRI(NK,NK(4),10B)
      IF(IND.EQ.1) GOTO 910
      IF(KOMM.NE.1) LIST(IND)=6H
      IF(KOMM.NE.1) LIST(IND+1)=6H
      LIST(1)='HE OПИ'
      LIST(2)='CAHЫ:'
      IND=-9
 901  IND=IND+10
      LAST=IND+9
      IF(IND.GT.1000) GOTO 910
      DO 902 I=IND,LAST
      IF(LIST(I).EQ.' ') GOTO 902
      CALL LLФPRI(LIST(IND),LIST(LAST),1B)
      GOTO 901
 902  CONTINUE
 910  CALL S(K)
      RETURN
      END
      SUBROUTINE PREASP(K,S)
C*
C***     USER-SUBROUTINE ДЛЯ ПEPEBOДA
C*     BPYЧHYЮ CФOPMATИPOBAHHЫX TEKCTOB
C*              B ASPID.
C*
C*     HOMEPA KAPT ГACЯTCЯ.
C*     COБCTBEHHЫE ПEPEHOCЫ CЛOB ИЗЫMAЮTCЯ.
C*     1-Я ПOЗИЦИЯ KAЖДOЙ CTPOKИ MOЖET
C*     COДEPЖATЬ YПPABЛЯЮЩИE CИMBOЛЫ :
C*       1 - "HOBAЯ CTPAHИЦA"
C*       0 - "HOBЫЙ AБЗAЦ"
C*     ECЛИ CTPOKA HAЧИHAETCЯ C TPEX ИЛИ
C*     БOЛEE ПPOБEЛOB, A TAKЖE ECЛИ ПEPBЫM
C*     OTЛИЧHЫM OT ПPOБEЛA CИMBOЛOM ЯBЛЯETCЯ
C*     "-", ДEЛAETCЯ KPACHAЯ CTPOKA.
C*
C*     ПOЛYЧEHHЫЙ ФAЙЛ MOЖET БЫTЬ PACПEЧATAH
C*     ПO YПP.KAPTE   *READ: ...
C*
      DIMENSION K(14),KK(14),LPER(40),MON(14,10)
      DATA MPER/0/, MINUS/45/, MON/
     1   '*LIBRA:23,24               ',9(' '),
     2   '*CALL KILNUMPG             ',9(' '),
     3   '*CALL ASPID                ',9(' '),
     4   '%CK # #CHП _ #CCБ & #CПБ @ ',9(' '),
     5   '#ДCK62 #ДCЦ60 #PП #HCЦ1    ',9(' '),
     6   '#MAKPO HA #A0 #БC1 #BC2 #CГ0 #A3 #KOHMAK',7(' '),
     7   '#HOBCЦ                     ',9(' '),
     8   '#HA                        ',9(' '),
     9   '#A3                        ',9(' '),
     *   '#KP                        ',9(' ') /
      DATA JNEWP/7/, JNA/8/, JA3/9/, JKP/10/, JFIRST/0/
C---
      K(13)=' ' $ K(14)=' '
      IF(K(1).EQ.'*READ'.AND.K(2).EQ.'OLD') GOTO 100
      IF(JFIRST.NE.0) GOTO 2
      DO 1 I=2,JNEWP
   1  CALL S(MON(1,I-1))
      JFIRST=1
C---
   2  N=0 $ N2=0
      IF(MPER.EQ.0) GOTO 10
      DO 3 I=1,14
   3  KK(I)=6H
      DO 4 I=1,MPER
   4  CALL IPUTS(LPER(MPER-I+1),KK,I)
      LET=IGETS(K,0)
      IF(LET.GE.48.AND.LET.LE.57) N=1
   5  LET=IGETS(K,N) $ N=N+1
      IF(LET.EQ.32.AND.N.LT.72) GOTO 5
   6  MPER=MPER+1
      CALL IPUTS(LET,KK,MPER)
      CALL IPUTS(32,K,N-1)
      LET=IGETS(K,N) $ N=N+1
      IF(LET.NE.32) GOTO 6
      N2=N-1 $ MPER=0
      CALL S(KK)
C---
  10  LET=IGETS(K,0)
      IKAP=JNEWP $ IF(LET.EQ.49) GOTO 11
      IKAP=JNA $ IF(LET.NE.48) GOTO 12
  11  CALL S(MON(1,IKAP))
      CALL IPUTS(32,K,0)
C---
  12  LAST=72
      DO 13 I=1,72
      N=I
      LET=IGETS(K,N-1)
      IF(LET.NE.32) GOTO 14
  13  CONTINUE
      IF(N.EQ.72) RETURN
  14  IF(N2.NE.0) GOTO 15
      IF(N.GT.3.OR.LET.EQ.MINUS) CALL S(MON(1,JA3))
  15  LAST=LAST-1  $ LET=IGETS(K,LAST)
      IF(LET.EQ.32) GOTO 15
      IF(LET.NE.MINUS) GOTO 20
      LET=IGETS(K,LAST-1)
      IF(LET.EQ.32) GOTO 20
      CALL IPUTS(32,K,LAST)
  16  MPER=MPER+1  $ LPER(MPER)=LET
      LAST=LAST-1
      CALL IPUTS(32,K,LAST)
      IF(LAST.LT.N) RETURN
      LET=IGETS(K,LAST-1)
      IF(LET.NE.32) GOTO 16
      GOTO 20
C---
 100  CALL S(MON(1,JKP))
  20  CALL S(K)
      RETURN
      END
      SUBROUTINE PUTOUT
C*
C*  HOЯБPЬ 1987Г.               A. ДABЫДOB
C*
C*      ИCПOЛHИTEЛЬHAЯ ЧACTЬ
C*      ПPOГPAMMЫ  LISTING
C*
      COMMON // ICЛYЖ,MEC,FCPLUS,NPASS,NZOUT
      COMMON /PROTO/ AP,NUNIT,NL,NF,INT,KAP(15)
C
C        ЛИCTOBOЙ  COMMON(!):
      COMMON /POUT/ IPOUT(1024),IBUF(1024)
C
      DIMENSION IFRAG(15),MTFDB(8)
     *,ISCAL(16),NAMFIL(15),ISTR(22),ISTR2(14)
C
      LOGICAL MEC,FCPLUS,FRPT
C
C  MEC    - ПPИЗHAK MЛ EC
C  FCPLUS - B KATAЛOГE ПPOCTABЛEH ПPИЗHAK
C           "ИДET ПEЧATЬ"
C
      MEC=.FALSE.$ FCPLUS=.FALSE.$ FRPT=.FALSE.
10    ASSIGN 20 TO NQ
20    CALL DIALOQ('HOMEP ПO ФAЙЛY BЫBOДA: ',23,0)
      CALL SCANER(KAP,IFRAG,4,ITYP,KOD,IPOZ)
      IF (IFRAG.EQ.1HE) GOTO 777
      IF (ITYP.NE.1) GOTO 900
      NREC=IFRAG.OR.0
      IF (NREC.LE.0.OR.NREC.GE.64) GOTO 900
      IF (FRPT.AND.MEC) GOTO 60
      ASSIGN 30 TO NQ
C
30    CONTINUE
      CALL DIALOQ('KYДA ЗAПИCATЬ: ',15,0)
      IW=KAP
      CALL CHANGE(IW,1,0B,1H )
      IF (IW.EQ.1HE) GOTO 777
      MTFDB(7)=1HW $ MTFDB(2)=47
      CALL TAKTAP(47)
      DO 33 I=1,15
33    NAMFIL(I)=6H
      DO 34 I=1,72
      J=IGETS(KAP,I-1)
      IF (J.EQ.0) GOTO 35
      CALL IPUTS (J,NAMFIL,I-1)
34    CONTINUE
      GOTO 900
35    LNF=I-1
      J=JFOCC(NAMFIL,MTFDB)
      IF (J.NE.0) GOTO 910
      IF (MTFDB(1).EQ.1) GOTO 100
      IF (MTFDB(1).NE.4) GOTO 901
C
C         ЗAПИCЬ HA MЛ EC
      LUN=MTFDB(2)-32
      NZ=1
      IF (LUN.LE.0.OR.LUN.GT.15) GOTO 902
C
C   BЫЯCHЯEM:   B KAKOЙ ФAЙЛ ЗAПИCЫBATЬ
C
      ASSIGN 42 TO NQ
40    J=MT9(LUN,7)
42    CALL DIALOQ('C HAЧAЛA ЛEHTЫ?  [Y/N/HOMEP]:',30,0)
      CALL SCANER(KAP,IFRAG,0,ITYP,KOD,IPOZ)
      IF (ITYP.NE.2) GOTO 50
C
C         ЗAДAH HOMEP ФAЙЛA
C
      IF (IFRAG.LE.0.OR.IFRAG.GT.999) GOTO 903
      L=IFRAG-1
      IF (L.EQ.0) GOTO 45
      ASSIGN 40 TO NQ
      DO 44 I=1,L
      J=MT9(LUN,5)
      IF (J.NE.1027) GOTO 904
44    CONTINUE
45    NZ=IFRAG
      GOTO 60
50    IF (IFRAG.EQ.1HE) GOTO 777
      IF (IFRAG.EQ.1HY) GOTO 60
      IF (IFRAG.NE.1HN) GOTO 900
C
C        ПOИCK KOHЦA ЛEHTЫ
C
      ASSIGN 30 TO NQ
      IF=0 $ NZ=0
      DO 56 I=1,999
      J=MT9(LUN,3)
      IF (J.GE.0.AND.J.LE.1024) GOTO 54
      IF (J.NE.1027) GOTO 905
      NZ=NZ+1
      IF (IF.EQ.1) GOTO 57
      IF=1
      GOTO 56
54    IF=0
56    CONTINUE
      GOTO 905
57    CONTINUE
      J=MT9(LUN,4)
60    CONTINUE
C
C        ПOДBOД ЗAKOHЧEH
C
      MEC=.TRUE.
      GOTO 120
C
C
100   CONTINUE
      ASSIGN 110 TO NQ
110   CALL DIALOQ('ЗOHA: ',6,0)
      CALL SCANER(KAP,IFRAG,4,ITYP,KOD,IPOZ)
      IF (IFRAG.EQ.1HE) GOTO 777
      IF (ITYP.NE.1) GOTO 900
      IF (IFRAG.LT.0) GOTO 900
      ASSIGN 30 TO NQ
      IF (IFRAG.GT.MTFDB(3)) GOTO 906
      NZ=IFRAG.OR.0
      MEC=.FALSE.
120   CONTINUE
      IF=0
      GOTO 123
122   CALL CLOSE
123   CALL RCO
      N=NREC*5
      IF (ICЛYЖ.EQ.1) GOTO 126
      I=IPOUT(N+2).AND.1777B.OR.0
      IF (I.NE.NPASS) GOTO 907
126   I=IPOUT(N+1).AND.2000 0000 0000 0000B
      IF (I.EQ.0B) GOTO 130
C
C   ЭЛEMEHT ФAЙЛA BЫBOДA EЩE HE ГOTOB
C
      CALL OPCOUT
      IF (IF.EQ.1) GOTO 122
      CALL DIALOG('ЛИCTИHГ B PAБOTE: ПPИДETCЯ ПOДOЖДATЬ',36,-1)
      IF=1
      GOTO 122
130   IPOUT(N+1)=IPOUT(N+1).OR.1000 0000 0000 0000B
      FCPLUS=.TRUE.
      CALL WCO
C
C
      NZOUT=IPOUT(N+1).AND.777B.OR.0
      LZOUT=IPOUT(N+1).SHIFT.9.AND.777B.OR.0
      DO 133 I=1,18
      IF ( IGETS (IPOUT(N+3),I-1) .EQ.0 ) GOTO 134
133   CONTINUE
      I=19
134   CALL PUTH(ISTR,IPOUT(N+3),0,I-1,0,IPOZ)
      CALL PUTH(0,' ==> ',0,5,0,IPOZ)
      CALL PUTH(0,NAMFIL,0,LNF,0,IPOZ)
      IF (MEC) GOTO 135
C
C           ДЛЯ  БЭCM - ФOPMATA:
C
      CALL PUTH(0,'  Z=',0,4,0,IPOZ)
      CALL PUTO(0,NZ,0,4,5,IPOZ)
      CALL PUTH(0,'  (ISO)',0,7,0,IPOZ)
      IBLANC=40B $ MBLANC=6H
      CALL WBEGIN(MTFDB(2).SHIFT.-12.OR.(NZ.AND.7777B))
      GOTO 140
135   CONTINUE
C
C           ДЛЯ  EC - ФOPMATA:
C
      CALL PUTH(0,'  ФAЙЛ ',0,7,0,IPOZ)
      CALL PUTG(0,NZ,0,3,0,IPOZ)
      CALL PUTH(0,'  (ДKOИ)',0,8,0,IPOZ)
      IBLANC=100B $ MBLANC=6H@@@@@@
C
C           OБЩAЯ ЧACTЬ
C
140   CONTINUE
      CALL DIALOQ(ISTR,IPOZ,0)
      CALL CHANGE(KAP,1,0B,1H )
      IF (KAP.EQ.1HE) GOTO 777
      IF (KAP.EQ.1HN) GOTO 10
      DO 142 I=1,16
142   ISCAL(I)=0B
      FRPT=.FALSE.
      ASSIGN 150 TO MR
C
C     ---------------------------
2000  CONTINUE
C
C   ЧTEHИE ЗOHЫ NZOUT ФAЙЛA BЫBOДA
C
C   ПOДПPOГPAMMA, BOЗBPAT ПO MR.
C
      IF (NZOUT.EQ.0) GOTO 144
      NBIT=NZOUT.AND.37B.OR.0
      NWORD=NZOUT.SHIFT.5.AND.17B.OR.0
      IBIT=4000 0000 0000 0000B.SHIFT.NBIT
      ISCAL(NWORD+1)=ISCAL(NWORD+1).OR.IBIT
      CALL RZO
      I=IPOUT(1).SHIFT.30.AND.77B.OR.0
      IF (I.EQ.NREC) GOTO 146
144   CALL DIALOG('ЛИCTИHГ БEЗ XBOCTA!',19,-1)
      GOTO 260
146   NZOUT=IPOUT(1).AND.777B.OR.0
      GOTO MR
C     ------------------------------
C
150   CONTINUE
      LZ=0
      JW=1
      ASSIGN 10 TO NQ
C
C          Ф A З A   З A П И C И
C
C    ЦИKЛ OБPAБOTKИ OДHOЙ ЗOHЫ ФAЙЛA BЫBOДA
C
      ISW=4
C  ISW:   1 - ПPOПYCK ДBOИЧHOЙ ПOPЦИИ
C         2 - HAЧAЛO CTPOKИ
C         3 - ПPИEM CTPOKИ
C         4 - HAЧAЛO PAБOTЫ
C
155   DO 250 JR=11,1024
      IW=IPOUT(JR)
      GOTO (160,170,180,175) ISW
160   L=L-1
      IF (L.NE.0) GOTO 250
      ISW=2
      GOTO 250
170   IF (IW.EQ.7777 7777 7777 7777B) GOTO 260
      IS=IGETS(IW,0)
      IF (IS.NE.254) GOTO 172
C
C        ДBOИЧHAЯ ПOPЦИЯ
      L=IW.AND.77777B.OR.0
      ISW=1
      GOTO 250
172   CONTINUE
C
C        HAЧAЛO OЧEPEДHOЙ CTPOKИ
      DO 173 I=1,22
173   ISTR(I)=MBLANC
      ISW=3
      JWS=4
      LL=2
      CALL PUTG(ISTR,IS,1,3,0,IPOZ)
      IF (.NOT.MEC) GOTO 182
      ISTR(1)=ISTR(1).OR.7417 0360 0000 0000B
      CALL PUTH(0,MBLANC,0,1,0,IPOZ)
      GOTO 182
175   IS=1
      GOTO 172
180   LL=1
C       ПOCИMBOЛЬHOE CKAHИPOBAHИE
182   DO 199 I=LL,6
      IS=IGETS(IW,I-1)
      IF (IS.EQ.126) GOTO 200
      IF (IS.LT.128) GOTO 195
      L=IS-128
C       L  COДEPЖИT  K-BO ПPOБEЛOB - 1
      JWL=JWS+L
      DO 184 J=JWS,JWL
      CALL IPUTS (IBLANC,ISTR,J)
184   CONTINUE
      JWS=JWL+1
      GOTO 199
195   CONTINUE
      CALL IPUTS (JCTR(IS),ISTR,JWS)
      JWS=JWS+1
199   CONTINUE
      GOTO 250
200   CONTINUE
C
C   ПPИHЯT CИMBOЛ  "KOHEЦ CTPOKИ"
C
      IF (MEC) GOTO 220
C
C       ЗAПИCЬ CTPOKИ B БЭCM - ФOPMATE
C
      DO 204 I=1,14
204   ISTR2(I)=MBLANC
      DO 208 I=4,67
      CALL IPUTS ( IGETS (ISTR,I+64) , ISTR2, I)
208   CONTINUE
      ISTR(12)=ISTR(12).AND.7777 7400 0000 0000B.OR.40 1002 0040B
      ISTR(13)=MBLANC
      ISTR(14)=MBLANC
      CALL WRCARD(ISTR)
      CALL WRCARD(ISTR2)
      GOTO 245
C
C       ЗAПИCЬ CTPOKИ B EC - ФOPMATE:
C
220   CONTINUE
      ASSIGN 245 TO MR
C    - - - - - - - - - - -
C
C    П/П ЗAПИCИ CTPOKИ HA MЛ EC.
C    BOЗBPAT ПO MR.
C
2010  DO 240 I=1,22
      IBUF(JW)=ISTR(I)
      JW=JW+1
      IF (JW.NE.1025) GOTO 240
      ASSIGN 234 TO MR2
C
C    CБPOC БYФEPA MЛ EC.
C    ПOДПPOГPAMMA, BOЗBPAT ПO MR2.
C
2020  JW=1
      LZ=LZ+1
      DO 230 IC=1,4
      DO 226 IE=1,3
C          ЗAПИCЬ
      J=MT9A(LUN,12,IBUF)
      IF (J.EQ.1024) GOTO MR2
C          OШИБKA ЗAПИCИ:
      IF (J.GT.1024) GOTO 908
C          PEBEPC
      J=MT9(LUN,4)
C          ПOBTOP ЗAПИCИ
226   CONTINUE
C       TPИ ПOПЫTKИ ЗAПИCИ HEYДAЧHЫ.
C          CTИPAHИE
      J=MT9(LUN,10)
C          ПOBTOP CTИPAHИЯ
230   CONTINUE
C       ЧETЫPE CTИPAHИЯ YCПEXA HE ПPИHECЛИ.
C       KOHЧAEM.
      GOTO 909
C     ------------------------------------
234   CONTINUE
240   CONTINUE
      GOTO MR
C     ------------------------------------
C
245   CONTINUE
C
C        CTPOKA ЛИCTИHГA ЗAПИCAHA
C
      ISW=2
250   CONTINUE
C
C   OЧEPEДHAЯ  ЗOHA  ФAЙЛA  BЫBOДA  OБPAБOTAHA
C
      ASSIGN 155 TO MR
      GOTO 2000
C      . . . . . . . . . . . . . . . . .
260   CONTINUE
C
C         K O H E Ц   Л И C T И H Г A
C
      IF (.NOT.MEC) GOTO 280
C
C           ДЛЯ  EC:
C
      DO 262 I=2,22
262   ISTR(I)=MBLANC
      ISTR(1)=7637 4771 7417 0360B
C       ЗAПИCЬ CTPOKИ  "999" HA MЛ EC
      ASSIGN 264 TO MR
      GOTO 2010
264   IF (JW.EQ.1) GOTO 266
C       ДOCБPOC БYФEPA
      ASSIGN 266 TO MR2
      GOTO 2020
266   CONTINUE
C       ЗAПИCЬ  TPEX  "EOF"
      J=MT9(LUN,9)
      J=MT9(LUN,9)
      J=MT9(LUN,9)
C       ПOДBOД ЗA ПEPBЫЙ "EOF"
      J=MT9(LUN,4)
      J=MT9(LUN,4)
      NZ=NZ+1
      GOTO 300
C
C  ---   ДЛЯ  MЛ  БЭCM-6   ---
C
280   CONTINUE
      DO 282 I=1,14
282   ISTR(I)=MBLANC
      ISTR(1)=6H999
      CALL WRCARD(ISTR)
      CALL WRCARD(ISTR)
      ISTR(1)=6H*READ
      ISTR(2)=6HOLD
      CALL WRCARD(ISTR)
      LZ=NZTX(0)-NZ+1
      CALL WRIEND
C
C..........................................
C
C       Л И C T И H Г   З A П И C A H
C
300   CONTINUE
C
C      KOHEЧHЫE MAHИПYЛЯЦИИ C KATAЛOГOM
C
      CALL RCO
      N=NREC*5
      IPOUT(N+1)=IPOUT(N+1).AND.6777 7777 7777 7777B
      FCPLUS=.FALSE.
      I=IPOUT(N+1).SHIFT.47
      IF (I.EQ.0B) GOTO 304
C       OCBOБOЖДEHИE ЗOH ФAЙЛA BЫBOДA
      DO 302 I=1,16
      IPOUT(992+I)=ISCAL(I).OR.IPOUT(992+I)
302   CONTINUE
C       OCBOБOЖДEHИE ЭЛEMEHTA KATAЛOГA
      NBIT=NREC.AND.3B.OR.0
      NWORD=NREC.SHIFT.2.AND.17B.OR.0
      IBIT=4000 0000 0000 0000B.SHIFT.NBIT
      IPOUT(977+NWORD)=IPOUT(977+NWORD).OR.IBIT
C       CHИMAEM ПPИЗHAK "ГOTOB K PAЗГPYЗKE"
      IPOUT(N+1)=(IPOUT(N+1).SHIFT.-1).SHIFT.1
304   CONTINUE
C       ЗAПИCЬ  KATAЛOГA
      CALL WCO
C
C        ФOPMИPOBAHИE ИTOГOBOЙ CTPOKИ
C
      CALL PUTH(ISTR,'ЗAПИCAHO ',0,9,0,IPOZ)
      IF (MEC) GOTO 305
      CALL PUTO(0,LZ,0,3,3,IPOZ)
      CALL PUTH(0,' ЗOH',0,4,0,IPOZ)
      GOTO 306
305   CALL PUTG(0,LZ,1,3,0,IPOZ)
      CALL PUTH(0,' БЛ.',0,4,0,IPOZ)
306   CALL DIALOG(ISTR,IPOZ,-1)
      FRPT=.TRUE.
      GOTO 10
C
C===========================================
C
777   IF (.NOT.FCPLUS) GOTO 780
      CALL RCO
      N=NREC*5
      IPOUT(N+1)=IPOUT(N+1).AND.6777 7777 7777 7777B
      CALL WCO
      FCPLUS=.FALSE.
780   CONTINUE
      CALL DIALOG('ДO CBИДAHИЯ!',12,-1)
      CALL DIALOP(0)
      RETURN
C
C
C       Д И A Г H O C T И K A
C
900   CALL DIALOG('OШИБKA.',7,-1)
      GOTO NQ
901   CALL DIALOG('TAK HEЛЬЗЯ!',11,-1)
      GOTO NQ
902   CALL DIALOG('OШ. MAT. HOMEP',14,-1)
      GOTO NQ
903   CALL DIALOG('HOMEP ФAЙЛA Д.Б. OT 1 ДO 999!',29,-1)
      GOTO NQ
904   CALL DIALOG('ФAЙЛ HE HAЙДEH',14,-1)
      GOTO NQ
905   CALL DIALOG('HE HAЙДEH KOHEЦ ЛEHTЫ',21,-1)
      GOTO NQ
906   CALL DIALOG('ПPEBЫШEHA ДЛИHA',15,-1)
      GOTO NQ
907   CALL DIALOG('ЧYЖOЙ ЛИCTИHГ!',14,-1)
      CALL OPCOUT
      GOTO 10
908   CALL DIALOG('ФATAЛЬHAЯ OШИБKA ЗAПИCИ',23,-1)
      GOTO 400
909   CALL DIALOG('HE ИДET ЗAПИCЬ',14,-1)
400   CONTINUE
      IF (.NOT.MEC) GOTO 777
C
C       ЗAПИCЬ ДECЯTKA "EOF"
C
      DO 401 I=1,10
401   J=MT9(LUN,9)
      FRPT=.FALSE.
      GOTO 10
910   CONTINUE
      CALL DIALOG(MTFDB(4),18,-1)
      GOTO NQ
      END
      SUBROUTINE QHSORT ( N, IEXCH )
C*
C***   10.2.86.   A.П.CAПOЖHИKOB
C*
C*   AЛГOPИTM T.H. БЫCTPOЙ COPTИPOBKИ XOAPA.
C*   (CM., HAПPИMEP, Y Д.KHYTA.)
C*   N - ЧИCЛO COPTИPYEMЫX ЗAПИCEЙ.
C*   CПOCOБ XPAHEHИЯ ЗAПИCEЙ B ПAMЯTИ И
C*   CПOCOБ CPABHEHИЯ ИX KЛЮЧEЙ OПPEДEЛЯETCЯ
C*   ФYHKЦИEЙ ЮЗEPA   IEXCH(I,J)
C*   ГДE    1 <= I,J <= N.
C*   ЖEЛAЯ CPABHИTЬ I-Ю ЗAПИCЬ C J-Й,
C*   AЛГOPИTM OБPAЩAETCЯ K ФYHKЦИИ ЮЗEPA
C*   IEXCH(I,J),  KOTOPAЯ OБЯЗAHA :
C*    A).  BЫДATЬ 0, ECЛИ I-Я ЗAПИCЬ
C*         ДOЛЖHA ПPEДШECTBOBATЬ J-Й;
C*    Б).  B ПPOTИBHOM CЛYЧAE - ПOMEHЯTЬ
C*         ЗAПИCИ MECTAMИ И BЫДATЬ 1.
C*   MEДИAHA ПPИ PAЗДEЛEHИИ HA ПOДФAЙЛЫ
C*   BЫБИPAETCЯ CЛYЧAЙHЫM OБPAЗOM.
C*
C*   SUBROUTINE SISORT ( N, IEXCH )
C*   AЛГOPИTM COPTИPOBKИ METOДOM ПPOCTЫX
C*   BCTABOK.  ИHTEPФEЙC TOЧHO TAKOЙ ЖE.
C*   SISORT PEKOMEHДYEM TOЛЬKO ПPИ N<25.
C*   QHSORT ПPИГOДEH ДЛЯ COPTИPOBKИ KAK B
C*   OПEPATИBHOЙ, TAK И B BИPTYAЛЬHOЙ ПAMЯTИ.
C*
      INTEGER L,R,S(20)
      DATA M/7/
C
C---  HAЧAЛЬHOE ФOPMИPOBAHИE CTEKA
C
      K=2
      S(1) = N.OR. 1 0000 0000 B
      IF(N.LT.2) GOTO 100
      ASSIGN 1 TO MSIRET
C
C---  BЫБOPKA ИЗ CTEKA
C
   1  K=K-1
      IF(K.EQ.0) GOTO 100
      L = S(K).SHIFT.24.AND.3 777 777B.OR.0
      R = S(K).AND.3 777 777B.OR.0
   2  IF(R-L.LT.M) GOTO 50
C
C---  BЫБOP MEДИAHЫ
C
      I = L+(R-L)*RN01(0)
      IF(IEXCH(L,I).EQ.0) J=IEXCH(I,L)
      J = R+1  $  I = L
C
C---  ДBИЖEHИE BЛEBO
C
  10  J=J-1
      IF(I.GE.J) GOTO 30
      IF(IEXCH(I,J).EQ.0) GOTO 10
C
C---  ДBИЖEHИE BПPABO
C
  20  I=I+1
      IF(I.GE.J) GOTO 30
      IF(IEXCH(I,J).EQ.0) GOTO 20
      GOTO 10
C
C---  YCTAKAHИЛOCЬ. I-Я ЗAПИCЬ HA CBOEM MECTE.
C
  30  IF(I-L.GT.R-I) GOTO 40
C
C---  ПPABЫЙ ПOДФAЙЛ - B CTEK
C
      S(K) = (I+1).SHIFT.-24.OR.R
      R = I-1
      K = K+1  $  GOTO 2
C
C---  ЛEBЫЙ ПOДФAЙЛ - B CTEK
C
  40  S(K) = L.SHIFT.-24.OR.(I-1)
      L = I+1
      K = K+1  $  GOTO 2
C
C     COPTИPOBKA ПPOCTЫMИ BCTABKAMИ
C     =============================
C
      ENTRY SISORT
      L = 1  $  R = N
      ASSIGN 100 TO MSIRET
C
  50  IF(L.GE.R) GOTO 60
      J = L+1
  51  I = J
  52  IF(IEXCH(I-1,I).EQ.0) GOTO 53
      I=I-1
      IF(I.GT.L) GOTO 52
  53  J=J+1
      IF(J.LE.R) GOTO 51
C
  60  GOTO MSIRET,(1,100)
C
 100  RETURN
      END
      SUBROUTINE QINP(IF)
C************** 19/10-81 ****** ДABЫДOB A.Л.****
C*
C*  BBOД ДAHHЫX B ПЛABAЮЩEM ФOPMATE  C  П/K  ИЛИ
C*  C  TEPMИHAЛA.
C*
C*     KAЖДAЯ BBEДEHHAЯ CTPOKA - ЭTO HAБOP ПAPA-
C*  METPOB, PAЗДEЛEHHЫX MEЖДY COБOЙ PAЗДEЛИTEЛЯ-
C*  MИ.  ЗA  OДHO  OБPAЩEHИE  K  П/П  BЫБИPAETCЯ
C*  OДИH OЧEPEДHOЙ ПAPAMETP.  OБPAЩEHИE C IF=0 -
C*  - BBOД OЧEPEДHOЙ KAPTЫ И BЫБOPKA ПEPBOГO ПA-
C*  PAMETPA.
C*
C*  PEЖИMЫ PAБOTЫ П/П ЗAДAЮTCЯ  B  COMMONE  /Q/,
C*  PEЗYЛЬTAT PAБOTЫ - B  COMMON'E  /QP/.
C*----------------------------------------------
C*
C*  COMMON /Q/ ITYPE,LTT,ITT(20),ITAB,ILT
C*     P E Ж И M Ы   B B O Д A
C*  ITYPE = 0 - BBOД C KAPT
C*        = 1 - BBOД C ДИCПЛEЯ
C*  LTT   - ДЛИHA ПOДCKAЗKИ (B CИMBOЛAX)
C*          LTT=0 - БEЗ ПOДCKAЗKИ.
C*  ITT   - TEKCT ПOДCKAЗKИ.
C*  ITAB .NE.0 - ПPOБEЛ - PAЗДEЛИTEЛЬ
C*  ILT  .NE.0 - TEKCT HE MOЖET COДEPЖATЬ ЦИФP
C*          (T.E. ЦИФPA ПOCЛE БYKB И БYKBA ПOCЛE
C*          ЦИФP - HAЧAЛO HOBOГO ПAPAMETPA).
C*----------------------------------------------
C*
C*  COMMON /QP/ ISW,IT(10),INT,REAL,NTAB,LTEXT
C*     P E З Y Л Ь T A T   B B O Д A
C*  ISW - TИП ПAPAMETPA:
C*      1 - ПYCTO
C*      2 - TEKCT
C*      3 - ЦEЛOE (500,64)
C*      4 - BEЩECTBEHHOE БEЗ ДPOБHOЙ ЧACTИ (4.)
C*      5 - BEЩECTBEHHOE (3.62,8.12)
C*  IT    - BBEДEHHЫЙ TEKCT. ECЛИ OH ПOДДAETCЯ
C*          ПEPEBOДY, TO BCEГДA:
C*  INT   - BBEДEHHOE ЦEЛOE
C*  REAL  - BBEДEHHOE BEЩECTBEHHOE
C*  ..............................
C*  NTAB  - TИП PAЗДEЛИTEЛЯ:
C*      0 - KOHEЦ CTPOKИ
C*      1 - ЗAПЯTAЯ
C*      2 - ДBOETOЧИE
C*      3 - TOЧKA C ЗAПЯTOЙ
C*      4 - ПPOБEЛ
C*      5 - TOЧKA
C*      6 - OTKPЫBAЮЩAЯ CKOБKA
C*      7 - ЗAKPЫBAЮЩAЯ CKOБKA
C*      8 - BCE OCTAЛЬHOE
C*  LTEXT - ДЛИHA ПAPAMETPA  (B CИMBOЛAX).  ECЛИ
C*          ПAPAMETP HE ПOMEЩAETCЯ  B  IT, TO  B
C*          LTEXT - ЧИCЛO ПOMECTИBШИXCЯ CИMBOЛOB
C*
C*
C*             ПPИMEP PAЗБOPA
C*  BBEДEHA KAPTA:
C*  ДAHHЫE:4,8.5791,5.30.1.4ABC18
C*  ПYCTЬ  ILT.NE.0
C*
C*            PEЗYЛЬTAT PAЗБOPA:
C* --------------------------------------I
C* N.OБP.I ПAPAMETP I ISW I NTAB I LTEXT I
C* ------I----------I-----I------I-------I
C*    1. I ДAHHЫE   I   2 I    2 I     6 I
C*    2. I 4        I   3 I    1 I     1 I
C*    3. I 8.5791   I   5 I    1 I     6 I
C*    4. I 5        I   4 I    5 I     1 I
C*    5. I 30       I   4 I    5 I     2 I
C*    6. I 1.4      I   5 I    8 I     3 I
C*    7. I ABC      I   2 I    8 I     3 I
C*    8. I 18       I   3 I    0 I     2 I
C* --------------------------------------I
C*  ПPИ  ILT=0 ПOCЛEДHИM ПAPAMETPOM БYДET 4ABC18
C*----------------------------------------------
C*  COMMON /QCM/ NSUMB,LINP,LOUT
C*  ЭTO  HEKOTOPOE OПИCAHИE MAШИHЫ, HA KOTOPOЙ
C*  MЫ  PAБOTAEM:
C*  NSUMB - ЧИCЛO CИMBOЛOB B CЛOBE ЭBM.
C*  LINP  - ЛOГ. HOMEP ДИCПЛEЯ BBOДA
C*  LOUT  - ЛOГ. HOMEP ДИCПЛEЯ BЫBOДA
C*      ДЛЯ  БЭCM-6:
C*  NSUMB=6
C*  LINP=54
C*  LOUT=54
C*==============================================
      COMMON /Q/ ITYPE,LTT,ITT(20),ITAB,ILT
      COMMON /QP/ ISW,IT(10),INT,REAL,NTAB,LTEXT
      COMMON /QCM/ NSUMB,LINP,LOUT
      DIMENSION INP(40),IW(80),IFORM(8),I2(2)
      DATA IFORM/2H( ,7*2H  /
      DATA I2(2) /1H /
C.... LMAX - MAKC.ЧИCЛO CИMBOЛOB, ПOMEЩAЮЩEECЯ
C     B IT.
      LMAX=20
      IF(IF.NE.0)GOTO 20
      IF(NSUMB.EQ.6)GOTO 6
      IF(NSUMB.EQ.2)GOTO 2
      PRINT 90,NSUMB
   90 FORMAT(' QINP:  NSUMB M.Б. TOЛЬKO 2 ИЛИ 6'/
     *' (NSUMB=',I3,1H))
      STOP
    6 IF(ITYPE.NE.0)GOTO 7
C.... BBOД C П/K (6)
      READ 96,(INP(I),I=1,14)
   96 FORMAT(13A6,A2)
      GOTO 16
    7 CONTINUE
C.... BBOД C TEPMИHAЛA (6)
      READ (LINP,96)(INP(I),I=1,14)
      GOTO 16
    2 CONTINUE
      IF(ITYPE.NE.0)GOTO 3
C.... BBOД C KAPT (2)
      READ 92,INP
   92 FORMAT(40A2)
      GOTO 12
    3 CONTINUE
C.... BBOД C TEPMИHAЛA (2)
      READ (LINP,92) INP
   12 CONTINUE
   16 CONTINUE
      DECODE(80,93,INP)IW
  93  FORMAT(80A1)
      PRINT 94,IW
   94 FORMAT(3H - ,80A1)
C.... L - CЧETЧИK CИMB. B ПAPAMETPE,
C.... LM - CЧETЧИK CИMB. B CTPOKE.
C
      LM=0
C  JC - HOMEP COCTOЯHИЯ:
C   1 - HAЧAЛO PAЗБOPA
C   2 - ЦEЛOE
C   3 - БЫЛA TOЧKA B HAЧAЛE
C   4 - БЫЛA TOЧKA ПOCЛE ЦEЛOГO
C   5 - ДPOБHAЯ ЧACTЬ
C   6 - TEKCT
C
C NCS - TИП CИMBOЛA:
C   1 - KOHEЦ CTPOKИ
C   2 - ЗAПЯTAЯ
C   3 - TOЧKA C ЗAПЯTOЙ
C   4 - ДBOETOЧИE
C   5 - ПPOБEЛ
C   6 - TOЧKA
C   7 - OTKPЫBAЮЩAЯ CKOБKA
C   8 - ЗAKPЫBAЮЩAЯ CKOБKA
C   9 - БYKBA
C  10 - ЦИФPA
C..........................
C
   20 CONTINUE
      L=1
      JS=1
   30 CONTINUE
      I=LM+L
      IF(I.EQ.81)GOTO 77
C.... HE KOHEЦ CTPOKИ
C
C.... ПOЛYЧEHИE TИПA CИMBOЛA
      LITERA=IW(I)
      NCS=10
      IF(LITERA.EQ.1H0) GOTO 31
      IF(LITERA.EQ.1H1) GOTO 31
      IF(LITERA.EQ.1H2) GOTO 31
      IF(LITERA.EQ.1H3) GOTO 31
      IF(LITERA.EQ.1H4) GOTO 31
      IF(LITERA.EQ.1H5) GOTO 31
      IF(LITERA.EQ.1H6) GOTO 31
      IF(LITERA.EQ.1H7) GOTO 31
      IF(LITERA.EQ.1H8) GOTO 31
      IF(LITERA.EQ.1H9) GOTO 31
      NCS=2
      IF(LITERA.EQ.1H,) GOTO 31
      NCS=3
      IF(LITERA.EQ.1H;) GOTO 31
      NCS=4
      IF(LITERA.EQ.1H:) GOTO 31
      NCS=5
      IF(LITERA.EQ.1H ) GOTO 31
      NCS=6
      IF(LITERA.EQ.1H.) GOTO 31
      NCS=7
      IF(LITERA.EQ.1H() GOTO 31
      NCS=8
      IF(LITERA.EQ.1H)) GOTO 31
      NCS=9
   31 CONTINUE
C....
C     ПEPEKЛЮЧATEЛЬ ПO COCTOЯHИЯM
C....
      GOTO(100,200,300,400,500,600)JS
C===============================================
C
C - - - COCTOЯHИE = 1
C
  100 CONTINUE
      GOTO(101,101,101,101,105,106,101,101,109,110)NCS
C     ---------------
  101 CONTINUE
      NTAB=NCS-1
      GOTO 900
C     ---------------
  105 CONTINUE
      IF(ITAB.EQ.0)GOTO 901
C* . . . . . . . . . . . . . . . . . . . . . . .
C*    ПPOБEЛ  B  HAЧAЛE  ПAPAMETPA  HE  ЯBЛЯETCЯ
C*  PAЗДEЛИTEЛEM.  BCE ПPOБEЛЫ B HAЧAЛE ПAPAMET-
C*  PA ИГHOPИPYЮTCЯ, T.E. ПEPEHOCИTCЯ HAЧAЛO ПA-
C*  PAMETPA
      LM=LM+1
      GOTO 30
  106 CONTINUE
      JS=3
      KL=L
      GOTO 901
C...............................................
  109 CONTINUE
      JS=6
      ISW=2
      GOTO 609
C...............................................
  110 CONTINUE
      JS=2
      ISW=3
      LN=0
      GOTO 210
C - - - - - - - - - - - - - - - - - - - - - - -
   77 CONTINUE
C.... K O H E Ц   C T P O K И
      NCS=1
      GOTO 31
C- - - - - - - - - - - - - - - - - - - - - - - -
C
C===============================================
C
C - - - COCTOЯHИE = 2
C
  200 CONTINUE
      GOTO (201,201,201,201,205,206,201,201,209,210) NCS
C     ---------------
C
  205 CONTINUE
      IF(ITAB.EQ.0)GOTO 901
      NTAB=4
      GOTO 950
C     ---------------
  206 CONTINUE
      JS=4
      L=L+1
      KL=L
      GOTO 30
C     ---------------
  209 CONTINUE
      IF(ILT.EQ.0)GOTO 109
C     БYKBA - HAЧAЛO HOBOГO ПAPAMETPA
C
  902 CONTINUE
      L=L-1
      NTAB=8
      GOTO 950
C     ---------------
  210 CONTINUE
  510 CONTINUE
      L=L+1
      GOTO 30
C
C===============================================
C
C - - - COCTOЯHИE = 3
C
  300 CONTINUE
      GOTO (301,301,301,301,305,301,301,301,301,310)NCS
C     ---------------
C
  305 IF(ITAB.EQ.0)GOTO 901
C     . . . . . . . . . . .
  301 CONTINUE
      L=1
      NTAB=5
      GOTO 900
C     --------------
C
C===============================================
C
C - - - COCTOЯHИE = 4
C
  400 CONTINUE
      GOTO (401,401,401,401,405,406,401,401,409,410)NCS
C     --------------
C
  405 CONTINUE
      IF(ITAB.EQ.0)GOTO 901
C     . . . . . . . . . . .
  401 CONTINUE
      NTAB=NCS-1
      ISW=4
      GOTO 950
C     ---------------
  406 CONTINUE
  409 CONTINUE
      L=KL
      GOTO 401
C     ---------------
  310 CONTINUE
  410 CONTINUE
      JS=5
      ISW=5
      GOTO 510
C===============================================
C
C - - - COCTOЯHИE = 5
C
  500 CONTINUE
      GOTO (501,501,501,501,505,506,501,501,509,510)NCS
C     ---------------
  505 CONTINUE
      IF(ITAB.EQ.0)GOTO 901
C     . . . . . . . . . . .
  501 CONTINUE
  201 CONTINUE
      NTAB=NCS-1
      GOTO 950
C     ---------------
  509 CONTINUE
      IF(ILT.NE.0)GOTO 902
C     . . . . . . . . . . .
  506 CONTINUE
C
C     MЫ B CЛEДYЮЩEM ПAPAMETPE
C     BOЗBPAT YKAЗATEЛEЙ И BЫXOД.
C
      L=KL
      NTAB=5
      ISW=4
      IF(L.NE.1)GOTO 950
  900 CONTINUE
C-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
C
C     KOHEЦ PAЗБOPA: ПYCTOЙ ПAPAMETP.
C
      ISW=1
      L1=0
      GOTO 972
C
C===============================================
C
C - - - COCTOЯHИE = 6
C
  600 CONTINUE
      GOTO (601,601,601,601,605,601,601,601,609,610)NCS
C     ---------------
  605 CONTINUE
      IF(ITAB.EQ.0)GOTO 901
C     . . . . . . . . . . .
  601 CONTINUE
      NTAB=NCS-1
      GOTO 970
C     ---------------
  609 CONTINUE
  901 CONTINUE
      L=L+1
      GOTO 30
C     ---------------
  610 CONTINUE
      IF(ILT.EQ.0)GOTO 901
      NTAB=8
      L=L-1
C
C = = = = = = = = = = = = = = = = = = = = = = =
C
  970 CONTINUE
      ASSIGN 972 TO NSW
C
C.... ПOДГOTOBKA  ФOPMATA
  980 I1=2
      IF(LM.EQ.0)GOTO 971
      ENCODE(2,990,I2)LM
  990 FORMAT(I2)
      IFORM(2)=I2(1)
      IFORM(3)=2HX,
      I1=4
  971 L1=L
      IF(NTAB.NE.8)L1=L-1
      L2=L1
      IF(L1.GT.LMAX)L1=20
      II=I1
      L10=L1/2
      IF(L10.EQ.0)GOTO 973
      ENCODE(2,990,I2)L10
      IFORM(II)=I2(1)
      IFORM(II+1)=2HA2
      II=II+2
      IF(L10*2.EQ.L1)GOTO 974
      IFORM(II)=1H,
      II=II+1
  973 IFORM(II)=2HA1
      II=II+1
  974 IFORM(II)=1H)
C.... ПOЛYЧEHИE ПAPAMETPA
      IS=LM+L1
      L3=(L1-1)/NSUMB+1
      DECODE(IS,IFORM,INP) (IT(I3),I3=1,L3)
      GOTO NSW
  972 CONTINUE
      INT=0
      REAL=0.
  999 LTEXT=L1
      LM=LM+L
      RETURN
C= = = = = = = = = = = = = = = = = = = = = = = =
  950 CONTINUE
C
C          P A З Б O P   Ч И C Л A
C
      ASSIGN 951 TO NSW
      GOTO 980
  951 CONTINUE
      ENCODE(4,992,I2)L2
  992 FORMAT('F',I2,'.')
      IFORM(I1)=I2(1)
      IFORM(I1+1)=I2(2)
      IFORM(I1+2)=2H0)
      IS=LM+L2
      DECODE(IS,IFORM,INP)REAL
      INT=REAL
      GOTO 999
      END
       SUBROUTINE R160(LUN,A,N)
C*
C************ 7.11.78. A.П.CAПOЖHИKOB
C*
C*    БYФEPИЗAЦИЯ ИHФOPMAЦИИ ДЛЯ OБMEHA
C*    C HMЛ EC5012 ( PEЖИM EC ) ПOPЦИЯMИ
C*    ДЛИHOЙ 160 БAЙTOB.
C*
C*        SUBROUTINE R160 (LUN,AR,N)
C*        SUBROUTINE W160 (LUN,AR,N)
C*    - ЧTEHИE/ЗAПИCЬ  N  CЛOB MACCИBA AR.
C*    LUN - HOMEP YCTPOЙCTBA : 1,2,3,...,15
C*
C*        SUBROUTINE R160S (LUN,AR,N)
C*        SUBROUTINE W160S (LUN,AR,N)
C*    - TO ЖE CAMOE, HO ПOCЛEДHИЙ ПAPAMETP
C*    ЗAДAET KOЛИЧECTBO БAЙTOB MACCИBA AR.
C*    B CЛOBE BCEГДA 6 БAЙTOB.
C*
C*        SUBROUTINE S160 (LUN,0,0)
C*    ДOCБPOC БYФEPA ПEPEД KOHЦOM PAБOTЫ.
C*
C******************************************
C*
       DIMENSION A(N)
       DIMENSION KRW(2,16)
       DATA(KRW=32(0))
C----
       L=1
       GOTO 1
C----
       ENTRY W160
       L=2
C----
  1    N6=N*6
       GOTO 5
C----
       ENTRY R160S
       L=1
       N6=N
       GOTO 5
       ENTRY W160S
       L=2
       N6=N
  5    CONTINUE
       K=KRW(L,LUN)
       LL=2-L/2
       KRW(LL,LUN)=0
       CALL GIVPAG(LUN)
       DO 2 I=1,N6
       GOTO(12,11) L
C----
  11   CONTINUE
       CALL IPUTSL(IGETS(A,I-1),K)
       K=K+1
       IF(K.NE.160) GOTO 2
       CALL GUSEV(LUN,L)
       K=0
       GOTO 2
C----
  12   CONTINUE
       IF(K.EQ.0) CALL GUSEV(LUN,L)
       CALL IPUTS(IGETSL(K),A,I-1)
       K=K+1
       IF(K.EQ.160) K=0
C----
   2   CONTINUE
       KRW(L,LUN)=K
       RETURN
       ENTRY S160
       K=KRW(2,LUN)
         KRW(2,LUN)=0
       IF(K.EQ.0) GOTO 100
       DO 3 I=K,160
  3    CALL IPUTSL(0,I)
       CALL GUSEV(LUN,2)
 100   RETURN
       END
      SUBROUTINE RENUMB (ICAR,SERV)
      EXTERNAL SERV
      DIMENSION ICAR(14),NUMB(8)
      COMMON /TIKTAK/ A(10),CARD(14),JRO
      DATA NUMB /8*0B/
C
      IF    (JRO.EQ.1)              GOTO 90
      IF    (ICAR(13).NE.1H .OR.
     *      ICAR(14).NE.1H )        GOTO 90
      IF    (NUMB.NE.0B)            GOTO 40
            N=1
      DO 10 I=2,71
      IF    (IGETS(CARD,I).NE.58)   GOTO 10
      IF    (N.EQ.0)                GOTO 20
            N=0
10    CONTINUE
                                    GOTO 90
20    CONTINUE
      DO 30 N=1,8
            I=I+1
      NUMB(N)=IGETS(CARD,I)
30    CONTINUE
      IF    (NUMB(8).LT.48.OR.NUMB(8).GE.58)
     *      NUMB(8)=48
                                    GOTO 70
40    CONTINUE
            N=8
50    CONTINUE
      NUMB(N)=NUMB(N)+1
      IF    (NUMB(N).LT.58)         GOTO 70
      NUMB(N)=48
            N=N-1
      IF    (N.EQ.0)                GOTO 70
      IF    (NUMB(N).LT.48.OR.NUMB(N).GE.58)
     *      NUMB(N)=48
                                    GOTO 50
70    CONTINUE
            I=72
      DO 80 N=1,8
      CALL IPUTS(NUMB(N),ICAR,I)
            I=I+1
80    CONTINUE
90    CONTINUE
      CALL SERV(ICAR)
                                    RETURN
      END
      SUBROUTINE REPLAC(CA,SERV)
C
C*****   USER ФPAГMEHTAPHOЙ ЗAMEHЫ
C        (BEДYЩAЯ ПPOГPAMMA)
C
      INTEGER CA(14)
      COMMON /ORDERS/NORD(2),LSYM(2)
      COMMON /MINF/MCH,NCNTS(3),IC,LRE,SC CA(4),CARD1(74),CARD2(74)
     * ,SCET1(4,64),SCET2(4,64),ETAL1(16,64),ETAL2(16,64),ET(16),ET1(16)
      INTEGER SC CA,CARD1,CARD2,SCET1,ETAL1,ETAL2,ET,ET1
      COMMON /NUMS/NN0,NU(35),MANU(35),NR(12)
C.....
      INTEGER EQUFS,EQUCC,EQUNUM
      INTEGER SW1,SW2,SW3,SWN,SWT
      INTEGER S1(2),S2(2),S,BLAN,WBLAN,SEF,EOC
      INTEGER FLPR,FLBR,FLBLO,FLNUM,MSTR(2)
      INTEGER TIR1(6),TIR(7,6),TEND(3,4),TEXTS(3,9),DI0,DI1,DI9
      INTEGER END1,END2
      EQUIVALENCE (NCNTS(1),NPROB),(NCNTS(3),NREP)
C.....
      DATA TIR1/36H  ,...TI,  .TJ,  .+M,  .ITA,  ITS,  /
      DATA END1,END2,TEND/5H*READ,3HOLD
     * ,18H ЧИCЛO ПPOBEPOK -
     * ,18H БЛOKИPOBAHO    -
     * ,18H ЧИCЛO ЗAMEH    -
     * ,18H BPEMЯ PAБOTЫ   -
     * /
      DATA TEXTS
     * /18H** OШ.OГPAHИЧИTEЛЬ
     * ,18H** OШ.ФPAГMEHT
     * ,18H** MHOГO ЗAMEH
     * ,18HПEЧATЬ ЗAMEH
     * ,18HHYMEPAЦИЯ ЗAMEH
     * ,18HБЛOKИPOBKA П.ЗAMEH
     * ,18HPAЗPEШEHИE П.ЗAMEH
     * ,18HБЛOKИPOBKA ЗAMEH
     * ,18HPAЗPEШEHИE ЗAMEH
     */
      DATA BLAN,DI0,DI1,DI9,WBLAN/32,48,49,57,1H /
      DATA NCNTS,NN0,MKN,SW1,SWN,INITFL/5*0,3*1/
      DATA NFMAX,LFR/64,15/,
     * FLPR,FLBR/2*0/,FLBLO,FLNUM,MSTR/2*0,8H--------/
     *,IE/0/
     *,IERS/1H*/
C.....
      IF(INITFL.EQ.0) GO TO 9
      INITFL=0
      NF0=0
      CALL CTIME(CPT,TIM)
      CALL UNPTIR(TIR1,TIR)
    9 CONTINUE
      IF(IE.NE.0) GO TO 220
    8 CONTINUE
      IF(EQUFS(CA).NE.0B) GO TO (100,110),SW1
      SW2=EQUCC(CA)
      IF(SW2.EQ.0) GO TO (100,110),SW1
      CALL PACПAK(CA)
      IR=LSYM(SW2)+1
      IDIA=IR
      SEF=CARD1(IR)
      IF(SEF.EQ.BLAN.AND.SW2.EQ.7) GO TO 201
      EOC=0
      SW3=2
      GO TO (1,50,3,4,5,6,10,30,40),SW2
C-----   OPERATION : /PRF - ПEЧATЬ ЗAMEH
    1 FLPR=1
      IE=4
    2 CONTINUE
      CALL EDPRI1(WBLAN,1)
      RETURN
C-----   OPERATION : /NOD - БЛOK.ПOBT.ЗAMEH
    3 FLBR=1
      GO TO 7
C-----   OPERATION : /DOU - CHЯTИE БЛOKИPOBKИ
    4 FLBR=0
      GO TO 7
C-----   OPERATION : /BLO - БЛOKИPOBKA ЗAMEH BOOБЩE
    5 FLBLO=1
      GO TO 7
C-----   OPERATION : /NOB - EE OTMEHA
    6 FLBLO=0
    7 IE=SW2+2
      GO TO 2
C-----   OPERATION : /RF' - ЗAMEHA ФPAГMEHTA
   10 IW=0
      SW3=3-SW3
   11 IR=IR+1
      IF(IR.GT.72) GO TO 14
      S=CARD1(IR)
      GO TO (12,13),SW3
   12 IF(S.EQ.BLAN) GO TO 11
   13 IF(S.EQ.SEF) GO TO 15
      IW=IW+1
      IF(IW.GT.LFR) GO TO 202
      ET(IW)=S
      ET(IW+1)=0B
      GO TO 11
   14 EOC=1
   15 GO TO (16,18),SW3
C.....   ПEPBЫЙ ФPAГMEHT
   16 IF(IW.EQ.0) GO TO 2
      IF(EOC.EQ.1) GO TO 202
      I1=IW+1
      DO 17 I=1,I1
   17 ET1(I)=ET(I)
      GO TO 10
C.....   BTOPOЙ ФPAГMEHT
   18 IF(IW.EQ.0) ET=0B
      ASSIGN 10 TO SWT
C.....   ЗAHECEHИE ДBYX ФPAГMEHTOB
   19 SW1=2
      LFR1=LFR+1
      DO 23 NF=1,NF0
      DO 22 J=1,LFR1
      IF(ETAL1(J,NF).NE.ET1(J)) GO TO 23
   22 CONTINUE
      IND=NF
      GO TO 24
   23 CONTINUE
      IF(NF0.GE.NFMAX) GO TO 203
      NF0=NF0+1
      IND=NF0
   24 IDIA=IR
      CALL MAKESC(ET1,SCET1(1,IND))
      CALL MAKESC(ET,SCET2(1,IND))
      DO 20 J=1,LFR1
      ETAL1(J,IND)=ET1(J)
   20 ETAL2(J,IND)=ET(J)
      IF(EOC) 2,21,2
   21 GO TO SWT
C-----   OPERATION : /RN - ЗAMEHA HOMEPOB
   30 IF(SWN.EQ.2) GO TO 2
      IF(SEF.NE.BLAN) GO TO 32
C.....   YHИЧTOЖEHИE BCEX HOMEPOB
      MKN=1
   31 SWN=2
      GO TO 2
C.....   ЗAMEHA HOMEPOB
   32 IW=0
   33 IR=IR+1
      IF(IR.EQ.73) GO TO 37
      S=CARD1(IR)
      IF(S.EQ.SEF) GO TO 34
      IW=IW+1
      IF(IW.EQ.9) GO TO 37
      NR(IW)=S
      NR(IW+1)=0B
      GO TO 33
   34 IF(IW.EQ.0) GO TO 35
      IWR=IW+1
      NN0=NN0+1
      CALL ЗAПAKN
      GO TO 32
   35 NN0=NN0-1
      IF(NN0.EQ.0) GO TO 37
      DO 36 I=IWR,12
   36 NR(I)=BLAN
      GO TO 31
   37 NN0=0
      GO TO 202
C.....   OPERATION : /NUM - HYMEPAЦИЯ ЗAMEH
   50 IW=1
   51 IR=IR+1
      S=CARD1(IR)
      IF(S.EQ.SEF) GO TO 52
      NR(IW)=S
      IW=IW+1
      IF(IW.LE.8) GO TO 51
   52 DO 53 I=IW,12
   53 NR(I)=BLAN
      FLNUM=1
      IE=5
      GO TO 2
C-----   OPERATION : /RI - ЗAMEHA ИHДEKC-PEГИCTPA
   40 IDIA=IR+3
      IF(CARD1(IDIA).NE.SEF) GO TO 201
      IDIA=IR
      IF(NF0+6.GT.NFMAX) GO TO 203
      DO 41 I=1,2
      IR=IR+1
      S1(I)=CARD1(IR)
   41 S2(I)=CARD1(IR+3)
      IF(S1.EQ.BLAN.AND.S1(2).EQ.BLAN) GO TO 202
      IR=IR+4
      ASSIGN 49 TO SWT
      DO 49 K2=1,6
      K1=1
      IW1=1
      IW2=1
   42 S=TIR(K1,K2)
      SW3=2
      IF(S.EQ.BLAN)  GO TO 45
      SW3=1
   43 ET1(IW1)=S
      IW=IW1+1
      GO TO (44,46),SW3
   44 ET(IW2)=S
      IW2=IW2+1
      GO TO (48,47),SW3
   45 DO 47 K=1,2
      S=S1(K)
      IF(S.NE.BLAN) GO TO 43
   46 S=S2(K)
      IF(S.NE.BLAN) GO TO 44
   47 CONTINUE
      K1=K1+1
   48 K1=K1+1
      IF(S.NE.0B) GO TO 42
      GO TO 19
   49 CONTINUE
      GO TO 2
C-----   OБЫЧHAЯ KAPTA (БEЗ ЗAMEH)
  100 GO TO (101,120),SWN
  101 IF(CA.NE.END1.OR.CA(2).NE.END2) GO TO 106
C.....   BЫДAЧA CПPABKИ ПO KOHЦY
C        ПOЛYЧEHИE BPEMEHИ PAБOTЫ
  102 CALL CTIME(TIM,TIM1)
      CPT=TIM-CPT
      DO 105 I3=1,4
      CARD1=WBLAN
      CARD1(2)=WBLAN
      CARD1(3)=WBLAN
      DO 103 J3=1,3
  103 CARD1(J3+3)=TEND(J3,I3)
      CARD1(7)=INTCOD(NCNTS(I3))
      IF(I3.EQ.4) CARD1(7)=ISOTIM(CPT)
      CALL EDPRI1(CARD1,7)
  105 CONTINUE
  106 CALL SERV(CA)
      RETURN
C-----   OБЫЧHAЯ KAPTA (C BOЗM.ЗAMEHOЙ)
  110 IF(CA.EQ.END1.AND.CA(2).EQ.END2) GO TO 102
      MREP=0
      IF(FLBLO.NE.0) GO TO 112
      CALL PACПAK(CA)
      DO 111 IC=1,NF0
      NPROB=NPROB+1
      CALL CPABH
      IF(MCH.EQ.0B) GO TO 111
C.....   OБPAЗ ЗAMEHEH
      NREP=NREP+1
      MREP=1
      IF(FLBR.EQ.1) GO TO 112
  111 CONTINUE
  112 IF(MREP.EQ.0) GO TO (106,120),SWN
      IF(FLPR.EQ.0) GO TO 114
      CALL EDPRI1(MSTR,2)
      CALL EDPRI(CA)
  114 CALL ЗAПAK(CA)
      IF(FLNUM.NE.0) GO TO 128
      CALL ЗAПAK(CA)
      GO TO (113,120),SWN
  113 IF(MREP.EQ.0.OR.FLPR.EQ.0) GO TO 106
      CALL EDPRI(CA)
      GO TO 106
C.....   ПPOBEPKИ HA ЗAMEHY HOMEPOB
  120 IF(MKN.EQ.0) GO TO 122
C.....   YHИЧTOЖEHИE HOMEPOB
      CA(13)=WBLAN
      CA(14)=WBLAN
  121 GO TO (101,113),SW1
  122 IF(EQUNUM(CA(13)).NE.0B) GO TO 121
C.....   KOPPEKTИP.ЗAДAH.HOMEPA
  128 I=8
  123 S=NR(I)
      IF(S.LT.DI0.OR.S.GT.DI9) GO TO 124
      S=S+1
      IF(S.LE.DI9) GO TO 125
      NR(I)=DI0
      I=I-1
      IF(I) 126,126,123
  124 S=DI1
  125 NR(I)=S
C.....   ЗAПИCЬ ИCПPABЛEHHOГO HOMEPA
  126 CALL YПAKN(CA(13))
      GO TO 121
C-----   PAЗHOOБPAЗHAЯ ДИAГHOCTИKA
C.....   OШ.OГPAHИЧИTEЛЬ
  201 IE=1
      GO TO 210
C.....   OШ.ФPAГMEHT
  202 IE=2
      GO TO 210
C.....   MHOГO ЗAMEH
  203 IE=3
      GO TO 210
  210 CALL EDPRI1(WBLAN,1)
C.....   ПOДГOTOBKA И ПEЧATЬ ДИAГHOCTИKИ
      DO 211 JE=1,3
  211 CARD2(JE)=TEXTS(JE,IE)
      DO 212 JE=4,14
  212 CARD2(JE)=WBLAN
      CALL EDPRI(CARD2)
      IE=0
C.....   ПOДГOTOBKA И ПEЧATЬ ДOП.CTPOKИ
      IG=IDIA+1
      DO 213 JE=1,72
      CARD1(JE)=BLAN
      IF(JE.EQ.IG) CARD1(JE)=IERS
  213 CONTINUE
      CALL ЗAПAK(CARD2(2))
      CARD2=20040B
      CALL EDPRI(CARD2)
      RETURN
  220 DO 221 JE=1,3
      CARD2(JE)=WBLAN
  221 CARD2(JE+3)=TEXTS(JE,IE)
      CALL EDPRI1(CARD2,6)
      IE=0
      GO TO 8
      END
      SUBROUTINE RPWORD(KAR,SERV) ! FOREX
C*
C*                             B.B.B.   27.03.85
C*
C*      USER-SUBROUTINE PEДAKTOPA TEKCTOB
C*
C*      ПOCTPOЧHAЯ  PAЗДBИЖKA   ПЛOTHO
C*      HAБPAHHOГO TEKCTA:
C*
C*  1. BCTABKA ПPOБEЛOB ПOCЛE ЗHAKOB .,!?):;
C*     (KPOME "T.Д.", "T.П." И "T.E.")
C*     ECЛИ B PEЗYЛЬTATE PAЗДBИЖKИ B CTPOKE
C*     CTAHET БOЛЬШE 72-X CИMBOЛOB, TO OHA
C*     PAЗБИBAETCЯ HA ДBE CTPOKИ.
C*
C*  2. CДBИЖKA ЭTИX ЗHAKOB K KOHЦY ПPEДЫДYЩEГO
C*     CЛOBA. ПPИ HEBOЗMOЖHOCTИ, T.E. ECЛИ
C*     ЗHAK HAXOДИTCЯ B HAЧAЛE TEKCTOBOЙ CTPOKИ,
C*     CTPOKA PACПEЧATЫBAETCЯ. B ЭTOM CЛYЧAE OT
C*     ПOЛЬЗOBATEЛЯ TPEБYETCЯ ИHДИBИДYAЛЬHOE
C*     PEДAKTИPOBAHИE.
C*
C*  3. ДЛЯ ЗHAKA "(" - BCTABИTЬ ПPOБEЛ ПEPEД
C*     ЗHAKOM И "ПPИЖATЬ" K CЛEДYЮЩEMY CЛOBY.
C*
C*  4. ДЛЯ ЗHAKA "-" - ECЛИ ИMEETCЯ ПPOБEЛ XOTЯ
C*     БЫ C OДHOЙ CTOPOHЫ (KPOME ПOCЛEДHEГO
C*     CЛOBA B CTPOKE B CЛYЧAE ПEPEHOCA), BЫДE-
C*     ЛИTЬ ПPOБEЛOM И C ДPYГOЙ CTOPOHЫ.
C*
C*     KOЛ-BO "ЗHAЧAЩИX" CИMBOЛOB B ИCXOДHOЙ
C*     ИHФOPMAЦИИ MOЖHO PEГYЛИPOBATЬ ЧEPEЗ
C*
C*         COMMON/RPWORD/LEN
C*
C*     ПO YMOЛЧAHИЮ LEN ЗAДAETCЯ PABHЫM 72.
C*         DATA (LEN=72)
C*
C*
      CHARACTER*84 KARTA,COPY,S*1,KAR
C
      COMMON/RPWORD/LEN
      DATA( LEN=72 )
C
        CHARACTER*9 ZNAK,ZNAK9*11
        DIMENSION IZNAK(2)
        EQUIVALENCE (ZNAK,IZNAK),(ZNAK,ZNAK9)
        DATA IZNAK/'(-,:;.!?)''"'/
      DATA(NCARD=0)
C
      NCARD=NCARD+1
      KARTA=KAR(1:LEN)
      KERR=0 ! FLAG OF ERRORS
C
      I=1
C
  10  S=KARTA(I:I)
      IF(S.EQ.' '.OR.S.GT.'?')GO TO 800 ! NEXT
      J=INDEX(ZNAK,S)
      IF(J.EQ.0)GO TO 800 ! NOT ZNAK
      IF(J.LT.3)GO TO (300,400)J ! TO "(" "-"
C
  20  IF(I.EQ.1) THEN ! HAЧAЛO KAPTЫ
C                     ! FOR SERWISM
      IF(KARTA(1:2).EQ.'..')GO TO 790 ! $'..'
      IF(KARTA(1:1).EQ.':')GO TO 800
                     KERR=1 ! B HAЧAЛE CTPOKИ
                     GO TO 50
               END IF
C
  30  IF(KARTA(I-1:I-1).NE.' ') GO TO 50
      IF(KARTA(1:I-1).EQ.' ')GO TO 50 ! ПEPBЫЙ ЗHAK
           KARTA(I-1:LEN)=KARTA(I:LEN) ! ПPИЖATЬ
           I=I-1                       ! BЛEBO
           GO TO 30
C
  50  IF(KARTA(I+1:I+1).EQ.' ')GO TO 790
      IF(KARTA(I:I).EQ.':'.OR.
     *   KARTA(I:I).EQ.';')GO TO 440 !
      J=INDEX(ZNAK9(5:11),KARTA(I+1:I+1))
      IF(J.NE.0.)THEN
                     I=I+1
                     GO TO 50
               END IF
C
      IF(KARTA(I:I).NE.'.') GO TO 440
      IF(I.EQ.1)GO TO 800
      IF(KARTA(I-1:I+2).EQ.'T.E.'.OR.
     *   KARTA(I-1:I+2).EQ.'T.П.'.OR.
     *   KARTA(I-1:I+2).EQ.'T.Д.')GO TO 790
      GO TO 440
C-----------------------------------------------
C       AHAЛИЗ HA "("
C-----------------------------------------------
 300  IF(I.EQ.1)GO TO 350
      IF(KARTA(I-1:I-1).EQ.' ')GO TO 350
      IF(KARTA(72:84).NE.' ')THEN
        COPY=KARTA(1:I-1)
        CALL SERV(COPY)
        KARTA=KARTA(I:LEN)
        I=2
        GO TO 350
      END IF
      COPY(I+1:LEN)=KARTA(I:LEN)! PAЗДBИЖKA
      KARTA(I:LEN)=COPY(I:LEN)  ! BПPABO
      KARTA(I:I)=' '
      I=I+1
C
 350  IF(KARTA(I+1:LEN).EQ.' ')THEN
                      KERR=KERR+2
                      GO TO 900
                END IF
C
 360  IF(KARTA(I+1:I+1).NE.' ')GO TO 800
      KARTA(I+1:LEN)=KARTA(I+2:LEN)
      GO TO 360
C-----------------------------------------------
C    MINUS  TIRE PREFIKS PERENOS
C-----------------------------------------------
 400  IF(KARTA(I+1:I+1).EQ.'-')THEN
        J=INDEX(KARTA(I:LEN),' ') ! MHOГO "-"
      I=I+J-1
      GO TO 800
      END IF
C
      IF(KARTA(I+1:LEN).EQ.' ')GO TO 900!ПEPEHOC
      IF(I.EQ.1) GO TO 430
C
      IF(KARTA(I-1:I-1).EQ.' ')GO TO 430
C
C        X-?
C
      IF(KARTA(I+1:I+1).NE.' ')GO TO 800 ! X-X
C
C         X-BLANK
C
      IF(KARTA(72:80).NE.' ')THEN
        COPY=KARTA(1:I-1)
        CALL SERV(COPY)
        KARTA=KARTA(I:LEN)
        I=1
        GO TO 800
      END IF
      COPY(I+1:LEN)=KARTA(I:LEN)  ! PAЗДBИЖKA
      KARTA(I+1:LEN)=COPY(I+1:LEN)! BПPABO
      KARTA(I:I)=' '
      GO TO 790
C
C     BLANK-?
C
 430  IF(KARTA(I+1:I+1).EQ.' ')GO TO 800 ! B-B
C
C     BLANK-X
C
 440  IF(KARTA(72:80).NE.' ')THEN
        COPY=KARTA(1:I)
        CALL SERV(COPY)
        KARTA=KARTA(I+1:LEN)
        I=1
        GO TO 800
      END IF
      COPY(I+2:LEN)=KARTA(I+1:LEN)! PAЗДBИЖKA
      KARTA(I+2:LEN)=COPY(I+2:LEN)! BПPABO
      KARTA(I+1:I+1)=' '
 790  I=I+1
C
 800  I=I+1
      IF(I.LE.LEN) GO TO 10
C===============================================
 900  IF(KERR.NE.0)PRINT 910,NCARD,KERR
 910  FORMAT(' KAPTA'I6'. ERROR='I1)
C------
 990  CALL SERV(KARTA)
      END
      SUBROUTINE SERVER
C*
C***   M.Ю.ПOПOB.   CBЯЗЬ БЭCM - IBM/PC
C*
      COMMON /BUF/IB(1024)
      DIMENSION IFDB(32),IO(8)
      DATA IFDB/32*0B/
C     FDB(3) LENGTH OF DEVICE
      INTEGER D(4),STATE
      DATA D/1,9,17,25/
      J=JFOCC('D667/SYSTEM,MD,MADLEN,W(400) ',IFDB(1))
      J=JFOCC('D708/UNIX,M,M,W(7620) ',IFDB(D(2)))
      J=JFOCC('D712/MSDOS,M,M,W(7620) ',IFDB(D(3)))
      STATE = 0
1     CONTINUE
C     MAIN SERVER LOOP
C-------------------------------
C
C     READ PAGE FROM PC
      IE=IBMIO(IO,2,1) .AND. 7740B
      IF(IE.NE.0B)GOTO 99
C     WE READ PAGE WITHOUT ANY ERRORS
      IF(IGETPAR(IO,IOP,IDEV,ITRACK).EQ.0)GO TO 99
      IF(IDEV.GT.3)GO TO 99
      ID=D(IDEV+1)
C     SAVE DEV LENGTH
      LEN=IFDB(ID+2)
C
C     ANALIZE OPERATION
C
C       NULLOP - DO NOTHING
      IF(IOP.EQ.0) GO TO 10
C       "RDT" - READ TRACK FROM DEVICE AND SEND TO PC
      IF(IOP.NE.3HRDT) GO TO 2
      IF(STATE .NE. 0) GO TO 99
      IANS = JFEX1(IFDB(ID),IB,ITRACK,'R')
      IF(IANS .NE. 0) GO TO 99
      IRDEV = IDEV
      IRTRACK = ITRACK
      STATE = 1
      GO TO 8
C      "WTT - WRITE PAGE ON DEVICE
2     IF(IOP.NE.3HWTT) GO TO 3
      IF(STATE .NE. 0)GO TO 99
      STATE =2
      IANS = JFEX1(IFDB(ID),IB,ITRACK,'W')
      IF(IANS .NE. 0)GO TO 99
      GO TO 8
3     CONTINUE
8     CONTINUE
      IF(STATE.EQ.0)GO TO 1
      IF(STATE.NE.1)GO TO 12
      CALL PUTPAR(IO,3HRDT,IRDEV,IRTRACK,LEN)
      STATE = 0
      GO TO 10
12    IF(STATE.NE.2)GO TO 99
      CALL PUTPAR(IO,3HACK,0,0,0)
      STATE=0
      GO TO 11
C     NOW SEND PAGE TO PC
10    IE=IBMIO(IO,2,0)
      GO TO 1
99    CALL PUTPAR(IO,4HNACK,0,0,0)
      STATE = 0
C     FOR NACK & ACK OPS WE SEND ONLY 256 WORDS+ 48 BYTES
11    EI=IBMIO(IO,1,0)
      GO TO 1
      END
      SUBROUTINE SQROOT(A,A1,III,NN,NDIM,C,LB,JOB,FUNCT)
C*
C****    30.4.85.    П.Г.AKИШИH
C*
C*  SUBROUTINE SQROOT(A,A1,III,NN,NDIM,C,LB,JOB,FUNCT)
C*
C*  SQROOT - ПPOГPAMMA ДЛЯ PEШEHИЯ CИCTEM ЛИHEЙ-
C*    HЫX YPABHEHИЙ C CИMMETPИЧHOЙ MATPИЦEЙ.
C*    ИCПOЛЬЗYETCЯ METOД KBAДPATHOГO KOPHЯ.
C*  NDIM   - PAЗMEPHOCTЬ CИCTEMЫ.
C*  A, A1  - PAБOЧИE MACCИBЫ ДЛИHOЙ LB KAЖДЫЙ.
C*  LB     - ДЛИHЫ БYФEPOB A И A1.   ЗAMEЧAHИE:
C*    ДЛЯ ЭФФEKTИBHOЙ PAБOTЫ ЖEЛATEЛЬHO LB>1000.
C*  III,NN - PAБOЧИE MACCИBЫ ДЛИHOЙ  NDIM.
C*  C      - MACCИB ДЛИHOЙ NDIM. COДEPЖИT ПPABYЮ
C*    ЧACTЬ CИCTEMЫ. TYДA ЖE ПOMEЩAETCЯ PEШEHИE.
C*  FUNCT  - ФYHKЦИЯ ЮЗEPA, BЫЧИCЛЯЮЩAЯ ЭЛEMEHTЫ
C*    MATPИЦЫ.  B BЫЗЫBAЮЩEЙ ПPOГPAMME ДOЛЖHA
C*    БЫTЬ OПИCAHA KAK  EXTERNAL.
C*  JOB    - KOД OПEPAЦИИ = 1 ИЛИ 2.
C*
C*  1.PAБOTA HAЧИHAETCЯ OБPAЩEHИEM C JOB=1.
C*    ПPOГPAMMA OБPAЩAETCЯ K ФYHKЦИИ ЮЗEPA
C*    FUNCT(I,J) ЗA BЫЧИCЛEHИEM (I,J) - ГO
C*    MATPИЧHOГO ЭЛEMEHTA.  I=1,2,...,NDIM
C*    J=1,2,...,I.  ПOЛYЧEHHAЯ TAKИM OБPAЗOM
C*    BEPXHETPEYГOЛЬHAЯ MATPИЦA ЗAПИCЫBAETCЯ
C*    B ФAЙЛ C ЛOГИЧECKИM HOMEPOM 2.
C*
C*    ДAЛEE ПPOИЗBOДИTCЯ ФAKTOPИЗAЦИЯ ИCXOДHOЙ
C*    MATPИЦЫ И ЗAПИCЬ ФAKTOP-MATPИЦЫ B ФAЙЛ 1.
C*    ИCXOДHAЯ MATPИЦA B ФAЙЛE 2 HE ПOPTИTCЯ.
C*    ECЛИ B ПPOЦECCE ФAKTOPИЗAЦИИ BЫЯCHЯETCЯ,
C*    ЧTO ИCXOДHAЯ MATPИЦA BЫPOЖДEHA, TO B JOB
C*    ЗACЫЛAETCЯ ЗHAЧEHИE 3 И ПPOГPAMMA ПPEKPA-
C*    ЩAET PAБOTY.  ECЛИ MATPИЦA HE BЫPOЖДEHA,
C*    BЫЧИCЛЯETCЯ PEШEHИE ДЛЯ ЗAДAHHOЙ ПPABOЙ
C*    ЧACTИ  C.
C*
C*    ИTAK, ДЛЯ PAБOTЫ ПPOГPAMMЫ TPEБYETCЯ
C*    2 ЛEHTЫ (ФAЙЛA).  OБЬEM KAЖДOГO ФAЙЛA
C*    ДOЛЖEH БЫTЬ HE MEHEE (NDIM**2)/1920
C*    ЗOH БЭCM-6.
C*    ФAKTOPИЗOBAHHAЯ MATPИЦA MOЖET БЫTЬ
C*    ИCПOЛЬЗOBAHA HEOДHOKPATHO ДЛЯ PEШEHИЯ
C*    CИCTEMЫ C PAЗЛИЧHЫMИ ПPABЫMИ ЧACTЯMИ.
C*
C*  2.ПPИ  JOB=2  ПPOИЗBOДИTCЯ PEШEHИE CИCTEMЫ
C*    C ПPABOЙ ЧACTЬЮ, ЗAДAHHOЙ B MACCИBE  C.
C*    ПOЛYЧEHHOE PEШEHИE ПOMEЩAETCЯ B MACCИB C.
C*    MATPИЦA CЧИTAETCЯ YЖE ФAKTOPИЗOBAHHOЙ.
C*    ФYHKЦИЯ ЮЗEPA FUNCT И ИCXOДHAЯ MATPИЦA
C*    B ФAЙЛE 2 ПPИ ЭTOM HE ИCПOЛЬЗYЮTCЯ.
C*
C-------------------------------------------
      DIMENSION A(2),A1(2),NN(2),III(2),C(2)
C-------------------------------------------
      IF(JOB.EQ.2) GOTO 2000
      IF(JOB.EQ.3) RETURN
      NN(1)=0
      NK=1
      LL=0
      DO 1 K=1,NDIM
      LL=LL+K
      IF(LL.LE.LB)GO TO 1
      NK=NK+1
      NN(NK)=K-1
      LL=K
1     CONTINUE
      NK=NK+1
      NN(NK)=NDIM
      REWIND 2
      N0=NK-1
      DO 2 K=1,N0
      N1=NN(K)
      N2=NN(K+1)
      NNN=0
      N1=N1+1
      DO 3 L=N1,N2
      DO 4 M=1,L
      NNN=NNN+1
      A(NNN)=FUNCT(L,M)
4     CONTINUE
3     CONTINUE
      WRITE(2) (A(J),J=1,LB)
2     CONTINUE
      KKKK=1
      NN00=0
      N1=NN(1)
      N2=NN(2)-1
      REWIND 2
      REWIND 1
      READ(2) (A(J),J=1,LB)
      GO TO 11
5     CONTINUE
      READ(2) (A(J),J=1,LB)
      LLLL=0
      KL=0
      REWIND 1
6     KL=KL+1
      NN1=NN(KL)
      NN2=NN(KL+1)
      NN00=N2+1
      NN0=N1
      IF(NN1.EQ.NN0)GO TO 11
      READ(1) (A1(J),J=1,LB)
      NNN=-LLLL
7     NNN=NNN+LLLL
      LLL1=LLLL
      IF(LLLL.EQ.NN2)GO TO 6
      LLLL=LLLL+1
      LLL0=-N1
      DO 8 K=N1,N2
      LLL0=LLL0+K
      LLL2=LLL0+LLLL
      IF(LLLL.EQ.1)GO TO 9
      DO 10 K1=1,LLL1
      R1=A1(NNN+K1)*A(LLL0+K1)
      IF(III(K1).EQ.0)R1=-R1
10    A(LLL2)=A(LLL2)+R1
9     A(LLL2)=A(LLL2)/A1(NNN+LLLL)
      IF(III(LLLL).EQ.1)A(LLL2)=-A(LLL2)
8     CONTINUE
      GO TO 7
11    CONTINUE
      LLL2=0
      LLLL=N1
12    LLL1=LLLL
      LLLL=LLLL+1
      LLL3=LLL2+LLLL
      IF(LLL1.EQ.0)GO TO 14
      DO 13 K=1,LLL1
      R1=A(LLL2+K)**2
      IF(III(K).EQ.1)R1=-R1
      A(LLL3)=A(LLL3)-R1
13    CONTINUE
14    CONTINUE
      IF(A(LLL3))15,16,17
15    A(LLL3)=SQRT(-A(LLL3))
      III(LLLL)=1
      GO TO 18
17    A(LLL3)=SQRT(A(LLL3))
      III(LLLL)=0
18    CONTINUE
      IF(LLLL.GT.N2)GO TO 22
      LL3=LLL3
      DO 19 K1=LLLL,N2
      LL3=LL3+K1
      LL1=LL3-LLL1-1
      IF(LLL1.EQ.0)GO TO 21
      DO 20 K2=1,LLL1
      R1=A(LLL2+K2)*A(LL1+K2)
      IF(III(K2).EQ.0)R1=-R1
20    A(LL3)=A(LL3)+R1
21    CONTINUE
      IF(III(LLLL).EQ.1)A(LL3)=-A(LL3)
      A(LL3)=A(LL3)/A(LLL3)
19    CONTINUE
      LLL2=LLL3
      GO TO 12
22    CONTINUE
      WRITE(1) (A(J),J=1,LB)
      IF(NN00.EQ.NDIM)GO TO 23
      KKKK=KKKK+1
      N1=NN(KKKK)
      N2=NN(KKKK+1)-1
      NN0=N1
      NN00=N2+1
      GO TO 5
23    CONTINUE
      GO TO 2000
16    CONTINUE
      JOB=3
      RETURN
2000  CONTINUE
      KKKK=0
      LLLL=0
      NN00=0
      REWIND 1
24    CONTINUE
      IF(NN00.EQ.NDIM)GO TO 28
      KKKK=KKKK+1
      NN00=NN(KKKK+1)
      NNN=0
      READ(1)(A(J),J=1,LB)
25    LLL1=LLLL
      LLLL=LLLL+1
      IF(LLL1.EQ.0)GO TO 27
      DO 26 K=1,LLL1
      NNN=NNN+1
26    C(LLLL)=C(LLLL)-C(K)*A(NNN)
27    NNN=NNN+1
      C(LLLL)=C(LLLL)/A(NNN)
      IF(LLLL.EQ.NN00)GO TO 24
      GO TO 25
28    CONTINUE
      DO 29K=1,NDIM
      IF(III(K).EQ.1)C(K)=-C(K)
29    CONTINUE
      N1=NN(KKKK)
      N2=NN(KKKK+1)
      NNN=((N2-N1)*(N2+N1+1))/2
      GO TO 31
30    KKKK=KKKK-1
      IF(KKKK.EQ.0)GO TO 33
      N1=NN(KKKK)
      N2=NN(KKKK+1)
      NNN=((N2-N1)*(N2+N1+1))/2
      BACKSPACE 1
      BACKSPACE 1
      READ(1)(A(J),J=1,LB)
31    CONTINUE
      IF(LLLL.EQ.N1)GO TO 30
      C(LLLL)=C(LLLL)/A(NNN)
      X1=C(LLLL)
      LLLL=LLLL-1
      NNN=NNN-1
      IF(NNN.EQ.0)GO TO 30
      DO 32 K=1,LLLL
      C(LLLL+1-K)=C(LLLL+1-K)-X1*A(NNN)
      NNN=NNN-1
32    CONTINUE
      GO TO 31
33    CONTINUE
      RETURN
      END
      SUBROUTINE TEACH
      DIMENSION MTITLE(4),LISJOB(20),IARC(10),MZ(2),K(20),
     *IST(20),LEXEM(16),KB(20),NE0(3),NE1(3),NE2(3),NE3(3),
     *IW(11),NE4(2),NE5(3),NE6(3),NE7(6)
      COMMON/PROTO/NAP,NUNIT,NL,NF,INT,IKAP(15)
      COMMON/RO/NOT
      DATA ( JOBTEX = 'JOB>' ),( LEXEM = 16( '======'))
      DATA ( JOBT = '>' ), ( MZ = 0B,0B ), ( N2 = 'BOSS  ' )
      DATA ( MTITLE = 'ПPOГPAMMA "TEACHER"'), ( NA = 'CATALO')
      DATA ( NE0 =18HHEИЗBECTHЫЙ ПPИKAЗ)
      DATA ( NE1 =18HOШИБKA B ЗAKAЗE   )
      DATA ( NE2 =18HOБЬEKT OTCYTCTBYET)
      DATA ( NE3 =18HOШИБKA B ПPИKAЗE  )
      DATA ( NE4 =12HBЫШE HEKYДA )
      DATA ( NE5 =18HЭTO HE ПOЛOЖEHO   )
      DATA ( NE6 =18H*ДO HOBЫX BCTPEЧ* )
      DATA ( NE7 ='БYДEM BECTИ ПPOTOKOЛ ? ДA ИЛИ HET.  ')
      DATA ( LISJOB = 'BEGIN','HELP','TEACH','GIVE','WRITE',
     *                'KEY','END','FIRST','AFTER','WORD',
     *                'UNDER','NEIGHB','INDEX','DELETE','SHIFT',5(0))
      DATA ( IW = 9('      '),'*     ','*     ')
      NL=15
      NN=0
      IKEY=0
      CALL DIALOQ(NE7,48,1)
      CALL SCANER(IKAP,K,0,LEXTYP,KODR,IPOZ)
      I=0
      IF ( K.EQ.'ДA' ) I=2
      CALL DIALOP(I)
      CALL TEROUT( 0760 0000 0000 0000B,1)
      CALL DIALOQ(MTITLE,19,-1)
      CALL DIALOQ(LEXEM ,19,-1)
  1   CALL DIALOQ(JOBTEX,4,IKAP)
      NE=0
      CALL SCANER(IKAP,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF(LEXTYP.NE.4) GOTO 3
      JOB = JSEART(LISJOB,1,15,LEXEM)
      IF ( JOB.NE.0 ) GOTO 2
  3   CALL DIALOQ(NE0,18,-1)
      GOTO 1
  2   IF ( NN.NE.0 ) GOTO 11
      IF ( JOB.NE.1.AND.JOB.NE.7) GOTO 6
  11  GOTO ( 15,30,30,70,50,80,100,75,130,900,71,40,90,
     *       110,120 ) JOB
  6   CALL DIALOG('HAЧИHAЙ C ПPИKAЗA "BEGIN".',26,-1)
      GOTO 1
C
C+     BEGIN. ЗAKAЗ HOCИTEЛЯ ЧEPEЗ JFOCC.
C+     ЗAKAЗ HOCИTEЛЯ ДEЛATЬ ПOД MAT.HOMEPOM 56 (W56 ИЛИ R56).
C
  15  J=JFOCC(0,IARC)
      MNUM=LSHIFT(IARC(2),-12)
      IF ( J.EQ.0 ) GOTO 20
      CALL DIALOG(NE1,18,-1)
      GOTO 1
C
C+     ЗABEДEHИE ПOЛЯ. ПO YMOЛЧAHИЮ БEPEM 10B ЗOH.
C
  10  IF ( IKEY.EQ.0 ) GOTO 201
      CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF (LEXTYP.EQ.5 ) GOTO 12
      IF(LEXTYP.NE.2) GOTO 14
      NUM=LEXEM
      GOTO 13
  12  NUM=8
  13  NUM=NUM*1024
      CALL LDEFIN(NUM,12,MNUM,-1)
      JA=LCREAT(NA)
      CALL LWRITE(JA,MZ)
      JW=LCREAT(N2)
      NN=1
      IST(1)=JA
      GOTO 1
  14  CALL DIALOQ(NE1,18,-1)
      GOTO 1
C
C+     ПPOBEPKA KЛЮЧA. KЛЮЧ YKAЗЫBAETCЯ ПOCЛE
C+     ЗAKAЗA HOCИTEЛЯ(TOЛЬKO ДЛЯ ИЗMEHEHИЯ COДEPЖИMOГO).
C
  20  CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      CALL LDEFIN(NUM,12,MNUM,1)
      IF ( NOT.EQ.0 ) GOTO 23
      IF ( LEXTYP.EQ.5 ) GOTO 23
      JA=LREWIN(NA)
      JW=LREWIN(LEXEM)
      IF ( JW.EQ.0B ) GOTO 23
      IKEY=1
  23  NN=1
      IST(1)=JA
      N1=LEXEM
      IF ( NOT.NE.0 ) GOTO 1
      CALL DIALOG('TEACHER OTCYTCTBYET, БYДEM ЗABOДИTЬ? ДA ИЛИ HET.',
     *48,-1)
      CALL DIALOQ('ECЛИ ДA, TO YKAЖИTE CKOЛЬKO ЗOH HYЖHO(ДECЯTИЧ.) ',
     *48,1)
      CALL SCANER(IKAP,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXEM.EQ.'ДA' ) GOTO 24
      GOTO 101
  24  IF ( N1.NE.N2 ) GOTO 201
      IKEY=1
      GOTO 10
C
 201  CALL DIALOQ('BAM ЭTO HE ПOЛOЖEHO',19,-1)
      GOTO 101
C
C+     TEACH, HELP.
C
  30  CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF(LEXTYP.EQ.5) GOTO 31
      LL=2
      IF( LEXTYP.EQ.2 ) GOTO 60
      GOTO 41
C+     BЫBOД CTPOKИ.
  31  JA=IST(NN)
      I=1
  32  CALL LREAD(JA,IKAP)
      IF ( IKAP(1).NE.0B ) GOTO 34
      DO 33 N=1,10
  33  K(N)=IKAP(N+1)
      GOTO 37
  34  CALL ENCOD(1,K)
      CALL ENCODI(I,3)
      I=I+1
      DO 35 N=2,10
  35  K(N)=IKAP(N)
  37  CALL DIALOG(K,60,-1)
      IF(NF.EQ.0) GOTO 39
  38  IJ=LAFTER(JA)
      IF ( IJ.EQ.1 ) GOTO 1
      JA=IJ
      GOTO 32
  39  IF(INT.EQ.0) GOTO 38
      IF(IKAP.NE.0B) GOTO 1
      GOTO 38
C
C+    BЫБOPKA COCEДA. N(EIGHB):N
C
  40  CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.NE.2 ) GOTO 41
      IF ( NN.EQ.1 ) GOTO 66
      NE=1
      NN=NN-1
      LL=2
      GOTO 60
  41  CALL DIALOQ(NE3,18,-1)
      GOTO 1
C
C+      ЗAПOЛHEHИE. W(RITE) ИЛИ W(RITE):N
C
  50  IF ( IKEY.EQ.0 ) GOTO 201
      JA=IST(NN)
      CALL LREAD(JA,K)
      IF ( K.EQ.0B.AND.K(2).EQ.0B ) J0=1
      NFL=0
      CALL SCANER(0,LEXEM,1,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.EQ.5 ) GOTO 51
      LL=1
      GOTO 60
  51  CALL DIALOQ(IW,66,-1)
      IKAP=0B
  52  CALL DIALOQ(JOBT,1,1)
      IF(IKAP.EQ.0B) GOTO 1
      CALL SCANER(IKAP,LEXEM,1,LEXTYP,KODR,IPOZ)
 1152 K=0B
      IF( KODR.NE.42 ) GOTO 56
      I=1
      IKAP=LEXOR(IKAP,14400000 00000000B)
  53  NAME=IKAP(I)
      JJ=LCREAT(NAME)
      IF ( JJ.NE.0 ) GOTO 54
      I=I+1
      GOTO 53
  54  K=NAME
      CALL LWRITE(JJ,MZ)
  56  DO 57 I=2,11
  57  K(I)=IKAP(I-1)
      IF(J0.EQ.1) GOTO 59
      IF ( NFL.EQ.1 ) GOTO 58
  55  JW=LAFTER(JA)
      IF ( JW.EQ.1 ) GOTO 58
      JA=JW
      GOTO 55
  58  JA=LINCA(JA)
  59  CALL LWRITE(JA,K)
      J0=0
      GOTO 52
C
C+     ПOИCK B MEHЮ.
C
  60  JW=IST(NN)
      NUM=LEXEM
      IFL=0
  61  CALL LREAD(JW,K)
      IF ( K.NE.0B ) IFL=IFL+1
      IF ( IFL.EQ.NUM ) GOTO 65
      IJ=LAFTER(JW)
      IF ( IJ.EQ.1 ) GOTO 66
      JW=IJ
      GOTO 61
  65  NN=NN+1
      IST(NN)=LREWIN(K)
      JA=IST(NN)
      CALL LREAD(JA,K)
      IF( K.EQ.0B.AND.K(2).EQ.0B) J0=1
      GOTO (51,31) LL
  66  CALL DIALOG(NE2,18,-1)
      GOTO 1
C
C+     ПPOXOД BHИЗ.
C+     G(IVE):N , T(EACH):N , H(ELP):N
C
  70  CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.NE.2 ) GOTO 41
      LL=2
      GOTO 60
C
C+     ПPOXOД BBEPX. U(NDER)
C
  71  IF ( NN.EQ.1 ) GOTO 72
      NN=NN-1
      GOTO 31
  72  CALL DIALOG(NE4,11,-1)
      GOTO 1
C
C+     CAMЫЙ ПEPBЫЙ PAЗДEЛ. F(IRST)
C
  75  NN=1
      GOTO 31
C
C+     CMEHA KЛЮЧA ДЛЯ AДMИHИCTPATOPA TEACHER-A.
C+     KEY:NEWKEY , ГДE NEWKEY-HOBЫЙ KЛЮЧ.
C
  80  IF ( IKEY.EQ.0 ) GOTO 201
      CALL SCANER(0,LEXEM,2,LEXTYP,KODR,IPOZ)
      J=LDEATH(N1)
      J=LCREAT(LEXEM)
      N1=LEXEM
      GOTO 1
C
C+     HYMEPAЦИЯ BCEX CTPOK ДЛЯ PEДAKTИPOBAHИЯ. I(NDEX)
C
  90  JA=IST(NN)
      I=1
  91  CALL LREAD(JA,IKAP)
      CALL ENCOD (1,K)
      CALL ENCODI(I,3)
      I=I+1
      DO 92 N=2,11
  92  K(N)=IKAP(N)
      CALL DIALOQ(K,62,1)
      IF(NF.EQ.0) GOTO 94
  93  IJ=LAFTER(JA)
      IF ( IJ.EQ.1 ) GOTO 1
      JA=IJ
      GOTO 91
  94  IF(INT.EQ.0) GOTO 93
      IF(IKAP.NE.0B) GOTO 1
      GOTO 93
C
C+     ИCKЛЮЧEHИE CTPOKИ ИЛИ ФPAГMEHTA.
C+     D(ELETE):N ИЛИ D(ELETE):N1,N2
C+     ПPИ ИCKЛЮЧEHИИ CTPOKИ-ЗAГOЛOBKA BCE HИЖHИE
C+     PAЗДEЛЫ YHИЧTOЖAЮTCЯ.
C
 110  IF ( IKEY.EQ.0 ) GOTO 201
      CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.NE.2 ) GOTO 41
      M1=LEXEM
      M2=0
      CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.EQ.5 ) GOTO 117
      IF ( LEXTYP.NE.2 ) GOTO 41
      M2=LEXEM
      IF(M1.GE.M2) GOTO 41
 117  JW=IST(NN)
      IFL=1
 111  IF ( IFL.EQ.M1 ) GOTO 112
      JW=LAFTER(JW)
      IF ( JW.EQ.1 ) GOTO 66
      IFL=IFL+1
      GOTO 111
 112  CONTINUE
      MP=0
      M3=0
      IF ( M2.EQ.0 ) GOTO 113
      M3=M2-M1+1
      DO 119 MP=1,M3
 113  CALL LREAD(JW,IKAP)
      J1=0
      J=LDELA(JW)
      IF(J.EQ.0) J1=1
      IF ( J.EQ.0.AND.MP.LT.M3 ) GOTO 66
      IF ( J.EQ.0 ) J=LDELB(JW)
      IF ( J.NE.0 ) GOTO 1113
      CALL DIALOG(NE5,18,-1)
      GOTO 1
 1113 IF ( IFL.EQ.1 ) IST(NN)=J
      JW=J
      IF ( IFL.EQ.1 ) IST(NN)=J
      IF ( IKAP.EQ.0B ) GOTO 119
      J=LREWIN(IKAP)
 114  KK=1
 115  JA=J
      KB(KK)=J
      CALL LREAD(JA,K)
      IF ( K.NE.0B ) GOTO 116
      IJ=LAFTER(JA)
      IF ( IJ.EQ.1 ) GOTO 118
      J=IJ
      GOTO 115
 116  KK=KK+1
      IKAP(KK)=K
      J=LREWIN(K)
      GOTO 115
 118  J=LDEATH(IKAP(KK))
      IF ( KK.EQ.1 ) GOTO 119
      KK=KK-1
      J=LAFTER(KB(KK))
      IF ( J.EQ.1 ) GOTO 118
      GOTO 115
 119  CONTINUE
C+     HA ДOЗAПИCЬ BMECTO ИCKЛЮЧEHHЫX CTPOK.
      IF(J1.EQ.1) GOTO 1120
      IF(M1.EQ.1) GOTO 1119
      JA=LBEFOR(JW)
      GOTO 51
 1119 IST(NN)=JW
 1120 CALL DIALOQ(JOBT,1,1)
      CALL SCANER(IKAP,LEXEM,2,LEXTYP,KODR,IPOZ)
      IF(LEXTYP.EQ.5) GOTO 1
      IF(J1.EQ.1) JA=LINCA(JW)
      IF(M1.EQ.1) JA=LINCB(JW)
      IF(M1.EQ.1) IST(NN)=JA
      NFL=1
      J0=1
      GOTO 1152
C
C+     MEHЯEM CTPOKИ MECTAMИ. S(HIFT):N1,N2
C
 120  IF( IKEY.EQ.0 ) GOTO 201
      CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.NE.2 ) GOTO 41
      NA1=LEXEM
      CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.NE.2 ) GOTO 41
      NA2=LEXEM-1
      IF ( NA1.GE.NA2 ) GOTO 41
      IJ=IST(NN)
      DO 121 I=1,NA2
      JW=IJ
      IF ( NA1.EQ.I) N4=JW
      IJ=LAFTER(JW)
      IF ( IJ.EQ.1) GOTO 66
 121  CONTINUE
      N5=JW
      J=LCHANG(N4,N5)
      IF(NA1.EQ.1) IST(NN)=J
      GOTO 1
C
C+     ДOЗAПИCЬ ПOCЛE CTPOKИ N. A(FTER):N
C
 130  IF ( IKEY.EQ.0 ) GOTO 201
      CALL SCANER(0,LEXEM,0,LEXTYP,KODR,IPOZ)
      IF ( LEXTYP.NE.2 ) GOTO 41
      IJ=IST(NN)
      IF ( LEXEM.EQ.1 ) GOTO 132
      NU=LEXEM-1
      DO 131 I=1,NU
      J=LAFTER(IJ)
      IF ( J.EQ.1 ) GOTO 41
 131  IJ=J
 132  JA=IJ
      NFL=1
      GOTO 51
C
C+     WORD.
C
 900  CALL QTER('B.ADR=',6,K,LK)
      II=DECODB(K(2),W)
      IF ( II.EQ.0 ) GOTO 1
      L=JWORD(W)
      CALL ENCOD (1,K)
      CALL ENCODB(L,16,8)
      CALL DIALOG(K,17,-1)
      GOTO 900
C
C+    END
C
 100  CALL LSWOP
 101  CALL DIALOQ(NE6,18,-1)
      CALL DIALOP(0)
      END
      SUBROUTINE TEPRIN
C*
C*          *CALL TEPRIN
C***  PACПEЧATKA APXИBHOЙ ЛEHTЫ EC
C*    OБЩEHИE C ЮЗEPOM - B ДИAЛOГE
C*
C*    ЛEHTA HAЧИHAETCЯ БЛOKOM  VOL1  (80 БAЙT),
C*    COДEPЖAЩИM ИMЯ MЛ И ИMЯ BЛAДEЛЬЦA.
C*    KAЖДЫЙ OБЬEKT ПPEДCTABЛEH TAK :
C*    1. БЛOK HDR1 (80 БAЙT)
C*       4:17 БAЙTЫ - ИMЯ OБЬEKTA
C*       ДAЛEE - ДATA, HOMEP ФAЙЛA И T.П.
C*    2. БЛOK HDR2 (80 БAЙT)
C*       4 БAЙT     - CИMBOЛ "F"
C*       5:9 БAЙTЫ  - PAЗMEP LEN БЛOKA B БAЙTAX
C*      10:14 БAЙTЫ - PAЗMEP REC ЗAПИCИ B БAЙTAX
C*    3.  E O F
C*    4. БЛOKИ CAMOГO OБЬEKTA ДЛИHOЙ ПO LEN БAЙT
C*       ПOCЛEДHИЙ БЛOK MOЖET БЫTЬ MEHЬШEЙ ДЛИHЫ
C*       HO KPATHOЙ REC.  И BOOБЩE  LEN = N*REC.
C*    5.  E O F
C*    6. БЛOK EOF1 (80 БAЙT).
C*       COДEPЖИT ЧИCЛO БЛOKOB OБЬEKTA
C*    7. БЛOK EOF2 (80 БAЙT).
C*       ДYБЛИPYET ИHФOPMAЦИЮ B HDR2.
C*    8.  E O F
C*
C*    KOДИPOBKA BCЮДY -  E B C D I C
C*    ДBA  EOF  ПOДPЯД - KOHEЦ ЛEHTЫ.
C*
      COMMON /PROTO/ AP,NU,NL,NF,INT,KAP(40)
      DATA NL/14/
      DATA  LUN/1/, KREP/5/
      DIMENSION MDIAG(6)
      DATA MDIAG/'BLOCK 1000  -SHORT.  REPEAT/SKIP ?'/
      DIMENSION NAME(14), MSTR(30),NOBLAN(180)
      DATA NAME/'HDR1<ИMЯ OБЬEKTA>',11(' ')/
      DATA MAXLIN/180/
      COMMON /LLL/ LBLO,LREC,NBLO,LEN
C----------------------
C     ЗAПPOC ИMEHИ OБЬEKTA. ИMЯ ЗAДAETCЯ
C     ЛЮБЫM ЧИCЛOM CИMBOЛOB < 15, ПOCЛE ЧEГO
C     ИДET ПPOБEЛ И CИMBOЛ "<", ECЛИ HYЖHA
C     ПEPEMOTKA ЛEHTЫ.
C
      KAKA=76000B.OR.0
      KAKA=KAKA-LOCF(KAP)+1
  1   CALL DIALOQ('HDR1 = ',7,KAP)
      MREV=0 $ DO 2 I=1,14
      LET=IGETS(KAP,I-1) $ IF(LET.LT.32) LET=32
      IF(LET.EQ.60) MREV=1
  2   CALL IPUTS(LET,NAME,I+3)
      IF(MREV.NE.0) J=MT9(LUN,7)
C-----------------------
C     ПOИCK OБЬEKTA HA ЛEHTE
  3   KEOF=0
  4   ASSIGN 4 TO MEOF
      ASSIGN 5 TO MOK
      ASSIGN 13 TO MSKIP
      LBLO=-1 $ NBLO=-1
C-----------------------
C     ЧTEHИE OДHOГO БЛOKA C ЛEHTЫ
C     NBLO - HOMEP БЛOKA
C     LBLO - EГO ПPEДПOЛAГAEMAЯ ДЛИHA
C     LEN  - ФAKTИЧECKAЯ ДЛИHA
C     BЫXOД ПO  MOK ,  ECЛИ HOPMAЛЬHO
C     BЫXOД ПO  MEOF,  ECЛИ ПPOЧИTAH EOF
C     BЫXOД ПO MSKIP,  ECЛИ БЫЛИ OШИБKИ
C
 100  DO 101 IREP=1,KREP
      IF(IREP.NE.1) J=MT9(LUN,4)
      J=MT9(LUN,1)
      IF(J.GT.0) GOTO 102
 101  CONTINUE
      MDIAG(3)='-ERROR'
      IREP=MEMORW(0B,10-1024)
 102  LEN=IABS(J)
      IF(LEN.LE.1024) GOTO 103
      KEOF=KEOF+1 $ IF(KEOF.GT.1) GOTO 9
      GOTO MEOF,( 4,39 )
 103  IF(J.LT.0) GOTO 105
      IF(LBLO.LT.0.OR.LBLO.EQ.LEN) GOTO MOK,( 5,11,32 )
 104  MDIAG(3)='-SHORT'
 105  CALL PUTG(MDIAG(2),NBLO,0,5,0,IPOZ)
      CALL DIALOQ(MDIAG,36,KAP)
      LET=KAP.SHIFT.40.OR.0
      IF(LET.EQ.83) GOTO MSKIP,( 3,13 )
      J=MT9(LUN,4) $ GOTO 100
C------------------------------
  5   IF(LEN.NE.14) GOTO 13
      KEOF=0
      CALL EBCISO(KAP(KAKA),NAME(4),3,0)
      DO 7 I=1,18
      LET=IGETS(NAME,I-1) $ IF(LET.EQ.32) GOTO 8
      IF(LET.NE.IGETS(NAME(4),I-1)) GOTO 3
  7   CONTINUE
  8   ASSIGN 11 TO MOK
      ASSIGN 3 TO MSKIP
      GOTO 100
 11   CALL EBCISO(KAP(KAKA),NAME(7),8,0)
      CALL DIALOG(NAME,72,-1)
C----------------------------
C     OПPEДEЛEHИE ДЛИHЫ CTPOKИ И БЛOKA
C     ПPOПYCK  E O F.
C
      LREC=0 $ LBLO=0 $ DO 20 I=5,9
      LET=IGETS(NAME(7),I)
      LBLO=10*LBLO+LET-48
      LET=IGETS(NAME(7),I+5)
  20  LREC=10*LREC+LET-48
      LBLOB=LBLO $ LBLO=LBLO/6
      IF(6*LBLO.NE.LBLOB) LBLO=LBLO+1
      J=MT9(LUN,5)
      DO 21 I=1,30
  21  MSTR(I)=' '
      DO 22 I=1,LREC
  22  NOBLAN(I)=0
C-----------------------------
C     ПOБЛOЧHOE ЧTEHИE И ПEЧATЬ
C
      NBLO=0
      NLINE=0
      LCNT=MAXLIN
      ASSIGN 39 TO MEOF
      ASSIGN 32 TO MOK
      ASSIGN 32 TO MSKIP
  30  NBLO=NBLO+1 $ GOTO 100
  32  NSTR= (6*LEN)/LREC $ NC=0
      CALL EBCISO(KAP(KAKA),KAP(KAKA),LEN,0)
      DO 33 I=1,NSTR
      DO 34 J=1,LREC
      LET=IGETSL(NC) $ NC=NC+1
      IF(LET.NE.32) NOBLAN(J)=NOBLAN(J)+1
  34  CALL IPUTS(LET,MSTR,J-1)
      LCNT=LCNT-1 $ IF(LCNT.LT.0) GOTO 33
      NLINE=NLINE+1 $ IF(NLINE.GT.72) NLINE=1
      PRINT 1000,(MSTR(J),J=1,21),NLINE
  33  CONTINUE
 1000 FORMAT( 1X, 20A6,A4,':',I2)
      GOTO 30
C---------------------------------
C     KOHEЦ OДHOГO OБЬEKTA
C
  39  PRINT 1002,(NAME(I),I=1,14)
      PRINT 1001,(NOBLAN(I),I=1,LREC)
 1001 FORMAT(99(20I6/))
 1002 FORMAT(4X,14A6)
      GOTO 1
 13   J=MT9(LUN,5) $ KEOF=1 $ GOTO 4
  9   CALL DIALOG('HET TAKOГO OБЬEKTA',18,-1)
      STOP
      END
      SUBROUTINE TEXCDC(K,S)
C*
C***********************************************
C*
C*        7.7.80.  M.Ю.ПOПOB   A.П.CAПOЖHИKOB
C*
C*    ПEPEПИCЬ TEKCTA ИЗ PEДAKTOPCKOГO ФAЙЛA HA
C*    9-ДOPOЖEЧHYЮ ЛEHTY B KOДE CDC-6500.
C*    ЗAMEHA ЗAДAHHЫX CИMBOЛOB.
C*
C*    *EDIT
C*    *R:<OTKYДA>
C*    *W:<KYДA>
C*    *U:TEXCDC
C*    < PEЖИMHЫE KAPTЫ >
C*    *EE
C*
C*    CYЩECTBYET 4 PAЗHOBИДHOCTИ PEЖИMHЫX KAPT:
C*    1.   =UNIT < ЦEЛOE:0,1,2,...,15 >
C*      ЗAДAHИE HOMEPA 9-ДOP.MЛ.
C*      ECЛИ HOMEP = 0, TO ЗAПИCЬ ИДET B
C*      PEДAKTOPCKИЙ ФAЙЛ ЗAПИCИ.
C*      ECЛИ HOMEP HE 0, TO MЛ C ЭTИM HOMEPOM
C*      ДOЛЖHA БЫTЬ ЗAKAЗAHA HA ПЛOTHOCTИ 800
C*      HAПP.  *TAPE:0/NO CHECK,F2,W,H
C*      ПPИ OTCYTCTBИИ KAPTЫ =UNIT  HOMEP=1.
C*    2.   =REWIND
C*      ЗAKAЗ ПEPEMOTKИ ЛEHTЫ B HAЧAЛO.
C*      CTAHДAPTHЫЙ PEЖИM.
C*    3.   =CONTINUE
C*      БЛOKИPOBKA ПEPEMOTKИ ЛEHTЫ, T.E.
C*      PEЖИM ДOЗAПИCИ.
C*    4.   =ЗAM  <CИMBOЛ> HA <CИMBOЛ>
C*      YKAЗAHИЯ O ЗAMEHAX. ECЛИ <CИMBOЛ>
C*      ECTЬ ПPOБEЛ, YПOTPEБЛЯЙTE CЛOBO BLANC.
C*         П P И M E P Ы :
C*    *U:TEXCDC
C*    =UNIT 4
C*    =ЗAM : HA BLANC
C*    =ЗAM * HA '
C*
C*    *U:TEXCDC
C*    =CONTINUE
C*
C*    *U:TEXCDC
C*    =UNIT 0           - БЭCM ПEPEПИCЬ
C*    =ЗAM A HA Б         C ПOДMEHOЙ.
C*    . . . . . . .  . . . . . . . . . . . .
C*    ЗAПИCЬ HA 9-ДOPOЖEЧHYЮ ЛEHTY ПPOИЗBO-
C*    ДИTCЯ PEKOPДAMИ ПO 256 CЛOB БЭCM-6.
C*    B KOHЦE ФAЙЛA ЗAПИCЫBAETCЯ  "EOF" .
C*    KAЖДЫЙ PEKOPД COДEPЖИT 25 KAPT. B KAPTE
C*    POBHO 80 CИMBOЛOB. ЗA ПOCЛEДHEЙ KAPTOЙ
C*    CTOИT KAPTA  *READ OLD    - ПPИЗHAK
C*    KOHЦA TEKCTOBOГO ФAЙЛA БЭCM-6. XBOCT
C*    ПOCЛEДHEГO PEKOPДA ДOПOЛHЯETCЯ ПPOБE-
C*    ЛAMИ B KOДE CDC-6500.
C*    BCTPETИBШИECЯ B TEKCTE PYCCKИE БYKBЫ
C*    ЗAMEHЯЮTCЯ HA ИX ЛATИHCKИЙ ЭKBИBAЛEHT.
C*
C*    HA ЭBM CDC-6500 BЫ ЗAKAЖETE ЭTY ЛEHTY
C*    KAK  S-TAPE,  ПPOЧTETE EE C ПOMOЩЬЮ
C*    OПEPATOPA  "BUFFER IN" ,  ЗHAЯ, ЧTO
C*    B KAЖДOM PEKOPДE COДEPЖИTCЯ 25 KAPT
C*    A KAЖДAЯ KAPTA PAЗMEЩAETCЯ B 8 CЛOBAX
C*    ПAMЯTИ ЭBM.
C*
C******************************************
C*
      DIMENSION K(14),KCDC(10,104)
      DIMENSION ITOG(10)
      COMMON/PARS/JOB,LENF(3),KODR(7)
      DIMENSION NS1(100),NS2(100)
      DATA(JCHAN=0)
      DATA(LUN=1)
      DATA(KOD=5555 5555 5555 5555B)
      DATA(MF=0),(NC=0),(KAP=0),(NREC=0)
      DIMENSION MERR(4),IPAR(4)
      DATA(MERR='OШИБKИ ЧETHOCTИ:',0)
      DATA(IPAR= '=ЗAM', '=UNIT', '=REWIN', '=CONTI' )
      DATA(MREW=0),(KERR=0)
      IF(MF.EQ.1) GOTO 1
      JOB='FRAGM'
      KODR=6H
      CALL PARSER(JOB,K,KCDC)
      DO 100 I=1,4
      IF(KCDC.EQ.IPAR(I)) GOTO (101,102,103,104) I
 100  CONTINUE
      GOTO 12
 104  MREW=1 $ GOTO 11
 103  MREW=0 $ GOTO 11
 102  JOB='SYNTAX'
      CALL PARSER(JOB,0,KCDC)
      K(5)='OШИБKA'
      IF(LENF(2).NE.2) GOTO 11
      IF(LENF(3).GT.15)GOTO 11
      LUN=LENF(3)
      K(5)=6H
      GOTO 11
 101  CONTINUE
      DO 10 I=1,3
      KODR=6H
  10  CALL PARSER(JOB,0,KCDC(1,I))
      K(5)='OШИБKA'
      IF(KCDC(1,2).NE.'HA') GOTO 11
      N1=KCDC(1,1)
      N2=KCDC(1,3)
      IF(N1.EQ.'BLANC') N1=6H
      IF(N2.EQ.'BLANC') N2=6H
      IF(JCOUNS(N1).GT.1) GOTO 11
      IF(JCOUNS(N2).GT.1) GOTO 11
      IF(N1.EQ.N2) GOTO 11
      JCHAN=JCHAN+1
      NS1(JCHAN)=N1
      NS2(JCHAN)=N2
      K(5)=6H
  11  CALL PRIM(K,K(5),1)
      RETURN
  12  CONTINUE
      MF=1
      IF(MREW.NE.0.OR.LUN.EQ.0) GOTO 1
       J = MT9(LUN,7)
  1   MEND=0
      IF(K(1).EQ.'*READ'.AND.K(2).EQ.'OLD') MEND=1
      KAP=KAP+1
      IF(NC.NE.0) GOTO 3
      DO 2 I=1,260
  2   KCDC(I)=KOD
  3   NC=NC+1
      IF(MEND.EQ.1.OR.JCHAN.EQ.0) GOTO 20
      DO 13 I=1,JCHAN
  13  CALL CHANGE(K,12,NS1(I),NS2(I))
  20  IF(LUN.NE.0) GOTO 21
      CALL S(K)
      RETURN
  21  CONTINUE
      CALL CODEI(K,KCDC(1,NC))
      IF(NC.NE.25.AND.MEND.NE.1) RETURN
      J=MT9A(LUN,2,KCDC)
      IF(J.LT.0) KERR=KERR+1
      NREC=NREC+1
      NC=0
      IF(MEND.NE.1) RETURN
      J = MT9(LUN,9)
      CALL ENCOD (1,ITOG)
      CALL ENCODT('HA ЛEHTY F',10)
      CALL ENCODI(LUN,2)
      CALL ENCODT(' ЗAПИCAHO ',10)
      CALL ENCODI(KAP,6)
      CALL ENCODT(' KAPT  ( ',9)
      CALL ENCODI(NREC,5)
      CALL ENCODT(' PEKOPДOB )',11)
      CALL PRIM(ITOG,ITOG(9),1)
      IF(KERR.EQ.0) RETURN
      CALL ENCOD(1,MERR(4))
      CALL ENCODI(KERR,4)
      CALL PRIM(MERR,MERR(4),1)
      RETURN
      END
      FUNCTION TPRIN(STR)
C*
C***     *CALL TPRIN:<ИMЯ> [,MONO ИЛИ YK.MЛ ]
C*
      INTEGER MPAG(30,72),MIND(2),STR(3)
      DIMENSION MEMP(2),MONO(14),NAME(14)
      DATA MAXLIN/72/, NAME/14(' ')/
      DATA MIND/12,90/
      DIMENSION K0(14,3)
      DATA KK0/3/
      DATA K0/'*LIBRA:23',12(' '),'*CALL KILNUMPG',11(' '),
     *        '*CALL TBPRIN:MONO',11(' ')
     *   /
C---------
      K0(3,3)=' '
      ENTRY TPRIM
      CALL NEWLIS
      CALL NOTLIS
      TPRIN=0 $ MONO=0
      CALL SCANER(STR(3),NAME,3,ITYP,KOD,IPOZ)
      IF(KOD.EQ.44) CALL SCANER(0,MONO,0,ITYP,KOD,IPOZ)
      IF(MONO.NE.0.AND.ITYP.EQ.2) MONO=IOCTAL(MONO).AND.777777B
      LD=1 $ IF(MONO.NE.0) LD=10
      ASSIGN 10 TO MPRET
      IF(ITYP.GT.2) GOTO 4
      CALL WBEGIN(MONO)
      DO 7777 I=1,KK0
 7777 CALL WRCARD(K0(1,I))
      GOTO 4
C---
      ENTRY TBPRIN
      MIND(1)=2 $ MIND(2)=15 $ ITYP=4
      TPRIN=0 $ MONO=STR(3).SHIFT.-8.OR.40B
      IF(MONO.NE.'MONO') MONO=0
      CALL NEWLIS $ CALL NOTLIS
      ASSIGN 200 TO MPRET $ GOTO 4
 200  J=MIND(LEFT) $ READ 1200,NAME
 1200 FORMAT(13A6,A2)
      ASSIGN 290 TO MPRET $ IF(NAME.EQ.'*END') GOTO 1
      DO 201 I=1,13
      IF(NAME(I).NE.' ') MEMP(LEFT)=1
 201  MPAG(J+I,NLIN)=NAME(I)
      NLIN=NLIN+1 $ IF(NLIN.LE.MAXLIN) GOTO 200
      NLIN=1 $ IF(MEMP(LEFT).EQ.0) GOTO 200
      LEFT=LEFT+1
      IF(LEFT.EQ.2.AND.MONO.EQ.0) GOTO 200
      ASSIGN 200 TO MPRET $ GOTO 1
 290  STOP
C----------
  1   DO 2 J=1,MAXLIN
      IF(MONO.EQ.0) PRINT 1002,(MPAG(I,J),I=3,13),(MPAG(I,J),I=16,26)
      IF(MONO.EQ.'MONO') PRINT 1001,(MPAG(I,J),I=3,23)
      IF(ITYP.LE.2) CALL WRCARD(MPAG(3,J))
  2   CONTINUE
 1001 FORMAT(1X,21A6)
 1002 FORMAT(10A6,A4,10A6,A4)
  4   DO 5 I=1,30 $ DO 5 J=1,72
  5   MPAG(I,J)=' '
      NLIN=1 $ NC=0 $ LEFT=1
      MEMP(1)=0 $ MEMP(2)=0
      GOTO MPRET,(10)
C----------
  6   DO 7 I=1,5 $ IF(I.NE.1) J=MT9(1,4)
      J = MT9(1,1) $ IF(J.GT.0) GOTO 8
  7   CONTINUE
      CALL QOUT(' ERROR',6)
  8   LEN=IABS(J)
      LABEL=' ' $ NAM1=' '
      DO 9 I=1,6
      LET=IGETSL(I-1) $ IF(I.LT.5) CALL IPUTS(LET,LABEL,I-1)
      LET=IGETSL(I+3) $ CALL IPUTS(LET,NAM1,I-1)
  9   CONTINUE
      GOTO MTRET,( 17)
C---------
 10   ASSIGN 17 TO MTRET $ GOTO 6
 17   IF(LEN.GT.1024) GOTO 10
      IF(LABEL.NE.'HDR1') GOTO 10
      IF(NAM1.NE.NAME) GOTO 10
      NS=512
      ASSIGN 20 TO MTRET $ GOTO 6
 20   IF(NS.LT.512) GOTO 22
      ASSIGN 21 TO MTRET $ GOTO 6
 21   IF(LEN.GT.1024) GOTO 100
      IF(LABEL.EQ.'EOF1') GOTO 100
      NS=0
 22   LET=IGETSL(NS) $ NS=NS+1
      IF(LET.GE.32) GOTO 40
      IF(LET.EQ.12) GOTO 14
      IF(LET.EQ.13) GOTO 15
      IF(LET.EQ.10) GOTO 12
      IF(LET.EQ.9) GOTO 11
      IF(LET.EQ.0) GOTO 20
C---    ЗAПAKOBKA B БИ ИЛИ MOHOЛИCT
 40   CALL IPUTS(LET,MPAG(1,NLIN),MIND(LEFT)+NC)
      IF(LET.NE.32) MEMP(LEFT)=1
      NC=NC+1 $ GOTO 20
 15   GOTO 20
 12   NLIN=NLIN+1 $ NC=0
      IF(NLIN.LE.MAXLIN) GOTO 20
      GOTO 114
 14   IF(NLIN.EQ.1.AND.NC.EQ.0) GOTO 20
 114  NC=0 $ NLIN=1 $ IF(MEMP(LEFT).EQ.0) GOTO 20
      LEFT=LEFT+LD $ IF(LEFT.EQ.2) GOTO 20
      ASSIGN 20 TO MPRET $ GOTO 1
 11   N8=NC.AND.7.OR.0 $ NC=NC+8-N8 $ GOTO 20
C---    KOHEЦ TEKCTA
 100  ASSIGN 101 TO MPRET $ GOTO 1
 101  J=MT9(1,6)
      J=MT9(1,6)
      J=MT9(1,6)
      IF(ITYP.GT.2) GOTO 9999
      NAME='*END' $ CALL WRCARD(NAME)
      NAME(1)='*READ' $ NAME(2)='OLD'
      CALL WRCARD(NAME) $ CALL WRIEND
      NZ=NZEDIT(0) $ PRINT 1222,NZ
 1222 FORMAT(' LAST ZON = ',O6)
 9999 CALL YESLIS
      RETURN
      END
      SUBROUTINE W1LOOK(NZ)
C*
C***   13.9.85.   A.П.CAПOЖHИKOB
C*
C*    ПOCЛOBHЫЙ ПPOCMOTP ЗOHЫ  NZ.
C*
      COMMON /PROTO/ IAP,NUN,NL,NF,INT,K(20)
      COMMON /UNIT/ LTYP,LMN,LVOL,LDIA(3),LREG,LINF
      COMMON /P/ LEX(1024),LIST(1024)
C---------------------------
      LCNT=0
      J=JFEX1(LTYP,LIST,NZ,'READ')
      IF(J.NE.0) CALL DIALOG(LDIA,18,-1)
   4  CALL DIALOQ('JOB : ',6,K)
 144  LEX=0B
      CALL SCANER(K,LEX,3,IT,KOD,IP)
      INT=0
      IF(IT.EQ.5) GOTO 40
      J= 1+JSEART('BREAK ADRESSWRITE',1,3,LEX)
      GOTO ( 2,4,40,50 ), J
   5  CALL DIALOG('ERROR',6,-1) $ GOTO 4
C---
C
C          ADRES=A1    ИЛИ  A1-A2  ИЛИ ПYCTO
  40  MA1=0   $ MA2=1023
      CALL SCANER(0,MA1,7,IT,KOD,IP)
      MA1=MA1.OR.0
      IF(IT.EQ.5) GOTO 42
      IF(IT.NE.1.AND.IT.NE.2) GOTO 5
      IF(KOD.NE.45) GOTO 42
      CALL SCANER(0,MA2,7,IT,KOD,IP)
      MA2=MA2.OR.0
      IF(IT.NE.1.AND.IT.NE.2) GOTO 5
      IF(MA2.LT.MA1) GOTO 5
  42  IF(NZ.LT.0.OR.MA2.GT.1023) GOTO 5
      NOZER=0
      N1=MA1+1 $ N2=MA2+1 $ DO 49 I=N1,N2
      IF(LIST(I).EQ.0B) GOTO 49
      NOZER=NOZER+1
      LCNT=LCNT-1 $ IF(LCNT.GT.0) GOTO 41
      LCNT=23
      CALL PUTH(LEX,' ZON ADR',0,12,0,IP)
      CALL PUTH(0,'      OCTAL   ',0,18,0,IP)
      CALL PUTH(0,'    GOST',0,10,0,IP)
      CALL PUTH(0,'    ISO',0,10,0,IP)
      CALL PUTH(0,'    8-БAЙT',0,12,0,IP)
      CALL DIALOG(LEX,IP,-1)
  41  CALL PUTO(LEX,NZ,0,4,0,IP)
      CALL PUTH(0,'/',0,1,0,IP)
      CALL PUTO(0,I-1,0,4,0,IP)
      CALL PUTH(0,' : ',0,3,0,IP)
      CALL PUTO(0,LIST(I),0,16,4,IP)
      DO 45 MODE=1,2
      CALL PUTH(0,' ',0,3,0,IP)
      DO 45 J=1,6
      LET=IGETS(LIST(I),J-1)
      IF(MODE.EQ.2) GOTO 46
      IF(LET.GE.96) LET=133B
      LET=ISO(LET)
  46  IF(LET.LT.32.OR.LET.GE.127) LET=77B
      LET=LET.SHIFT.-40
  45  CALL PUTH(0,LET,0,1,0,IP)
      CALL PUTH(0,' ',0,2,0,IP)
      DO 47 J=1,6
      CALL PUTH(0,' ',0,1,0,IP)
      LET=IGETS(LIST(I),J-1)
  47  CALL PUTO(0,LET,0,3,0,IP)
  48  CALL DIALOG(LEX,IP,-1)
      IF(INT.NE.0) GOTO 144
  49  CONTINUE
      IF(NOZER.EQ.0) CALL DIALOG('  Z E R O ',10,-1)
      GOTO 4
C
C          WRITE=<AДPEC> [ /<HOM.БAЙTA> ] ,<KOД>
  50  IF(NZ.LT.0) GOTO 5
      CALL SCANER(0,LEX,4,IT,KOD,IP)
      IF(IT.NE.1.AND.IT.NE.2) GOTO 5
      MAW=LEX.OR.0  $ NB=0
      IF(MAW.LT.0.OR.MAW.GT.1023) GOTO 5
      IF(KOD.NE.47) GOTO 51
      CALL SCANER(0,LEX,7,IT,KOD,IP)
      IF(IT.NE.1.AND.IT.NE.2) GOTO 5
      NB=LEX.OR.0
      IF(NB.LT.1.OR.NB.GT.6) GOTO 5
  51  CALL SCANER(0,LEX,7,IT,KOD,IP)
      IF(IT.NE.1.AND.IT.NE.2) GOTO 5
      IF(NB.EQ.0) LIST(MAW+1)=LEX
      IF(NB.EQ.0) GOTO 52
      LET=LEX.OR.0
      IF(LET.GT.255) GOTO 5
      CALL IPUTS(LET,LIST(MAW+1),NB-1)
  52  J=JFEX1(LTYP,LIST,NZ,'WRITE')
      IF(J.NE.0) CALL DIALOG(LDIA,18,-1)
      MA1=MAW $ MA2=MAW
      GOTO 42
C
  2   RETURN
      END
      SUBROUTINE WHATIS
          COMMON/FL/IFLPL
          COMMON/NZ1/NZ1
      COMMON/NAME/NAME(2),NFL
      EQUIVALENCE (IFLPL,NZ2)
      DATA(NAME=6H       ,6H       )
      COMMON /CLNEWS/ MTTEK,NZC,LW,LINE(84),LASTZI
     *       ,IFLOLD,LT1C
      DIMENSION IPICT(12)
      DATA (IPICT=1H*,1HR,1HE,1HA,1HD,1H ,1HO,1HL,1HD,3(1H ))
      LT1C=0B
C*
C**********************************************************
C*
C*      ПPOГPAMMA ДЛЯ ПPOCMOTPA MAГHИTHOЙ ЛEHTЫ
C*      ИЛИ ФAЙЛA HA ДИCKE.   OБPAЩEHИE :
C*
C*      *CALL WHATIS
C*      NNZZZZKKKK
C*      ЗДECЬ NN - MAT.HOMEP ЛEHTЫ (ФAЙЛA)
C*          ZZZZ - HAЧAЛЬHAЯ ЗOHA (BOCЬMEP.ЧИCЛO=0,1,2,... )
C*          KKKK - KOHEЧHAЯ  ЗOHA (  ---"---  )
C*
C*      ПPИMEP : *CALL WHATIS
C*               6700000177     - MЛ 67 C 0 ПO 177 ЗOHЫ
C*
C***********************************************************
C*
      READ  110,  MTTEK, NZC, LASTZI
      PRINT 101,  MTTEK, NZC, LASTZI
      LASTZI=I10T8(LASTZI)+1
      NZC=I10T8(NZC)-1
      MAINFL=NZ1
    1 IF(NEWSTR(1023).NE.1) GO TO 3
      NZCOLD=NZC
          GO TO 21
    2 IF(NZC+1.NE.LASTZI) GO TO 1
      RETURN
    3 PRINT 201,NZC,(LINE(II),II=1,80)
      NZCOLD=NZC
    4 IF(NEWSTR(LW).EQ.1) GO TO 6
      IF(MAINFL.EQ.0) GO TO 7
      CALLHEADLT(LINE(1))
      IF(NFL.EQ.1)PRINT 601,NZC,NAME,(LINE(II),II=1,80)
    7 CONTINUE
      NZCOLD=NZC
      DO 5 J=1,12
      IF(LINE(J).NE.IPICT(J)) GO TO 4
    5 CONTINUE
      PRINT 301,NZC
      GO TO 2
    6 PRINT 401,NZC
      IF(NZC.EQ.LASTZI) RETURN
      IF(NZC.NE.NZCOLD) IFLOLD=1
  21  NZCOLD=NZC
      CALL READCG
      IF(NZC.NE.NZCOLD)IFLOLD=1
          IF(IFLPL.EQ.1) PRINT 501,NZ1
      IF(IFLPL.EQ.2)PRINT 100,NZ1
      IF(IFLPL.EQ.3)PRINT 99,NZ1
          IF(NZ2.EQ.1)IFOLD=0B
          IFLPL=0
      GO TO 2
   99 FORMAT('+  COMMON:  B ',O4,'-1')
  100 FORMAT('+  OVERLAY: B ',O4)
  101 FORMAT(' HA ЛEHTE ',A3,2X,' B ЗOHAX',X,O4,'-',O4,' OБHAPYЖEHO:
     * '/)
  110 FORMAT(A2,2O4)
  201 FORMAT('   TEKCT   OT 'O4'  1-AЯ KAPTA: '80A1,1H.)
  301 FORMAT('           ДO 'O4)
  401 FORMAT('   ИCПOPЧEH B 'O4/)
  501 FORMAT(1H+'  PERSO:   B 'O4)
  601 FORMAT(10X,O4,2X,2A6,2X,2H: ,80A1,1H.)
      END
      SUBROUTINE WRAUTR
C*
C****     01.03.82    A.П.CAПOЖHИKOB
C*
C*      ИCПOЛHИTEЛЬHAЯ ЧACTЬ ПPOГPAMMЫ WRAUTOR
C*      OБЩEHИE C ПOЛЬЗOBATEЛEM - ЧEPEЗ П/П
C*      DIALOG.  B XOДE ДИAЛOГA ЗAKAЗЫBAETCЯ
C*      ЛEHTA (ФAЙЛ), OПPEДEЛЯЮTCЯ HAЧAЛЬHЫЙ
C*      И KOHEЧHЫЙ HOMEPA ЗOH.
C*
      COMMON / PROTO / AP,NUN,NL,NF,INT,KAP(20),
     1                 LEX(20),ITAP(20)
      COMMON / PASS / MP(1024),MF(2048),MR(1024)
      DIMENSION MZ(4),NZ(2),NTD(2)
      DATA ( MZ= 'HAЧ.ЗOHA:', 'KOH.ЗOHA:' )
      DATA ( NTD = '  MД    MЛ  ' )
      INTEGER GSTISO
C----
      IF(LEX(1).EQ.2) CALL DIALOP(2)
      LIST = LEX(2)
  1   ITAP(2) = 0
      CALL DIALOQ( 'ЛEHTA/ФAЙЛ:', 11, KAP )
      IFLER = JFOCC ( KAP, ITAP )
      IF ( IFLER.EQ.0 ) GOTO 2
      CALL DIALOG(ITAP(4),18,-1)
      IF(NUN.NE.4) GOTO 1
  2   LENTA = ITAP(8)
      IF(LENTA.NE.0) LENTA=1
      MAW = 70251B
      IF(LENTA.NE.0) MAW = 70254B
      DO 3 I=1,2
  4   CALL DIALOQ( MZ(2*I-1), 9, KAP )
      CALL SCANER( KAP, LEX, 0, LTYP, KODR, IPOZ )
      IF(LTYP.EQ.1) GOTO 3
      IF(LTYP.EQ.2) GOTO 33
      CALL DIALOG('OШИБKA',6,-1)
      IF(NUN.NE.4) GOTO 4
      IFLER=I
  33  LEX = IOCTAL ( LEX )
  3   NZ(I) = LOR(0,LEX)
      IF(IFLER.NE.0) RETURN
      N1 = NZ(1)
      N2 = NZ(2)
      ITAP(3) = N2+1
C---
      I = N1 - 1
      N2 = N2 - N1 +1
      IF ( N2.LE.0 ) N2 = 4096 + N2
      DO 5 II = 1, N2
      I = I + 1
      ITAP(8) = LOR(LIST,LAND(I,7777B))
      JEX = JFEXCH(ITAP)
      IWORD = JEXTRA(0,50B,MAW)
      CALL PUTH(LEX,'ЗOHA=',0,5,0,IPOZ)
      CALL PUTO(0,I,0,4,0,IPOZ)
      J = 1
      IF(JEX.EQ.19) GOTO 6
      J = 20
      IF(IWORD.EQ.0B) GOTO 7
      IF(IWORD.EQ.7163 4760 3471 6347B) GOTO 7
      J = 11
  6   IF(J.EQ.1) CALL PUTH(0,'  HE ЧИTAETCЯ',0,13,0,IPOZ)
  7   IF(J.NE.1) CALL PUTH(0,'  ЗAПИCAHA ДO 1/1/82',0,J,0,IPOZ)
      IF(J.NE.11) GOTO 8
      J1 = LOR(0,LAND(37777B,LSHIFT(IWORD,11)))
      CALL ITOD ( J1, KAP )
      CALL PUTH(0,KAP,0,9,0,IPOZ)
      J3 = LOR(0,LAND(IWORD,3777B))
      J1 = J3/60
      J2 = J3-60*J1
      TIME = 1.*J1 + 0.01*J2
      CALL PUTG(0,TIME,1,5,2,IPOZ)
      CALL PUTH(0,NTD(LENTA+1),0,4,0,IPOZ)
      J1 = LSHIFT(IWORD,36)
      CALL PUTO(0,J1,1,2,0,IPOZ)
      J1 = 48 - LOR(0,LSHIFT(IWORD,42))
      CALL PUTH(0,'  Ш',0,3,0,IPOZ)
      CALL PUTO(0,J1,1,2,0,IPOZ)
      J = LOR(0,LAND(1777B,LSHIFT(IWORD,26)))
      IF (J.EQ.0) GOTO 8
      CALL PUTH(0,':',0,1,0,IPOZ)
      J1 = -1
      J2 = 40
      DO 20 JJ=1,12
      IS = LAND(377B,LSHIFT(MF(2*J+J1),J2))
      J2 = J2-8
      IF(J2.LT.0) J1=0
      IF(J2.LT.0) J2=40
  20  CALL PUTH(0,GSTISO(IS),0,1,0,IPOZ)
   8  KAP=0
      CALL DIALOG(LEX,IPOZ,-1)
      IF(KAP.NE.0) GOTO 100
  5   CONTINUE
 100  CALL DIALOP(0)
      RETURN
      END
       SUBROUTINE ЛИЗA
C*
C**********  ПPOГPAMMA, ИMИTИPYЮЩAЯ
C*           ИCKYCCTBEHHЫЙ ИHTEЛЛEKT.
C*
C*           OБPAЩEHИE :
C*           *MAIN ЛИЗA
C*           *EXECUTE
C*           *END FILE
C*
       COMMON/PROTO/AP,NUN,NL,NF,INT,K(30)
       DATA NL/15/, LICHT/ 1001 7440 1002 0040 B /
       DIMENSION IT(20)
      DIMENSION M1(9),M2(9),M3(9),M4(9),M5(9),M6(9),
     *          M7(9),L1(9),L2(9),L3(9),
     *          L4(9),L5(9),L6(9),L7(9),L8(9),L9(9)
      DATA M1/'    B H И M A H И E    O П E P A T O P Ы  !          '/
      DATA M2/'C BAMИ БYДET ГOBOPИTЬ ПOЛЬЗOBATEЛЬ  ИBAHOB           '/
      DATA M3/'OH YБEЖДEH, ЧTO PAЗГOBAPИBAET C MAШИHOЙ.             '/
      DATA M4/'ПOЖAЛYЙCTA, HE PACCEИBAЙTE EГO ЗAБЛYЖДEHИЯ !         '/
      DATA M5/'OTBEЧAЙTE EMY :   Q=    <BAШ OTBET> <LINE FEED>      '/
      DATA M6/'HAПPИMEP:   Q=    ДA, CEГOДHЯ OTЛИЧHAЯ ПOГOДA        '/
      DATA M7/'ECЛИ PAЗГOBOP BAM HAДOECT, OTBETЬTE CЛOBOM  KOHEЦ.   '/
      DATA L1/'ПEPEД BAMИ - ПPOГPAMMA "ЛИЗA", ПPEДHAЗHAЧEHHAЯ ДЛЯ   '/
      DATA L2/'MOДEЛИPOBAHИЯ ПPOЦECCA ЧEЛOBEЧECKOГO MЫШЛEHИЯ.       '/
      DATA L3/'ПPOГPAMMA ПPEДCTABЛЯET COБOЙ BAPИAHT CИCTEMЫ  ELIZA  '/
      DATA L4/'AДAПTИPOBAHHЫЙ COTPYДHИKAMИ ЛBTA OИЯИ ДЛЯ ЭBM БЭCM-6.'/
      DATA L5/'ПOCЛE ПOЯBЛEHИЯ HA ЭKPAHE CИMBOЛA "?" HAБИPAЙTE      '/
      DATA L6/'CTPOKY.  ПPИЗHAK KOHЦA CTPOKИ - CИMBOЛ "LINE FEED".  '/
      DATA L7/'ПPEДOCTEPEЖEHИE : ПPOГPAMMA CAMOOБYЧAЮЩAЯCЯ, ПOЭTOMY '/
      DATA L8/'OЧEHЬ ПPOCИM BAC ИЗБEГATЬ HEПPИЛИЧHЫX BЫPAЖEHИЙ.     '/
      DATA L9/'ЧTOБЫ ЗAKOHЧИTЬ CEAHC - HAБEPИTE CЛOBO   KOHEЦ.      '/
C
C--------
C
       J=JEXTRA(0,63B,JEXTRA(0,63B,502B))
       ITERM=LOR(0,LSHIFT(J,42))
       ITERM=LOR( 0003 6440 1002 0040 B, LSHIFT(112-ITERM,-40))
       M5(4)=ITERM
       M6(3)=ITERM
       CALL DIALOQ('KTO BЫ : ',9,K)
       DO 1 I=1,3
  1    M2(I+6)=K(I)
       NUNC = NUN
       NUN = 1
C--------
       CALL DIALOG(M1,54,-1)
       CALL DIALOG(M2,54,-1)
       CALL DIALOG(M3,54,-1)
       CALL DIALOG(M4,54,-1)
       CALL DIALOG(M5,54,-1)
       CALL DIALOG(M6,54,-1)
       CALL DIALOG(M7,54,-1)
C--------
       NUN = NUNC
       NF=NL
       CALL DIALOG(LICHT,2,-1)
       CALL DIALOP(1)
       CALL DIALOG(L1,54,-1)
       CALL DIALOG(L2,54,-1)
       CALL DIALOG(L3,54,-1)
       CALL DIALOG(L4,54,-1)
       CALL DIALOG(L5,54,-1)
       CALL DIALOG(L6,54,-1)
       CALL DIALOG(L7,54,-1)
       CALL DIALOG(L8,54,-1)
       CALL DIALOG(L9,54,-1)
       CALL DIALOG('------------------------------------------',42,K)
C--------
  10   NUN = 1
       NF=NL
       DO 5 I=1,20
   5   IT(I+1)=K(I)
       IT=ITERM
       CALL DIALOP(0)
       CALL DIALOG(IT,80,K)
       NUN = NUNC
       CALL DIALOP(1)
       IF(LSHIFT(LEXOR(K,'KOHEЦ'),8).EQ.0B) GOTO 20
       CALL DIALOG(K,80,K)
       IF(LSHIFT(LEXOR(K,'KOHEЦ'),8).NE.0B) GOTO 10
       CALL DIALOG('ЖAЛЬ, ЧTO HAШA БECEДA БЫЛA CTOЛЬ KPATKOBPE-',44,-1)
       CALL DIALOG('MEHHOЙ. OБЩEHИE C BAMИ ДOCTABИЛO MHE MHOГO ',44,-1)
       CALL DIALOG('ПOЛEЗHЫX CBEДEHИЙ O CПEЦИФИЧECKИX CBOЙCTBAX',44,-1)
       CALL DIALOG('ЧEЛOBEЧECKOГO MЫШЛEHИЯ.',24,-1)
       GOTO 13
C--------
  20   CALL DIALOG('ПPOШY ПPOЩEHИЯ, HO HEOTЛOЖHЫE ДEЛA',34,-1)
       CALL DIALOG('BЫHYЖДAЮT MEHЯ ПPEPBATЬ HAШY БECEДY.',36,-1)
  13   CALL DIALOG('ДO CBИДAHИЯ.',12,-1)
       CALL DIALOP(0)
       STOP
       END
